# Epic 9: Financial Intelligence - Brownfield Enhancement

## Epic Goal

Transform raw cost data into actionable insights by implementing professional financial reports, cross-project analytics, and vendor performance tracking, enabling developers to make data-driven decisions and provide investor-grade reporting to partners.

## Epic Description

### Existing System Context

- **Current functionality:** Cost tracking by category, vendor linkage, basic dashboard visualizations (Epic 4)
- **Database:** Neon PostgreSQL with comprehensive cost, vendor, and project data
- **Technology stack:** Next.js 14 + TypeScript + tRPC + React Query
- **Existing visualizations:** Cost breakdowns by category, timeline trends (from Epic 4)
- **UI:** Shadcn/ui components with Recharts for data visualization

### Enhancement Details

**What's being added/changed:**

- Exportable financial reports (PDF/Excel) with professional formatting
- Multi-project comparative analytics for developers with multiple sites
- Vendor performance metrics (cost accuracy, frequency, project count)
- Advanced filtering and date range comparisons

**How it integrates:**

- **Reports:** Server-side PDF generation using React-PDF or Puppeteer
- **Analytics:** Aggregate queries across user's projects with Recharts visualization
- **Vendor metrics:** Calculated fields and ratings stored with vendor records

**Success criteria:**

- Users can generate PDF reports suitable for investors/lenders
- Multi-project owners can compare costs across developments
- Users can evaluate vendor performance for rehiring decisions
- Reports load within 5 seconds for projects with 1000+ costs
- All analytics respect role-based access (partners see only their projects)

## Stories

### Story 9.1: Professional Financial Report Generation

**Objective:** Create investor-grade PDF and Excel reports for projects

**Tasks:**

- Implement PDF report generation for projects using React-PDF or Puppeteer:
  - **Cover Page:** Project name, report date, generated by
  - **Executive Summary:** Total cost, timeline (start/end dates), status, key metrics
  - **Cost Breakdown by Category:** Table with amounts and percentages + pie chart
  - **Vendor Summary:** Top 10 vendors by spend with bar chart
  - **Timeline Visualization:** Gantt-style chart or milestone timeline
  - **Document Inventory:** List of documents by category with upload dates
  - **Footer:** Page numbers, generated date, confidentiality notice
- Add Excel export option with multiple sheets:
  - **Sheet 1 (Summary):** Project overview with totals by category and chart
  - **Sheet 2 (Detailed Costs):** All cost entries with filters enabled
  - **Sheet 3 (Vendors):** Vendor summary with totals and contact info
  - **Sheet 4 (Timeline):** Timeline events chronologically
  - **Sheet 5 (Documents):** Document list with metadata
- Professional styling suitable for investor/lender presentations:
  - Company branding (logo, colors from design tokens)
  - Clean typography and consistent spacing
  - Professional charts with legends
  - Currency formatting throughout
- Add report generation UI in project view:
  - "Generate Report" button in project header dropdown
  - Modal with report options (format, date range, sections to include)
  - Loading indicator during generation (progress bar)
  - Download link when ready
- Include date range filters for reporting periods:
  - Custom date range picker
  - Preset options (Last 30 days, Last Quarter, YTD, All Time)
  - Filters apply to costs and timeline events
- Implement server-side generation to handle large datasets:
  - Use Next.js API route with longer timeout (60s)
  - Streaming response for large PDFs
  - Temporary file storage with cleanup (auto-delete after 24 hours)
- Respect partner permissions:
  - Partners see only what they can view (filtered data)
  - Watermark reports for partners vs. owners

**Acceptance Criteria:**

- [ ] "Generate Report" button visible in project dropdown menu
- [ ] Report options modal shows format (PDF/Excel) and date range
- [ ] PDF report includes all sections with professional styling
- [ ] PDF includes company logo and branding
- [ ] Charts render correctly in PDF (pie chart, bar chart, timeline)
- [ ] Excel export has all 5 sheets with proper formatting
- [ ] Excel sheets have freeze panes and filters enabled
- [ ] Excel charts embedded in Summary sheet
- [ ] Date range filters work correctly
- [ ] Loading indicator shows progress during generation
- [ ] Reports generate within 5 seconds for 1000+ costs
- [ ] Download link provided when generation completes
- [ ] Reports auto-delete after 24 hours (cleanup job)
- [ ] Partner reports show filtered data only
- [ ] Partner reports watermarked "Partner View"
- [ ] Reports tested with various data volumes
- [ ] PDF tested for print quality (8.5x11 page size)
- [ ] Excel tested in Excel, Google Sheets, and Numbers

### Story 9.2: Multi-Project Comparative Analytics

**Objective:** Enable portfolio-level insights for developers with multiple projects

**Tasks:**

- Create portfolio analytics dashboard accessible from main navigation:
  - "Portfolio Analytics" menu item (visible only if user has 2+ projects)
  - Dashboard header with project selector (multi-select)
- Compare costs across projects:
  - **Cost per Square Foot:** If project size tracked (add optional field to projects)
  - **Category Spend Comparison:** Side-by-side grouped bar chart (categories on X, projects as bars)
  - **Timeline Duration Comparison:** Bar chart showing project durations
  - **Budget Variance Across Projects:** Actual vs. budgeted (if budget field added)
  - **Cost Trends Over Time:** Line chart comparing spending velocity
- Aggregate portfolio views:
  - **Total Portfolio Value:** Sum of all project costs with count
  - **Most Common Cost Categories:** Pie chart aggregating all projects
  - **Most Used Vendors Across Portfolio:** Table with vendor frequency and total spend
  - **Average Project Metrics:** Mean cost, duration, vendor count
- Filter and drill-down capabilities:
  - Filter by project status (Active, Completed, On Hold)
  - Filter by date range (project start date)
  - Filter by project type (if type field added: Residential, Commercial, Mixed-Use)
  - Click chart segments to drill into project details
- Visualization using Recharts:
  - Responsive charts that work on mobile
  - Tooltips showing detailed data on hover
  - Legend with project color coding
  - Export chart as image (PNG)
- Data tables with sorting and export:
  - Sortable columns for all metrics
  - Export portfolio comparison to CSV/Excel
- Only show projects user has access to (RBAC enforcement):
  - Aggregate only projects where user is owner or partner
  - Partners with limited access excluded from comparisons
- Add caching for expensive portfolio queries (5-minute cache)

**Acceptance Criteria:**

- [ ] Portfolio Analytics menu item visible for users with 2+ projects
- [ ] Dashboard loads within 2 seconds for 20 projects
- [ ] Project selector allows multi-select with "Select All" option
- [ ] Cost per square foot chart visible (if projects have size field)
- [ ] Category spend comparison chart shows side-by-side bars
- [ ] Timeline duration comparison shows project lengths
- [ ] Cost trends line chart shows spending over time
- [ ] Total portfolio value card displays sum and project count
- [ ] Most common categories pie chart aggregates all projects
- [ ] Most used vendors table shows frequency and totals
- [ ] All filters work correctly (status, date range, type)
- [ ] Chart tooltips show detailed data
- [ ] Charts are responsive on mobile devices
- [ ] Click chart segments to navigate to project details
- [ ] Export portfolio data to CSV/Excel
- [ ] Export chart as PNG image
- [ ] RBAC enforced (users only see their projects)
- [ ] Portfolio queries cached for performance (5 min TTL)
- [ ] Empty state shown if user has <2 projects
- [ ] Loading states shown during data fetch

### Story 9.3: Vendor Performance Metrics & Rating System

**Objective:** Track vendor performance to inform rehiring decisions

**Tasks:**

- Add performance metrics to vendor records (calculated fields):
  - **Total Projects:** Count of projects vendor has worked on
  - **Total Spent:** Sum of all costs associated with vendor
  - **Average Cost:** Mean cost per vendor engagement
  - **Frequency:** Projects per year (based on cost dates)
  - **Last Used:** Most recent cost date
  - **Category Specialization:** Top 3 cost categories for vendor
- Implement vendor rating system:
  - Create `vendor_ratings` table:
    - id (uuid)
    - user_id (foreign key to users)
    - vendor_id (foreign key to vendors)
    - project_id (foreign key to projects)
    - rating (integer, 1-5 stars)
    - review (text, optional, max 500 characters)
    - created_at (timestamp)
    - updated_at (timestamp)
  - User can rate vendors per project (one rating per user per vendor per project)
  - Optional review comments (500 char limit)
  - Average rating calculated and displayed on vendor profile
  - Rating count shown (e.g., "4.5â˜… (12 ratings)")
- Vendor comparison view:
  - Compare vendors within same category or specialty
  - Side-by-side comparison table (up to 5 vendors)
  - Metrics: Rating, Total Spent, Project Count, Frequency, Last Used
  - Filter by rating threshold (e.g., 4+ stars only)
  - Sort by any metric
- Vendor performance dashboard:
  - **Top-Rated Vendors:** List of vendors with 4+ stars
  - **Most-Used Vendors:** Ranked by project count
  - **Underutilized Vendors:** High-rated (4+) but low frequency (<1/year)
  - **Recent Vendors:** Last 10 vendors used with ratings
  - **Vendor Spend Distribution:** Chart showing spend by vendor
- Export vendor report:
  - Generate Excel report with vendor rankings
  - Include all metrics and ratings
  - Filter by category, rating, project count
- Add vendor rating UI:
  - Rating form on vendor detail page (per project)
  - Star rating component (interactive)
  - Optional review textarea
  - Display existing ratings from other users (if multi-user project)
  - Edit own ratings

**Acceptance Criteria:**

- [ ] Vendor ratings table created with proper schema
- [ ] Vendor metrics calculated correctly (projects, spend, frequency)
- [ ] Vendor profile shows all performance metrics
- [ ] Star rating component works (1-5 stars, half-stars not allowed)
- [ ] Users can rate vendors once per project
- [ ] Review textarea has 500 character limit with counter
- [ ] Average rating displayed prominently on vendor profile
- [ ] Rating count shown next to average rating
- [ ] Users can edit their own ratings
- [ ] Vendor comparison view compares up to 5 vendors
- [ ] Comparison table shows all metrics side-by-side
- [ ] Filters work correctly (category, rating threshold)
- [ ] Vendor performance dashboard shows all sections
- [ ] Top-rated vendors list filtered to 4+ stars
- [ ] Underutilized vendors correctly identified (high rating, low frequency)
- [ ] Vendor spend distribution chart renders correctly
- [ ] Export vendor report generates Excel with all data
- [ ] RBAC enforced (users only rate/view vendors from their projects)
- [ ] Empty state shown if vendor has no ratings
- [ ] Performance tested with 100+ vendors

## Compatibility Requirements

- [x] Existing cost tracking and vendor management remain unchanged
- [x] Database schema: Add vendor rating tables and optional project fields (size, type, budget)
- [x] Add calculated fields for vendor metrics (or compute on-demand with caching)
- [x] UI changes follow Shadcn/ui patterns (Reports in dropdown, analytics in new dashboard section)
- [x] Performance: Report generation may take 3-5 seconds (show loading state with progress)
- [x] RBAC: All analytics respect existing permission model

## Risk Mitigation

**Primary Risk:** Report generation could timeout with very large projects (5000+ costs)

**Mitigation:** Implement pagination for detailed reports, add data limits with warnings (e.g., "Report limited to 5000 most recent costs"), server-side generation with progress indicators, option to email reports when ready

**Rollback Plan:** Reports are read-only exports (no data modification risk); analytics dashboard can be feature-flagged; vendor ratings are additive (can be hidden via UI toggle)

## Definition of Done

- [ ] All stories completed with acceptance criteria met
- [ ] Existing cost and vendor workflows verified (unchanged)
- [ ] Report generation tested with large projects (1000+ costs, <5s generation)
- [ ] PDF reports validated for professional appearance
- [ ] Excel exports validated for compatibility (Excel, Google Sheets, Numbers)
- [ ] Multi-project analytics tested with 10+ projects
- [ ] Portfolio dashboard performance optimized (caching implemented)
- [ ] Vendor ratings tested with multiple users and projects
- [ ] Vendor comparison tested with edge cases (no ratings, single project)
- [ ] Performance tested: analytics queries optimized with indexes
- [ ] RBAC tested: partners cannot see other partners' data
- [ ] Cross-browser tested (Chrome, Safari, Firefox, Edge)
- [ ] Mobile tested for analytics dashboards
- [ ] Documentation: Report generation guide, analytics interpretation guide, vendor rating guidelines
- [ ] No regression in existing features

## Story Manager Handoff

**Story Manager Handoff:**

"Please develop detailed user stories for this brownfield epic. Key considerations:

- This is an enhancement to an existing system running Next.js 14 + TypeScript + tRPC + Recharts
- Integration points: Existing cost/vendor/project data, Epic 4 visualizations, React-PDF or Puppeteer for reports
- Existing patterns to follow: Shadcn/ui components, Recharts for charts, tRPC queries with caching
- Critical compatibility requirements: Reports are read-only, analytics respect RBAC, vendor ratings are per-project
- Each story must include verification that existing functionality remains intact
- Performance is critical: reports <5s, portfolio dashboards <2s, use caching for expensive queries

The epic should transform data into insights while maintaining system integrity and professional quality suitable for investor presentations."
