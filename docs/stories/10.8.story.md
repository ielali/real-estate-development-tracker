# Story 10.8: Collapsible Header on Scroll - Brownfield Addition

## Status

**Current Status:** Approved

## User Story

As a **mobile user**,
I want **the header to hide when scrolling**,
So that **I have maximum screen space for content**.

## Story Context

**Existing System Integration:**

- Integrates with: Current mobile header/app bar from Epic 5
- Technology: Next.js 14, React, Intersection Observer API or scroll event handling
- Follows pattern: Existing header component structure and mobile responsive design
- Touch points: Mobile layout wrapper, scroll detection, pull-to-refresh if implemented

## Acceptance Criteria

**Functional Requirements:**

1. Header slides up (hides) on scroll down after 50px threshold
2. Header slides down (shows) on scroll up immediately
3. Header always visible at top of page

**Integration Requirements:** 4. Works with existing pull-to-refresh functionality (if present) 5. iOS safe area insets respected for notch/dynamic island 6. Maintains all header functionality (search, menu, etc.)

**Quality Requirements:** 7. Smooth animation (200ms ease-in-out) 8. No janky movements or layout shifts 9. 60fps performance during scroll

## Tasks / Subtasks

### Phase 1: Preparation & Analysis

- [ ] Task 1: Analyze current header implementation (AC: 6)
  - [ ] Review existing header component from Epic 5
  - [ ] Document header functionality (search, menu, profile)
  - [ ] Identify fixed positioning and z-index usage
  - [ ] Check for existing pull-to-refresh implementation
  - [ ] Map iOS safe area inset handling
  - [ ] Create list of components to be modified

### Phase 2: Scroll Detection Implementation

- [ ] Task 2: Create scroll direction detection hook (AC: 1,2,3)
  - [ ] Create `useScrollDirection.ts` custom hook
  - [ ] Implement scroll event listener with passive flag
  - [ ] Track last scroll position
  - [ ] Calculate scroll direction (up/down)
  - [ ] Implement 50px threshold for hiding
  - [ ] Ensure header shows immediately on scroll up
  - [ ] Keep header visible when at top (scrollY === 0)
  - [ ] Test scroll detection accuracy

### Phase 3: Animation Implementation

- [ ] Task 3: Implement header hide/show animation (AC: 7,8)
  - [ ] Add transform translate CSS for header movement
  - [ ] Configure 200ms ease-in-out transition
  - [ ] Implement will-change optimization for performance
  - [ ] Test for layout shift issues
  - [ ] Ensure smooth animation during rapid scrolling
  - [ ] Add requestAnimationFrame for smooth updates
  - [ ] Verify no content jump when header hides

### Phase 4: Header Component Integration

- [ ] Task 4: Update header component with scroll behavior (AC: 1,2,3,6)
  - [ ] Integrate useScrollDirection hook into header
  - [ ] Apply transform based on scroll direction
  - [ ] Maintain fixed positioning
  - [ ] Ensure all header functions remain accessible
  - [ ] Test search functionality during scroll
  - [ ] Test menu interactions during scroll
  - [ ] Verify user profile section works correctly

### Phase 5: iOS Safe Area Handling

- [ ] Task 5: Implement iOS safe area support (AC: 5)
  - [ ] Add safe area inset CSS variables
  - [ ] Apply padding-top for notch/dynamic island
  - [ ] Test on various iPhone models (X, 11, 12, 13, 14, 15)
  - [ ] Handle landscape orientation safe areas
  - [ ] Test on iPad with different orientations
  - [ ] Ensure safe area works when header is hidden/shown
  - [ ] Verify no content overlaps with safe areas

### Phase 6: Pull-to-Refresh Compatibility

- [ ] Task 6: Ensure pull-to-refresh compatibility (AC: 4)
  - [ ] Check if pull-to-refresh is implemented
  - [ ] Test header behavior during pull gesture
  - [ ] Disable header hiding during pull-to-refresh
  - [ ] Ensure header shows during refresh animation
  - [ ] Test on iOS Safari (native pull-to-refresh)
  - [ ] Test on Android Chrome
  - [ ] Handle edge cases (pull while scrolling down)

### Phase 7: Performance Optimization

- [ ] Task 7: Optimize scroll performance (AC: 9)
  - [ ] Use passive event listeners for scroll
  - [ ] Implement scroll throttling if needed
  - [ ] Add requestAnimationFrame for transform updates
  - [ ] Test performance on low-end Android devices
  - [ ] Use React DevTools Profiler to check re-renders
  - [ ] Ensure 60fps during scroll
  - [ ] Optimize state updates to prevent unnecessary renders
  - [ ] Add performance monitoring

### Phase 8: Modal and Overlay Compatibility

- [ ] Task 8: Handle modal/overlay interactions (Risk mitigation)
  - [ ] Disable scroll behavior when modal is open
  - [ ] Ensure proper z-index layering with modals
  - [ ] Test header behavior with command palette
  - [ ] Test with bottom sheet components
  - [ ] Test with speed dial from Story 10.7
  - [ ] Verify drawer from Story 10.6 works correctly
  - [ ] Handle scroll lock when overlays are active

### Phase 9: Edge Case Handling

- [ ] Task 9: Handle edge cases and corner scenarios
  - [ ] Test with very short pages (no scrolling)
  - [ ] Test rapid scroll direction changes
  - [ ] Test horizontal scrolling (shouldn't affect header)
  - [ ] Test during page navigation/transitions
  - [ ] Handle programmatic scrolling (scrollTo)
  - [ ] Test with keyboard navigation (Page Up/Down)
  - [ ] Test with accessibility features (zoom, text size)

### Phase 10: Testing & Refinement

- [ ] Task 10: Comprehensive testing (AC: 1-9)
  - [ ] Test on iPhone Safari (various models)
  - [ ] Test on Android Chrome (various devices)
  - [ ] Test scroll threshold accuracy (50px)
  - [ ] Test animation smoothness (200ms duration)
  - [ ] Verify no layout shifts occur
  - [ ] Test 60fps performance on low-end devices
  - [ ] Test with screen readers (ensure header always accessible)
  - [ ] Test landscape and portrait orientations
  - [ ] Test with large text accessibility settings

- [ ] Task 11: Documentation and completion
  - [ ] Document scroll behavior in code comments
  - [ ] Document how to disable scroll behavior (prop)
  - [ ] Create usage examples
  - [ ] Update story status to "Done"
  - [ ] Update Dev Agent Record with completion notes
  - [ ] Create demo video showing scroll behavior

## Dev Notes

### Integration Approach

Add scroll detection to existing header component with transform animations. Use custom hook for scroll direction tracking and apply CSS transforms without modifying header structure.

### Existing Pattern Reference

Use existing header component from Epic 5, add dynamic positioning behavior based on scroll direction.

### Key Constraints

- Must not interfere with fixed position elements or modals
- Must work with iOS safe areas (notch/dynamic island)
- Must maintain 60fps performance during scroll
- Must not affect existing header functionality
- Pull-to-refresh compatibility required

### Implementation Details

```typescript
// Scroll direction detection hook
import { useState, useEffect } from 'react'

interface UseScrollDirectionOptions {
  threshold?: number
  disabled?: boolean
}

export const useScrollDirection = (options: UseScrollDirectionOptions = {}) => {
  const { threshold = 50, disabled = false } = options
  const [scrollDirection, setScrollDirection] = useState<'up' | 'down'>('up')
  const [lastScrollY, setLastScrollY] = useState(0)

  useEffect(() => {
    if (disabled) return

    let ticking = false

    const handleScroll = () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const scrollY = window.scrollY

          // Always show header at top
          if (scrollY <= 0) {
            setScrollDirection('up')
          } else if (scrollY > lastScrollY && scrollY > threshold) {
            // Scrolling down, hide header
            setScrollDirection('down')
          } else if (scrollY < lastScrollY) {
            // Scrolling up, show header
            setScrollDirection('up')
          }

          setLastScrollY(scrollY)
          ticking = false
        })

        ticking = true
      }
    }

    window.addEventListener('scroll', handleScroll, { passive: true })
    return () => window.removeEventListener('scroll', handleScroll)
  }, [lastScrollY, threshold, disabled])

  return scrollDirection
}

// Header component usage
export function MobileHeader() {
  const [isModalOpen, setIsModalOpen] = useState(false)
  const scrollDirection = useScrollDirection({
    threshold: 50,
    disabled: isModalOpen // Disable when modal is open
  })

  const headerClassName = cn(
    "fixed top-0 left-0 right-0 z-40",
    "bg-background border-b",
    "transition-transform duration-200 ease-in-out",
    "will-change-transform",
    scrollDirection === 'down' ? '-translate-y-full' : 'translate-y-0',
    "pt-safe", // iOS safe area
    "md:translate-y-0" // Desktop always visible
  )

  return <header className={headerClassName}>{/* header content */}</header>
}

// iOS safe area CSS (in globals.css)
/*
@supports (padding-top: env(safe-area-inset-top)) {
  .pt-safe {
    padding-top: env(safe-area-inset-top);
  }
}
*/
```

### Testing Standards

- Test on iOS Safari and Android Chrome
- Verify 60fps performance with Chrome DevTools Performance tab
- Test with React DevTools Profiler for re-renders
- Manual testing required for scroll feel and responsiveness
- Test files location: `__tests__/hooks/useScrollDirection.test.tsx`
- Use Lighthouse for performance audits

## Definition of Done

- [ ] Header hides on scroll down after 50px threshold
- [ ] Header shows immediately on scroll up
- [ ] Header always visible at top of page (scrollY === 0)
- [ ] Animation smooth at 200ms duration with ease-in-out
- [ ] No layout shifts or janky movements
- [ ] iOS safe areas properly handled (notch/dynamic island)
- [ ] Pull-to-refresh compatibility maintained (if implemented)
- [ ] All header functions remain accessible (search, menu)
- [ ] 60fps performance during scroll on low-end devices
- [ ] Works with modals and overlays (disables during modal)
- [ ] Works alongside bottom tabs and drawer
- [ ] Screen reader accessible
- [ ] Code follows existing patterns
- [ ] Tests pass
- [ ] PR created with demo video
- [ ] Code reviewed and approved
- [ ] Story status updated to "Done"

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Conflicts with fixed elements or modal overlays, performance issues
- **Mitigation:** Proper z-index management, disable during modal display, optimize with RAF
- **Rollback:** Simple prop to disable scroll behavior

**Compatibility Verification:**

- [ ] Works with existing sticky elements
- [ ] Modal/dialog display not affected
- [ ] Pull-to-refresh gestures work
- [ ] Performance smooth on low-end devices
- [ ] No interference with swipeable drawer (Story 10.6)
- [ ] Works with bottom tab navigation (Story 10.5)
- [ ] Works with speed dial (Story 10.7)

## Validation Checklist

**Scope Validation:**

- [x] Story can be completed in one development session (2-3 hours)
- [x] Integration approach is straightforward (add scroll behavior)
- [x] Follows existing header patterns
- [x] No backend changes required

**Clarity Check:**

- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified (header component)
- [x] Success criteria are testable (scroll behavior)
- [x] Rollback approach is simple (disable prop)

---

## Change Log

| Date         | Version | Description                                   | Author       |
| ------------ | ------- | --------------------------------------------- | ------------ |
| Nov 2024     | 1.0     | Initial story creation from Epic 10           | Product Team |
| Nov 10, 2024 | 1.1     | Added Tasks/Subtasks and all missing sections | Product Team |
| Nov 10, 2024 | 1.2     | Story approved for development                | Product Team |

---

## Dev Agent Record

### Agent Model Used

_To be populated during implementation_

### Debug Log References

_To be populated during implementation_

### Completion Notes List

_To be populated during implementation_

### File List

**Expected files to be modified/created:**

- `hooks/useScrollDirection.ts` (new)
- `components/layout/MobileHeader.tsx` (modified)
- `components/layout/MobileLayout.tsx` (modified)
- `app/globals.css` (safe area insets)

_Additional files to be documented during implementation_

---

## QA Results

_To be populated after QA review_

---

**Story Status:** Approved
**Estimated Effort:** 2-3 hours
**Dependencies:** Mobile layout from Stories 10.5-10.7
**Feature Flag:** collapsible_header_enabled
**Epic:** EPIC-10 - Modern Navigation & Design System Overhaul
**Created:** November 2024
**Last Updated:** November 10, 2024
