# Story 10.17: Project Costs Screen Enhancement

## Status

**Current Status:** drafted

## User Story

As a **project manager**,
I want **a clear visual overview of project costs with interactive charts and organized data**,
So that **I can quickly understand budget health and make informed financial decisions**.

## Story Context

**Existing System Integration:**

- Integrates with: Project cost data model, Recharts library, existing cost CRUD operations
- Technology: Tailwind CSS, Recharts, React, tRPC API
- Follows pattern: Epic 10.3 design system (Inter font, Material Symbols, navy/primary colors)
- Touch points: Project costs page (`app/projects/[id]/costs/page.tsx`), cost components
- Reference: `docs/design/epic-10.3-mockups/project-costs.html`

**Problem Statement:**

The current project costs screen may be overwhelming with dense tabular data, lacking visual context for budget health. Users need to quickly assess whether a project is on budget, identify cost categories consuming the most funds, and spot trends in spending over time.

**Target Behavior:**

Users should immediately see a visual financial dashboard with summary cards showing budget status at a glance, followed by interactive charts for deeper analysis, and a detailed filterable table for granular cost management.

## Acceptance Criteria

**Source Mapping:**

- AC 1-4: From mockup design "Four summary cards with metrics" [Source: docs/design/epic-10.3-mockups/project-costs.html, lines 64-114]
- AC 5-7: From Epic 10.3 "Cost breakdown charts and trend visualization" [Source: docs/epics/EPIC-10.3-Screen-Design-Improvements.md, lines 142-145]
- AC 8-10: From mockup design "Detailed cost table with filtering" [Source: docs/design/epic-10.3-mockups/project-costs.html, lines 138-283]
- AC 11-12: From Epic 10.3 "Export functionality and inline editing" [Source: docs/epics/EPIC-10.3-Screen-Design-Improvements.md, lines 127, 142]
- AC 13-14: From design system "Dark mode support, Material Symbols icons" [Source: docs/design/epic-10.3-mockups/project-costs.html, lines 11-36]
- AC 15: From Epic 10.3 "Mobile-optimized cost viewing (card-based on small screens)" [Source: docs/epics/EPIC-10.3-Screen-Design-Improvements.md, lines 146]
- AC 16: From accessibility requirements "WCAG AA compliance" [Source: docs/epics/EPIC-10.3-Screen-Design-Improvements.md, lines 401]
- AC 17: From Epic 10.3 "Preserve all calculations, no data loss" [Source: docs/epics/EPIC-10.3-Screen-Design-Improvements.md, lines 147]

**Functional Requirements:**

1. Four summary cards at top: Total Budget, Total Spent, Remaining, Variance
2. Summary cards show amount, percentage, and status indicator
3. Color-coded indicators (green=good, orange=warning, red=over budget)
4. Icon badges for each summary card (wallet, payments, check, trending)
5. Cost Breakdown pie/doughnut chart by category
6. Budget vs Actual comparison bar chart
7. Spending Trend line chart over time
8. Detailed cost table with sortable columns
9. Category filter dropdown (All, Construction, Materials, Labor, Permits, Professional Services)
10. Search input for cost descriptions/vendors
11. Export button (CSV/PDF functionality)
12. Add Cost button to create new cost entry
13. Category badges with distinct colors per type
14. Dark mode support for all elements including charts

**Integration Requirements:**

15. Mobile responsive: cards stack 1 column, charts stack vertically, table scrolls horizontally
16. WCAG AA accessibility: keyboard navigation, screen reader support, color contrast
17. Financial calculations preserved: all existing cost logic maintained, no rounding errors

## Tasks / Subtasks

### Phase 1: Summary Cards Component

- [ ] Task 1: Create SummaryCard component (AC: 1,2,3,4)
  - [ ] Create reusable SummaryCard component
  - [ ] Props: title, value, subtitle, icon, iconColor, statusIndicator
  - [ ] Icon badge with colored background circle
  - [ ] Typography: font-semibold for labels, font-black for values
  - [ ] Status indicator with colored dot and text
  - [ ] Dark mode variants for all colors
  - [ ] Export from components/projects

- [ ] Task 2: Implement summary cards grid (AC: 1,2,3,4)
  - [ ] Calculate total budget from cost data
  - [ ] Calculate total spent (sum of actual costs)
  - [ ] Calculate remaining (budget - spent)
  - [ ] Calculate variance (actual - budget)
  - [ ] Determine status colors (green < 80%, orange 80-100%, red > 100%)
  - [ ] Grid layout: 1 col mobile, 2 col tablet, 4 col desktop
  - [ ] Gap-6 spacing between cards

### Phase 2: Chart Infrastructure

- [ ] Task 3: Set up Recharts with dark mode detection (AC: 5,6,7,14)
  - [ ] Create useTheme hook to detect dark mode
  - [ ] Define chart color palette (light/dark variants)
  - [ ] Create Chart wrapper component with default styles
  - [ ] Configure Recharts with Inter font family
  - [ ] Set responsive container dimensions
  - [ ] Test chart rendering in both modes

### Phase 3: Cost Breakdown Chart

- [ ] Task 4: Implement pie/doughnut chart (AC: 5)
  - [ ] Aggregate costs by category
  - [ ] Calculate category percentages
  - [ ] Create PieChart component
  - [ ] Use distinct colors per category:
    - Construction: blue
    - Materials: purple
    - Labor: green
    - Permits: yellow
    - Professional Services: indigo
  - [ ] Add legend with percentages
  - [ ] Tooltip shows category, amount, percentage
  - [ ] Responsive sizing (max-h-64)
  - [ ] Dark mode color adjustments

### Phase 4: Budget vs Actual Chart

- [ ] Task 5: Implement bar chart (AC: 6)
  - [ ] Group costs by category
  - [ ] Calculate budget total per category
  - [ ] Calculate actual total per category
  - [ ] Create BarChart component (grouped bars)
  - [ ] X-axis: Categories
  - [ ] Y-axis: Dollar amounts (formatted)
  - [ ] Two bars per category: Budget (navy), Actual (orange)
  - [ ] Tooltip shows budget, actual, variance
  - [ ] Responsive sizing
  - [ ] Dark mode grid/axis colors

### Phase 5: Spending Trend Chart

- [ ] Task 6: Implement line chart (AC: 7)
  - [ ] Aggregate spending by month
  - [ ] Calculate cumulative spending over time
  - [ ] Create LineChart component
  - [ ] X-axis: Timeline (months)
  - [ ] Y-axis: Cumulative spending (formatted)
  - [ ] Smooth line curve
  - [ ] Budget line as reference (dashed)
  - [ ] Area fill under line (subtle)
  - [ ] Tooltip shows date, amount, budget status
  - [ ] Responsive sizing
  - [ ] Dark mode colors

### Phase 6: Cost Table Structure

- [ ] Task 7: Build cost table layout (AC: 8,9,10)
  - [ ] Card wrapper with border
  - [ ] Table header with title and actions
  - [ ] Category filter dropdown
  - [ ] Search input with icon
  - [ ] Table columns:
    - Description (with subtitle)
    - Category (badge)
    - Vendor
    - Date
    - Budget (right-aligned)
    - Actual (right-aligned)
    - Variance (right-aligned, color-coded)
    - Actions (Edit button)
  - [ ] Overflow-x-auto wrapper for mobile scrolling
  - [ ] Dark mode styling for all elements

### Phase 7: Table Functionality

- [ ] Task 8: Implement filtering and search (AC: 9,10)
  - [ ] Category filter state management
  - [ ] Filter costs by selected category
  - [ ] Search input debouncing (300ms)
  - [ ] Search across description, vendor fields
  - [ ] Combine filters (category AND search)
  - [ ] Show filtered count ("Showing X of Y costs")
  - [ ] Empty state when no results

- [ ] Task 9: Implement table sorting (AC: 8)
  - [ ] Sortable column headers (click to sort)
  - [ ] Sort icons (up/down arrows)
  - [ ] Sort by: Description, Category, Vendor, Date, Budget, Actual, Variance
  - [ ] Toggle ascending/descending
  - [ ] Maintain sort state
  - [ ] Visual indicator for active sort column

### Phase 8: Category Badges

- [ ] Task 10: Create category badge component (AC: 13)
  - [ ] CategoryBadge component with color mapping
  - [ ] Color schemes:
    - Construction: bg-blue-100/dark:bg-blue-900/30, text-blue-700/dark:text-blue-300
    - Materials: bg-purple-100/dark:bg-purple-900/30, text-purple-700/dark:text-purple-300
    - Labor: bg-green-100/dark:bg-green-900/30, text-green-700/dark:text-green-300
    - Permits: bg-yellow-100/dark:bg-yellow-900/30, text-yellow-700/dark:text-yellow-300
    - Professional Services: bg-indigo-100/dark:bg-indigo-900/30, text-indigo-700/dark:text-indigo-300
  - [ ] Rounded-full style
  - [ ] Small padding (px-2 py-1)
  - [ ] Font-semibold, text-xs

### Phase 9: Header Actions

- [ ] Task 11: Implement Export functionality (AC: 11)
  - [ ] Export button with download icon
  - [ ] Export to CSV format
  - [ ] Include all table columns
  - [ ] Apply current filters to export
  - [ ] Generate filename with project name and date
  - [ ] Success toast notification
  - [ ] Loading state during export
  - [ ] Optional: PDF export (future enhancement)

- [ ] Task 12: Implement Add Cost button (AC: 12)
  - [ ] Add Cost button with plus icon
  - [ ] Navigate to new cost form
  - [ ] Pass project ID in route
  - [ ] Button styling: navy/primary with hover state

### Phase 10: Dark Mode Implementation

- [ ] Task 13: Implement dark mode support (AC: 14)
  - [ ] Add dark: variants to all backgrounds
  - [ ] Update text colors for dark mode
  - [ ] Update border colors for dark mode
  - [ ] Update chart colors for dark mode
  - [ ] Update table hover states
  - [ ] Update input field styles
  - [ ] Test contrast ratios in dark mode
  - [ ] Verify chart readability

### Phase 11: Mobile Responsiveness

- [ ] Task 14: Optimize for mobile (AC: 15)
  - [ ] Summary cards: 1 column on mobile (< md)
  - [ ] Charts: full-width stacked on mobile
  - [ ] Chart height: shorter on mobile (max-h-48)
  - [ ] Table: horizontal scroll with fixed height
  - [ ] Sticky table headers on scroll
  - [ ] Filter/search: stack vertically on mobile
  - [ ] Touch-friendly button sizes (h-10 minimum)
  - [ ] Test on mobile devices (iOS/Android)

### Phase 12: Accessibility

- [ ] Task 15: Implement accessibility features (AC: 16)
  - [ ] All interactive elements keyboard accessible
  - [ ] Table headers have proper scope attributes
  - [ ] Sort buttons have aria-labels
  - [ ] Filter dropdown has label association
  - [ ] Search input has label (visible or aria-label)
  - [ ] Chart data accessible via table (skip link)
  - [ ] Color not sole indicator (variance has +/- symbols)
  - [ ] Focus indicators visible
  - [ ] Test with screen reader

### Phase 13: Data Integration

- [ ] Task 16: Connect to existing cost API (AC: 17)
  - [ ] Fetch costs using existing tRPC endpoint
  - [ ] Map cost data to summary cards
  - [ ] Transform data for charts
  - [ ] Handle loading states
  - [ ] Handle error states
  - [ ] Optimistic updates for edits
  - [ ] Invalidate queries on mutations
  - [ ] Preserve all calculation logic

- [ ] Task 17: Verify financial calculations (AC: 17)
  - [ ] Test budget calculations with real data
  - [ ] Verify variance calculations (positive/negative)
  - [ ] Test percentage calculations
  - [ ] Ensure no rounding errors (use Decimal.js if needed)
  - [ ] Test edge cases (zero budget, negative variance)
  - [ ] Compare with existing cost page calculations

### Phase 14: Testing & Validation

- [ ] Task 18: Manual testing
  - [ ] Test all summary card calculations
  - [ ] Test chart interactions (hover, click)
  - [ ] Test category filtering
  - [ ] Test search functionality
  - [ ] Test table sorting (all columns)
  - [ ] Test export functionality
  - [ ] Test add cost navigation
  - [ ] Test in light and dark modes
  - [ ] Test on mobile devices
  - [ ] Test with various data sizes (0, 10, 100+ costs)

- [ ] Task 19: Automated testing
  - [ ] Unit tests for calculation functions
  - [ ] Unit tests for filter/search logic
  - [ ] Unit tests for chart data transformations
  - [ ] Integration tests for cost API
  - [ ] Component tests for interactive elements
  - [ ] Accessibility tests (axe-core)
  - [ ] Visual regression tests

## Dev Notes

### Learnings from Previous Story

**From Story 10.16 (Login and 2FA Screen):**

[Source: stories/10.16.story.md - Dev Notes, lines 230-280]

**Key Takeaways:**

- **Design System Consistency:** Use same color palette (navy/primary), Inter font, Material Symbols icons
- **Dark Mode Pattern:** Use `dark:` Tailwind variants, detect with `document.documentElement.classList.contains('dark')`
- **Component Reusability:** Create generic components (SummaryCard, CategoryBadge) for use across Epic 10.3
- **Responsive Strategy:** Mobile-first approach (1 col → 2 col → 4 col grid), test on real devices
- **Accessibility:** WCAG AA compliance non-negotiable, test with screen readers and axe-core
- **Icon Usage:** Material Symbols with consistent sizing (text-xl for small, text-2xl for large)

**Integration Notes for Current Story:**

- Cost page is inside main app layout (has Sidebar, ContentWrapper)
- Use PageContainer pattern from Story 10.15 (px-6 py-6 max-w-7xl)
- Charts must adapt to sidebar collapse (192px width gain when collapsed)
- Maintain 200ms animation standards for any transitions
- Financial calculations are critical - test extensively, no data loss
- Export functionality should respect current filters/search

### Implementation Approach

**File Structure:**

```
apps/web/src/
├── app/projects/[id]/costs/
│   └── page.tsx                      # Main costs page
├── components/projects/
│   ├── CostSummaryCard.tsx           # Summary card component
│   ├── CostBreakdownChart.tsx        # Pie chart component
│   ├── BudgetActualChart.tsx         # Bar chart component
│   ├── SpendingTrendChart.tsx        # Line chart component
│   ├── CostTable.tsx                 # Table component
│   ├── CategoryBadge.tsx             # Category badge
│   └── CostFilters.tsx               # Filter/search component
└── lib/
    ├── chart-utils.ts                # Chart color/theme helpers
    └── cost-calculations.ts          # Financial calculation utilities
```

**Cost Summary Calculations:**

```typescript
// lib/cost-calculations.ts
import { Decimal } from "decimal.js"

interface Cost {
  budget: number
  actual: number
  category: string
}

export function calculateSummary(costs: Cost[]) {
  const totalBudget = costs.reduce((sum, cost) => sum.plus(cost.budget), new Decimal(0))

  const totalSpent = costs.reduce((sum, cost) => sum.plus(cost.actual), new Decimal(0))

  const remaining = totalBudget.minus(totalSpent)
  const variance = totalSpent.minus(totalBudget)
  const percentSpent = totalBudget.isZero()
    ? new Decimal(0)
    : totalSpent.dividedBy(totalBudget).times(100)

  return {
    totalBudget: totalBudget.toNumber(),
    totalSpent: totalSpent.toNumber(),
    remaining: remaining.toNumber(),
    variance: variance.toNumber(),
    percentSpent: percentSpent.toDecimalPlaces(1).toNumber(),
  }
}

export function getVarianceStatus(percentSpent: number) {
  if (percentSpent < 80) return "good" // green
  if (percentSpent < 100) return "warning" // orange
  return "over" // red
}
```

**Chart Theme Configuration:**

```typescript
// lib/chart-utils.ts
export function getChartTheme(isDark: boolean) {
  return {
    textColor: isDark ? "#cbd5e1" : "#333333",
    gridColor: isDark ? "#334155" : "#e2e8f0",
    backgroundColor: isDark ? "#0f172a" : "#ffffff",
    tooltipBg: isDark ? "#1e293b" : "#ffffff",
    tooltipBorder: isDark ? "#475569" : "#e2e8f0",
  }
}

export const categoryColors = {
  Construction: { light: "#3b82f6", dark: "#60a5fa" },
  Materials: { light: "#a855f7", dark: "#c084fc" },
  Labor: { light: "#10b981", dark: "#34d399" },
  Permits: { light: "#eab308", dark: "#fbbf24" },
  "Professional Services": { light: "#6366f1", dark: "#818cf8" },
}
```

**Recharts Dark Mode Pattern:**

```tsx
// components/projects/CostBreakdownChart.tsx
"use client"

import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from "recharts"
import { useTheme } from "@/hooks/useTheme"
import { getChartTheme, categoryColors } from "@/lib/chart-utils"

export function CostBreakdownChart({ data }: { data: CategoryData[] }) {
  const { isDark } = useTheme()
  const theme = getChartTheme(isDark)

  return (
    <ResponsiveContainer width="100%" height={256}>
      <PieChart>
        <Pie
          data={data}
          cx="50%"
          cy="50%"
          labelLine={false}
          outerRadius={80}
          fill="#8884d8"
          dataKey="value"
        >
          {data.map((entry, index) => (
            <Cell
              key={`cell-${index}`}
              fill={categoryColors[entry.category][isDark ? "dark" : "light"]}
            />
          ))}
        </Pie>
        <Tooltip
          contentStyle={{
            backgroundColor: theme.tooltipBg,
            border: `1px solid ${theme.tooltipBorder}`,
            borderRadius: "0.5rem",
            fontFamily: "Inter",
          }}
        />
        <Legend
          wrapperStyle={{
            fontFamily: "Inter",
            color: theme.textColor,
          }}
        />
      </PieChart>
    </ResponsiveContainer>
  )
}
```

**Summary Card Component:**

```tsx
// components/projects/CostSummaryCard.tsx
import { ReactNode } from "react"

interface SummaryCardProps {
  title: string
  value: string
  subtitle: string
  icon: string
  iconBgColor: string
  iconColor: string
  statusDot?: {
    color: string
    text: string
  }
}

export function CostSummaryCard({
  title,
  value,
  subtitle,
  icon,
  iconBgColor,
  iconColor,
  statusDot,
}: SummaryCardProps) {
  return (
    <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
      <div className="flex items-center gap-3 mb-4">
        <div className={`flex items-center justify-center w-12 h-12 ${iconBgColor} rounded-xl`}>
          <span className={`material-symbols-outlined ${iconColor} text-2xl`}>{icon}</span>
        </div>
      </div>
      <p className="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
        {title}
      </p>
      <p className="text-3xl font-black text-[#333333] dark:text-white mt-2">{value}</p>
      {statusDot ? (
        <p className={`text-xs mt-2 flex items-center gap-1.5 font-medium ${statusDot.color}`}>
          <span
            className={`inline-block w-2 h-2 rounded-full ${statusDot.color.replace("text-", "bg-")}`}
          ></span>
          {statusDot.text}
        </p>
      ) : (
        <p className="text-xs text-slate-500 dark:text-slate-400 mt-2">{subtitle}</p>
      )}
    </div>
  )
}
```

**Category Badge Component:**

```tsx
// components/projects/CategoryBadge.tsx
const categoryStyles = {
  Construction: "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300",
  Materials: "bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300",
  Labor: "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300",
  Permits: "bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300",
  "Professional Services":
    "bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300",
}

export function CategoryBadge({ category }: { category: string }) {
  const style =
    categoryStyles[category] || "bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300"

  return <span className={`px-2 py-1 text-xs font-semibold rounded-full ${style}`}>{category}</span>
}
```

**Export to CSV:**

```typescript
// lib/export-utils.ts
export function exportCostsToCSV(costs: Cost[], projectName: string) {
  const headers = ["Description", "Category", "Vendor", "Date", "Budget", "Actual", "Variance"]

  const rows = costs.map((cost) => [
    cost.description,
    cost.category,
    cost.vendor,
    cost.date,
    cost.budget.toFixed(2),
    cost.actual.toFixed(2),
    (cost.actual - cost.budget).toFixed(2),
  ])

  const csvContent = [
    headers.join(","),
    ...rows.map((row) => row.map((cell) => `"${cell}"`).join(",")),
  ].join("\n")

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" })
  const link = document.createElement("a")
  const url = URL.createObjectURL(blob)

  link.setAttribute("href", url)
  link.setAttribute(
    "download",
    `${projectName}-costs-${new Date().toISOString().split("T")[0]}.csv`
  )
  link.style.visibility = "hidden"

  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
}
```

### Design System Specifications

**Summary Card Icon Mappings:**

```typescript
const summaryIcons = {
  totalBudget: {
    icon: "account_balance_wallet",
    bgColor: "bg-blue-100 dark:bg-blue-900/30",
    iconColor: "text-blue-600 dark:text-blue-400",
  },
  totalSpent: {
    icon: "payments",
    bgColor: "bg-orange-100 dark:bg-orange-900/30",
    iconColor: "text-orange-600 dark:text-orange-400",
  },
  remaining: {
    icon: "check_circle",
    bgColor: "bg-green-100 dark:bg-green-900/30",
    iconColor: "text-green-600 dark:text-green-400",
  },
  variance: {
    icon: "trending_up",
    bgColor: "bg-red-100 dark:bg-red-900/30",
    iconColor: "text-red-600 dark:text-red-400",
  },
}
```

**Table Typography:**

```css
/* Table headers */
text-xs font-semibold uppercase tracking-wider

/* Table data - primary */
text-sm font-semibold (description, amounts)

/* Table data - secondary */
text-sm font-medium (vendor)
text-sm regular (date)

/* Table data - subtitle */
text-xs text-slate-500 dark:text-slate-400
```

**Responsive Grid Breakpoints:**

```tsx
// Summary cards
grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6

// Charts
grid grid-cols-1 lg:grid-cols-2 gap-6

// Mobile: cards stack vertically, charts full-width
// Tablet (md): 2-column cards, charts full-width
// Desktop (lg): 4-column cards, 2-column charts
```

### Mobile Optimization

**Touch Target Sizes:**

```css
/* Buttons */
h-10:   40px (minimum touch target)
h-12:   48px (comfortable touch target)

/* Inputs */
h-9:    36px (filters/search)

/* Table action buttons */
px-3 py-2:  adequate tap area
```

**Horizontal Scroll Pattern:**

```tsx
<div className="overflow-x-auto">
  <table className="w-full min-w-[800px]">{/* Table content */}</table>
</div>
```

### Accessibility Requirements

**Table Accessibility:**

```tsx
<table className="w-full" role="table" aria-label="Project costs breakdown">
  <thead>
    <tr>
      <th scope="col">Description</th>
      <th scope="col">Category</th>
      {/* ... */}
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>{/* ... */}</td>
    </tr>
  </tbody>
</table>
```

**Sort Button Accessibility:**

```tsx
<button
  aria-label={`Sort by ${column} ${sortOrder === "asc" ? "descending" : "ascending"}`}
  aria-pressed={activeSortColumn === column}
>
  {column}
  <span className="material-symbols-outlined" aria-hidden="true">
    {sortIcon}
  </span>
</button>
```

**Chart Alternative:**

```tsx
<div>
  <canvas id="chart" aria-label="Cost breakdown by category" role="img">
    {/* Chart renders here */}
  </canvas>
  <button className="sr-only" onClick={showTableView}>
    View chart data as table
  </button>
</div>
```

### Testing Strategy

**Unit Tests:**

- Summary calculation functions (budget, spent, remaining, variance)
- Percentage calculations with edge cases (zero budget, negative values)
- Category aggregation logic
- Chart data transformation functions
- Filter and search logic
- Sort comparators for all columns
- CSV export data formatting

**Integration Tests:**

- Fetch costs from API
- Apply category filter
- Apply search filter
- Combine filters
- Sort table columns
- Export filtered data
- Navigate to add cost form
- Navigate to edit cost form

**Visual Tests:**

- Summary cards in light/dark mode
- Charts in light/dark mode
- Table hover states
- Mobile responsive layout
- Chart responsiveness
- Empty states (no costs, no search results)

**Performance Tests:**

- Render time with 100+ costs
- Filter performance with large dataset
- Chart render time
- Export performance with large dataset

### References

**Epic Context:**

[Source: docs/epics/EPIC-10.3-Screen-Design-Improvements.md, lines 115-150 - Story 10.17 description]

- Goal: Redesign cost screen with visual data presentation
- Add summary cards (budget, spent, remaining, variance)
- Implement three chart types (breakdown, comparison, trend)
- Improve table with filtering, grouping, inline editing
- Export functionality (CSV, optional PDF)
- Estimated effort: 3-4 days
- Priority: High (critical business data)
- Risk: Medium (financial data accuracy critical)

**Design Mockup:**

[Source: docs/design/epic-10.3-mockups/project-costs.html - Complete mockup implementation]

- Four summary cards with icons and color-coding
- Cost breakdown pie chart
- Budget vs actual bar chart
- Spending trend line chart
- Detailed table with 8 columns
- Category filter dropdown and search
- Export and Add Cost buttons
- Dark mode support throughout
- Mobile responsive grid layout

**Recharts Documentation:**

[Source: Recharts library documentation]

- PieChart, BarChart, LineChart components
- ResponsiveContainer for adaptive sizing
- Tooltip and Legend components
- Dark mode configuration patterns
- Custom styling and theming

**Existing Cost API:**

[Source: apps/web/src/server/api/routers/costs.ts]

- getCostsByProject endpoint
- createCost, updateCost, deleteCost mutations
- Cost data model with budget/actual/variance fields
- Category types enumeration

### Project Structure Notes

[Source: docs/architecture/unified-project-structure.md]

**File Locations:**

- **Costs Page:** `apps/web/src/app/projects/[id]/costs/page.tsx` (MODIFY - complete redesign)
- **Summary Cards:** `apps/web/src/components/projects/CostSummaryCard.tsx` (CREATE)
- **Charts:** `apps/web/src/components/projects/Cost*Chart.tsx` (CREATE - 3 chart components)
- **Table:** `apps/web/src/components/projects/CostTable.tsx` (CREATE)
- **Filters:** `apps/web/src/components/projects/CostFilters.tsx` (CREATE)
- **Badges:** `apps/web/src/components/projects/CategoryBadge.tsx` (CREATE)
- **Calculations:** `apps/web/src/lib/cost-calculations.ts` (CREATE)
- **Chart Utils:** `apps/web/src/lib/chart-utils.ts` (CREATE)
- **Export Utils:** `apps/web/src/lib/export-utils.ts` (CREATE)
- **Costs API:** `apps/web/src/server/api/routers/costs.ts` (EXISTS - use existing endpoints)

**Data Flow:**

```
Page Component (page.tsx)
├── Fetch costs via tRPC (costs.getByProject)
├── Calculate summary (lib/cost-calculations.ts)
├── Transform data for charts
└── Render:
    ├── Header (title + actions)
    ├── Summary Cards Grid (4 cards)
    ├── Charts Row (breakdown + comparison)
    ├── Spending Trend Chart (full-width)
    └── Cost Table (with filters)
```

## Definition of Done

- [ ] Four summary cards implemented and calculating correctly
- [ ] Summary cards show proper status indicators
- [ ] Cost breakdown pie/doughnut chart rendering
- [ ] Budget vs actual bar chart rendering
- [ ] Spending trend line chart rendering
- [ ] All charts adapt to dark mode
- [ ] Charts use Recharts library consistently
- [ ] Detailed cost table displaying all data
- [ ] Table columns sortable (all 8 columns)
- [ ] Category filter dropdown working
- [ ] Search input filtering description/vendor
- [ ] Filters combine correctly (category AND search)
- [ ] Category badges with distinct colors
- [ ] Export to CSV functionality working
- [ ] Add Cost button navigates to form
- [ ] Dark mode support for all elements
- [ ] Material Symbols icons used throughout
- [ ] Mobile responsive (cards stack, charts stack, table scrolls)
- [ ] Touch targets ≥ 40px on mobile
- [ ] Keyboard navigation working (table, filters, sort)
- [ ] Screen reader accessible (table semantics, aria-labels)
- [ ] Color contrast WCAG AA compliant
- [ ] Financial calculations verified (no errors)
- [ ] All existing cost functionality preserved
- [ ] Loading states during data fetch
- [ ] Error states with user feedback
- [ ] Empty states when no costs
- [ ] Unit tests passing (calculations)
- [ ] Integration tests passing (API, filters)
- [ ] Visual regression tests passing
- [ ] Performance acceptable (100+ costs)
- [ ] Build succeeds with no errors
- [ ] Code reviewed and approved
- [ ] Story status updated to "Done"

## Risk and Compatibility Check

**Risk Assessment:**

- **Primary Risk:** Financial calculation errors could cause incorrect budget reporting
- **Mitigation:** Use Decimal.js for precise calculations, extensive testing with edge cases
- **Rollback:** Feature flag to revert to old cost page if critical issues

**Compatibility Verification:**

- [ ] All existing cost API endpoints work unchanged
- [ ] Cost CRUD operations function correctly
- [ ] No data loss during redesign
- [ ] Calculations match existing logic
- [ ] Export includes all necessary data
- [ ] Performance acceptable with large datasets
- [ ] No memory leaks from charts
- [ ] Charts update on data changes
- [ ] Filters don't break with edge case data

## Validation Checklist

**Scope Validation:**

- [x] Story requires complete costs page redesign (3-4 days)
- [x] Integration with Recharts is straightforward
- [x] Follows Epic 10.3 design system
- [x] Mobile responsiveness is critical
- [x] Financial accuracy is non-negotiable

**Clarity Check:**

- [x] Story requirements are clear (mockup provides complete reference)
- [x] Integration points are well-defined (tRPC API, Recharts)
- [x] Success criteria are testable (visual, functional, calculations)
- [x] Rollback approach exists (feature flag)

---

## Change Log

| Date         | Version | Description            | Author    |
| ------------ | ------- | ---------------------- | --------- |
| Nov 13, 2025 | 1.0     | Initial story creation | Dev Agent |

---

## Dev Agent Record

**Context Reference:**

- Story Context: To be generated before implementation
- Design Mockup: `docs/design/epic-10.3-mockups/project-costs.html`

_Implementation notes to be added during development_

---

## QA Results

_To be populated after QA review_

---

**Story Status:** Drafted
**Estimated Effort:** 3-4 days
**Dependencies:** Recharts (installed), existing cost API, Epic 10.3 design system
**Epic:** EPIC-10.3 - Screen Design Improvements - Core Workflows
**Created:** November 13, 2025
**Last Updated:** November 13, 2025

---

## Quick Start Guide

**Fastest implementation approach:**

1. Create summary calculation utilities (1 hour)
2. Build CostSummaryCard component (1 hour)
3. Implement summary cards grid (1 hour)
4. Set up Recharts with dark mode theme (1 hour)
5. Create Cost Breakdown pie chart (2 hours)
6. Create Budget vs Actual bar chart (2 hours)
7. Create Spending Trend line chart (2 hours)
8. Build cost table structure (2 hours)
9. Implement filtering and search (2 hours)
10. Add sorting functionality (1 hour)
11. Create category badges (30 min)
12. Implement export to CSV (1 hour)
13. Add dark mode support throughout (2 hours)
14. Mobile responsive testing (3 hours)
15. Accessibility testing and fixes (2 hours)
16. Integration and performance testing (3 hours)

**Total: ~26 hours (3-3.5 days)**
