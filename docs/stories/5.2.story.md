# Story 5.2: Core Workflow & Navigation Improvements

## Status

Draft

## Story

**As a** real estate developer,
**I want** streamlined navigation and optimized workflows for high-frequency tasks like adding costs and uploading documents,
**so that** I can quickly capture information on-site and efficiently manage my projects without unnecessary clicks or confusion.

## Acceptance Criteria

1. Navigation restructured with breadcrumbs
2. Cost entry form optimized (reduced fields, templates)
3. Document upload supports drag-and-drop and batch
4. All data tables show skeleton loading states
5. Form errors display inline with clear messaging
6. Empty states provide guidance
7. All tooltips implemented for complex fields

## Tasks / Subtasks

- [ ] **Task 1: Implement Navigation Enhancements** (AC: 1)
  - [ ] Subtask 1.1: Add breadcrumb navigation component
    - Create `BreadcrumbNav` component in `src/components/layout/BreadcrumbNav.tsx`
    - Integrate with Next.js App Router (use `usePathname` hook)
    - Display hierarchy: Home > Projects > [Project Name] > [Page Name]
    - Make breadcrumb items clickable links
    - Style using Shadcn/ui Breadcrumb component
  - [ ] Subtask 1.2: Simplify main navigation menu structure
    - Update `MainNav` component in `src/components/layout/MainNav.tsx`
    - Reduce top-level menu items (combine related sections)
    - Add project switcher dropdown in navigation (quick switch between projects)
    - Ensure mobile hamburger menu collapses properly
  - [ ] Subtask 1.3: Create quick actions menu
    - Add floating action button (FAB) for mobile at bottom-right
    - Desktop: Quick actions in project header dropdown
    - Actions: "Add Cost", "Upload Document", "Add Timeline Event"
    - Use Shadcn/ui DropdownMenu component
    - Show contextual actions based on current page

- [ ] **Task 2: Optimize Cost Entry Workflow** (AC: 2, 5, 6, 7)
  - [ ] Subtask 2.1: Reduce form fields with smart defaults
    - Update `CostEntryForm` component in `src/components/costs/CostEntryForm.tsx`
    - Default date to today (editable)
    - Pre-select last-used category if available
    - Pre-fill vendor from recent costs (autocomplete)
    - Make "Notes" field optional and collapsible
  - [ ] Subtask 2.2: Add cost templates for recurring expenses
    - Create `CostTemplate` model and database table
    - Add "Save as Template" button on cost form
    - Add "Load Template" dropdown with saved templates
    - Templates store: amount, description, category, vendor
    - Show template list in empty state ("Quick add from template")
  - [ ] Subtask 2.3: Implement auto-save drafts
    - Use localStorage to save draft cost entries
    - Save draft on field blur (debounced 500ms)
    - Restore draft on page load with confirmation dialog
    - Clear draft after successful submission
    - Show "Draft restored" toast notification
  - [ ] Subtask 2.4: Improve form validation with inline errors
    - Use React Hook Form with Zod validation (already in use)
    - Display error messages below each field (not just at top)
    - Highlight invalid fields with red border
    - Show success checkmark on valid fields (optional)
    - Disable submit button until form is valid
  - [ ] Subtask 2.5: Add tooltips for complex fields
    - Add tooltip to "Category" field explaining categories
    - Add tooltip to "Amount" field showing format (e.g., "$1,234.56")
    - Use Shadcn/ui Tooltip component
    - Ensure tooltips are keyboard accessible (focus trigger)

- [ ] **Task 3: Enhance Document Upload Experience** (AC: 3, 4, 6)
  - [ ] Subtask 3.1: Implement drag-and-drop upload zone
    - Update `DocumentUpload` component in `src/components/documents/DocumentUpload.tsx`
    - Use react-dropzone library for drag-and-drop
    - Visual feedback: highlight drop zone on drag-over
    - Accept multiple files (batch upload)
    - Show file count in drop zone ("Drop 5 files here")
  - [ ] Subtask 3.2: Add progress indicators for uploads
    - Show individual progress bar for each uploading file
    - Display upload percentage (0-100%)
    - Show thumbnail preview for images during upload
    - Allow cancel upload (X button per file)
    - Show success/error state per file after upload
  - [ ] Subtask 3.3: Improve empty state with guidance
    - Empty state: "No documents yet"
    - Subtext: "Drag and drop files here, or click to browse"
    - Show supported file types and size limit (10MB per file)
    - Display helpful icon (upload cloud icon)
    - Add example use case ("Upload receipts, photos, contracts")

- [ ] **Task 4: Implement Skeleton Loading States** (AC: 4)
  - [ ] Subtask 4.1: Create reusable skeleton components
    - Create `SkeletonCard` component in `src/components/ui/skeleton-card.tsx`
    - Create `SkeletonTable` component in `src/components/ui/skeleton-table.tsx`
    - Create `SkeletonList` component in `src/components/ui/skeleton-list.tsx`
    - Use Shadcn/ui Skeleton primitive with proper dimensions
  - [ ] Subtask 4.2: Add skeleton states to all data tables
    - Update `ProjectList` to show `SkeletonTable` during loading
    - Update `CostList` to show `SkeletonTable` during loading
    - Update `VendorList` to show `SkeletonTable` during loading
    - Update `ContactList` to show `SkeletonTable` during loading
    - Update `DocumentList` to show `SkeletonCard` grid during loading
    - Show skeleton count matching expected items (4-8 rows)
  - [ ] Subtask 4.3: Add progressive loading for dashboards
    - Update `ProjectDashboard` to show section-by-section loading
    - Load and show summary cards first (fast query)
    - Then load cost breakdown chart (medium query)
    - Finally load activity feed (slower query)
    - Each section shows skeleton while loading independently

- [ ] **Task 5: Improve Error Handling and Feedback** (AC: 5)
  - [ ] Subtask 5.1: Implement toast notifications
    - Install `sonner` or use Shadcn/ui Toast component
    - Create toast utility functions in `src/lib/toast.ts`
    - Add toast for success: "Cost added successfully"
    - Add toast for errors: "Failed to add cost. Please try again."
    - Add toast for warnings: "Draft saved locally"
    - Position toasts at top-right (desktop) or top-center (mobile)
  - [ ] Subtask 5.2: Add retry mechanisms for failed operations
    - Wrap tRPC mutations in error boundary
    - On network error, show "Retry" button in error toast
    - On conflict error (409), show specific message and allow edit
    - Log failed operations to console for debugging
    - Use React Query's automatic retry (3 attempts with exponential backoff)
  - [ ] Subtask 5.3: Improve empty states across all lists
    - Update all list components to show helpful empty states
    - Empty project list: "Create your first project to get started" + Create button
    - Empty cost list: "No costs yet. Add your first expense." + Add Cost button
    - Empty vendor list: "No vendors yet. Add a vendor from a cost entry."
    - Empty document list: "No documents uploaded. Drag and drop to upload."
    - Include friendly illustration or icon for each empty state

- [ ] **Task 6: Add Contextual Help System** (AC: 7)
  - [ ] Subtask 6.1: Create tooltip system for complex fields
    - Identify complex fields from Story 5.1 audit (if available)
    - Add tooltip to project type selection (explain Renovation vs. New Build)
    - Add tooltip to cost categories (explain what goes in each category)
    - Add tooltip to partner permissions (explain Owner vs. Viewer)
    - Ensure tooltips work on mobile (tap to show, tap outside to hide)
  - [ ] Subtask 6.2: Create onboarding tour for new users (optional - nice to have)
    - Use react-joyride or similar library
    - Create 5-step tour: "Create Project" → "Add Cost" → "Upload Document" → "View Dashboard" → "Invite Partner"
    - Show tour on first login (check localStorage flag)
    - Add "Take Tour" link in help menu for repeat access
    - Allow skip tour and dismiss permanently

- [ ] **Task 7: Optimize Vendor Selection Workflow** (AC: 2)
  - [ ] Subtask 7.1: Add vendor autocomplete with recent vendors
    - Update vendor select field in `CostEntryForm` to use autocomplete
    - Use Shadcn/ui Combobox component (not plain Select)
    - Show recent vendors at top of list (last 5 used)
    - Filter vendors by name as user types
    - Highlight matching text in results
  - [ ] Subtask 7.2: Add quick-add vendor from cost form
    - Add "+ New Vendor" option in vendor autocomplete
    - Click opens inline mini-form (vendor name and contact fields)
    - Save vendor and immediately select in cost form
    - Validate vendor name uniqueness
    - Show success toast: "Vendor added and selected"

- [ ] **Task 8: Implement Optimistic Updates** (AC: 4)
  - [ ] Subtask 8.1: Add optimistic update for cost creation
    - When submitting cost, immediately add to list (before server response)
    - Show cost with "Saving..." indicator (grayed out or with spinner)
    - On success, replace optimistic item with server response
    - On error, remove optimistic item and show error toast with retry
  - [ ] Subtask 8.2: Add optimistic update for cost deletion
    - When deleting cost, immediately remove from list
    - Show undo toast: "Cost deleted. Undo?"
    - If undo clicked, restore cost (cancel API call if not yet sent)
    - If error, restore cost automatically and show error toast
  - [ ] Subtask 8.3: Keep forms disabled during submission
    - Disable all form fields while isSubmitting=true
    - Show loading spinner in submit button
    - Change button text: "Create Cost" → "Creating..."
    - Prevent double-submission with disabled state

## Dev Notes

### Epic and Story Context

This is **Story 5.2** of **Epic 5: UI/UX Refinement & Polish**, a brownfield enhancement to the completed MVP. Epic 5 is HIGH PRIORITY and must be completed before adding new features.

**Story 5.2 Dependencies:**

- ✅ **Story 5.1** should be completed first to provide:
  - UX audit findings (usability issues identified)
  - Design system guidelines (colors, typography, spacing)
  - Wireframes for navigation and cost entry improvements
- If Story 5.1 is not yet complete, reference the Epic 5 acceptance criteria as minimum requirements

**Story 5.2 Goal:** Implement navigation enhancements and workflow optimizations based on audit findings, focusing on high-frequency tasks (cost entry, document upload) and system-wide improvements (loading states, error handling, contextual help).

### Existing System Overview

**Technology Stack:**

- Frontend: Next.js 14 (App Router), React 18, TypeScript 5.3
- UI Framework: Shadcn/ui components + Tailwind CSS
- Forms: React Hook Form + Zod validation
- State Management: React Query (TanStack Query) for server state
- API: tRPC for type-safe client-server communication
- Icons: Lucide React

**Current Navigation Structure:**

- Global layout: `apps/web/src/app/layout.tsx`
- Main navigation: `src/components/layout/MainNav.tsx` (desktop top nav, mobile hamburger)
- Project context: Selected project stored in React Context or URL params
- No breadcrumbs currently implemented

**Current Form Patterns:**

- All forms use React Hook Form with Zod validation
- Shadcn/ui Form components (FormField, FormItem, FormLabel, FormControl, FormMessage)
- Forms use tRPC mutations with React Query for optimistic updates
- Example: `src/components/costs/CostEntryForm.tsx`

**Current Loading Patterns:**

- Most lists show generic "Loading..." text or spinner
- No skeleton screens currently implemented
- Dashboard loads all sections simultaneously (no progressive loading)

**Current Error Handling:**

- Basic error messages in form validation
- tRPC errors caught and displayed
- Limited use of toast notifications (if any)

### Relevant Source Tree

```
apps/web/src/
├── app/                              # Next.js App Router
│   ├── layout.tsx                    # Global layout (update for navigation)
│   ├── projects/
│   │   ├── [id]/
│   │   │   ├── costs/page.tsx        # Cost list page (add skeleton)
│   │   │   ├── documents/page.tsx    # Document list (add skeleton, drag-drop)
│   │   │   ├── dashboard/page.tsx    # Dashboard (add progressive loading)
│   │   │   └── ...
│   │   └── page.tsx                  # Project list (add skeleton)
│   └── ...
├── components/
│   ├── layout/
│   │   ├── MainNav.tsx               # UPDATE: Simplify menu, add quick actions
│   │   ├── BreadcrumbNav.tsx         # CREATE: New breadcrumb component
│   │   └── MobileNav.tsx             # UPDATE: Add FAB for quick actions
│   ├── costs/
│   │   ├── CostEntryForm.tsx         # UPDATE: Reduce fields, add templates, tooltips
│   │   ├── CostList.tsx              # UPDATE: Add skeleton loading
│   │   └── CostTemplate.tsx          # CREATE: Template selector
│   ├── documents/
│   │   ├── DocumentUpload.tsx        # UPDATE: Add drag-drop, batch, progress
│   │   └── DocumentList.tsx          # UPDATE: Add skeleton loading, empty state
│   ├── ui/
│   │   ├── skeleton.tsx              # EXISTING: Shadcn/ui Skeleton
│   │   ├── skeleton-table.tsx        # CREATE: Table skeleton variant
│   │   ├── skeleton-card.tsx         # CREATE: Card skeleton variant
│   │   ├── breadcrumb.tsx            # ADD: Shadcn/ui Breadcrumb component
│   │   └── toast.tsx                 # ADD: Shadcn/ui Toast or sonner
│   └── ...
├── lib/
│   ├── toast.ts                      # CREATE: Toast utility functions
│   └── local-storage.ts              # CREATE: Draft storage utilities
└── server/                           # tRPC backend (minimal changes)
    └── api/routers/
        └── cost-templates.ts         # CREATE: Cost template router
```

### Database Schema Changes

**New Table: cost_templates**

```typescript
// Add to src/server/db/schema.ts
export const costTemplates = pgTable("cost_templates", {
  id: uuid("id").primaryKey().defaultRandom(),
  userId: uuid("user_id")
    .notNull()
    .references(() => users.id, { onDelete: "CASCADE" }),
  projectId: uuid("project_id").references(() => projects.id, { onDelete: "CASCADE" }), // Optional: template per project or global
  name: text("name").notNull(), // e.g., "Electrician Invoice", "Weekly Supplies"
  amount: decimal("amount", { precision: 10, scale: 2 }), // Optional default amount
  description: text("description").notNull(),
  categoryId: uuid("category_id")
    .notNull()
    .references(() => categories.id),
  vendorId: uuid("vendor_id").references(() => vendors.id, { onDelete: "SET NULL" }), // Optional default vendor
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

**Migration:**

- Create Drizzle migration: `drizzle-kit generate:pg`
- Apply migration: `npm run db:migrate`

### Component Implementation Details

**Breadcrumb Component:**

```typescript
// src/components/layout/BreadcrumbNav.tsx
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";
import { Breadcrumb, BreadcrumbItem, BreadcrumbLink, BreadcrumbList, BreadcrumbPage, BreadcrumbSeparator } from "@/components/ui/breadcrumb";
import { ChevronRight } from "lucide-react";

export function BreadcrumbNav() {
  const pathname = usePathname();
  const segments = pathname.split("/").filter(Boolean);

  // Build breadcrumb hierarchy (Home > Projects > [Project Name] > [Page])
  // Use tRPC query to fetch project name if segment is UUID

  return (
    <Breadcrumb>
      <BreadcrumbList>
        <BreadcrumbItem>
          <BreadcrumbLink href="/">Home</BreadcrumbLink>
        </BreadcrumbItem>
        {segments.map((segment, index) => (
          <React.Fragment key={index}>
            <BreadcrumbSeparator><ChevronRight /></BreadcrumbSeparator>
            <BreadcrumbItem>
              {index === segments.length - 1 ? (
                <BreadcrumbPage>{formatSegment(segment)}</BreadcrumbPage>
              ) : (
                <BreadcrumbLink href={`/${segments.slice(0, index + 1).join("/")}`}>
                  {formatSegment(segment)}
                </BreadcrumbLink>
              )}
            </BreadcrumbItem>
          </React.Fragment>
        ))}
      </BreadcrumbList>
    </Breadcrumb>
  );
}
```

**Drag-and-Drop Upload:**

```typescript
// src/components/documents/DocumentUpload.tsx
import { useDropzone } from "react-dropzone";
import { Upload } from "lucide-react";

export function DocumentUpload({ projectId }: { projectId: string }) {
  const uploadMutation = api.documents.upload.useMutation();

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop: (acceptedFiles) => {
      acceptedFiles.forEach(file => {
        // Upload each file with progress tracking
        uploadMutation.mutate({ projectId, file });
      });
    },
    accept: {
      "image/*": [".png", ".jpg", ".jpeg"],
      "application/pdf": [".pdf"],
    },
    maxSize: 10 * 1024 * 1024, // 10MB
    multiple: true,
  });

  return (
    <div
      {...getRootProps()}
      className={cn(
        "border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition",
        isDragActive ? "border-primary bg-primary/10" : "border-gray-300"
      )}
    >
      <input {...getInputProps()} />
      <Upload className="w-12 h-12 mx-auto mb-4 text-gray-400" />
      {isDragActive ? (
        <p>Drop files here...</p>
      ) : (
        <div>
          <p className="font-medium">Drag and drop files here</p>
          <p className="text-sm text-muted-foreground">or click to browse</p>
          <p className="text-xs text-muted-foreground mt-2">
            Supports: PNG, JPG, PDF (max 10MB per file)
          </p>
        </div>
      )}
    </div>
  );
}
```

**Skeleton Loading:**

```typescript
// src/components/ui/skeleton-table.tsx
import { Skeleton } from "@/components/ui/skeleton";

export function SkeletonTable({ rows = 5 }: { rows?: number }) {
  return (
    <div className="space-y-2">
      {/* Table header */}
      <div className="flex gap-4 pb-2 border-b">
        <Skeleton className="h-4 w-1/4" />
        <Skeleton className="h-4 w-1/4" />
        <Skeleton className="h-4 w-1/4" />
        <Skeleton className="h-4 w-1/4" />
      </div>
      {/* Table rows */}
      {Array.from({ length: rows }).map((_, i) => (
        <div key={i} className="flex gap-4 py-3">
          <Skeleton className="h-4 w-1/4" />
          <Skeleton className="h-4 w-1/4" />
          <Skeleton className="h-4 w-1/4" />
          <Skeleton className="h-4 w-1/4" />
        </div>
      ))}
    </div>
  );
}
```

### Testing Requirements

**Component Tests:**

- Test BreadcrumbNav renders correct hierarchy
- Test drag-and-drop upload accepts files and rejects invalid types
- Test skeleton components render with correct count
- Test cost template save and load functionality
- Test autocomplete filters vendors correctly
- Test optimistic updates rollback on error

**Integration Tests:**

- Test complete cost entry workflow with template
- Test document upload with multiple files
- Test vendor quick-add from cost form
- Test form validation shows inline errors
- Test toast notifications appear and dismiss

**E2E Tests (Playwright):**

- Test user can create cost from template
- Test user can drag-and-drop multiple documents
- Test user can navigate using breadcrumbs
- Test user sees skeleton while data loads
- Test user sees helpful empty states

**Accessibility Tests:**

- Test breadcrumbs keyboard navigable
- Test tooltips keyboard accessible (focus trigger)
- Test drag-drop has keyboard alternative (file input)
- Test all buttons have proper ARIA labels
- Test skeleton screens announced to screen readers

### Testing

**Test File Locations:**

- Component tests: Co-located in `__tests__/` folders
  - `src/components/layout/__tests__/BreadcrumbNav.test.tsx`
  - `src/components/documents/__tests__/DocumentUpload.test.tsx`
  - `src/components/costs/__tests__/CostEntryForm.test.tsx`
- Integration tests: `apps/web/integration/__tests__/`
- E2E tests: `apps/web/e2e/tests/workflow-improvements.spec.ts`

**Test Framework:**

- Frontend: Vitest + Testing Library
- E2E: Playwright

**Test Patterns:**

- Use `render()` from Testing Library for component tests
- Use `fireEvent` or `userEvent` for interactions
- Mock tRPC with `createTestCaller`
- Use `waitFor()` for async assertions

**Coverage Requirements:**

- All new components have unit tests
- All new workflows have integration tests
- Critical paths have E2E tests

## Change Log

| Date       | Version | Description                         | Author     |
| ---------- | ------- | ----------------------------------- | ---------- |
| 2025-10-30 | 1.0     | Initial story creation for Epic 5.2 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent during implementation_

### Debug Log References

_To be populated by dev agent during implementation_

### Completion Notes List

_To be populated by dev agent during implementation_

### File List

_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after story completion_
