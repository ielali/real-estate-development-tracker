# Story 6.3: Backup Management & Security Enhancements

## Status

Approved

## Story

**As a** platform user,
**I want** to see a complete security activity log and receive notifications for important security events,
**so that** I can monitor my account security and be alerted to any suspicious activity.

## Acceptance Criteria

1. All security events logged to database (security_events table)
2. Activity log visible in security settings (last 50 events)
3. Email notifications sent for critical security events
4. Admin dashboard shows 2FA adoption percentage
5. Documentation created for backup restoration process
6. Security settings page consolidates 2FA and activity log
7. Activity log shows: event type, timestamp, IP address, device
8. Activity log is read-only (users cannot delete entries)

## Tasks / Subtasks

- [ ] Create database schema for security event logging (AC: 1, 7)
  - [ ] Create `security_events` table:
    - [ ] `id` (UUID primary key)
    - [ ] `userId` (text, FK to users.id with CASCADE)
    - [ ] `eventType` (text, enum: "2fa_enabled", "2fa_disabled", "2fa_login_success", "2fa_login_failure", "backup_code_generated", "backup_code_used", "backup_downloaded")
    - [ ] `ipAddress` (text, client IP address)
    - [ ] `userAgent` (text, browser/device info)
    - [ ] `metadata` (jsonb, additional event-specific data)
    - [ ] `timestamp` (timestamp, when event occurred)
    - [ ] `createdAt` (timestamp, when record was created)
  - [ ] Create index on userId and timestamp for efficient queries
  - [ ] Run database migration:
    - [ ] Generate migration: `bunx drizzle-kit generate`
    - [ ] Review migration file in `drizzle/migrations/`
    - [ ] Apply migration: `bunx drizzle-kit push`
    - [ ] Verify schema in database

- [ ] Implement security event logging service (AC: 1, 7)
  - [ ] Create `SecurityEventLogger` class in `apps/web/src/server/services/security-event-logger.ts`
  - [ ] Implement logging methods for each event type:
    - [ ] `log2FAEnabled(userId, ipAddress, userAgent)` - 2FA activated
    - [ ] `log2FADisabled(userId, ipAddress, userAgent)` - 2FA deactivated
    - [ ] `log2FALoginSuccess(userId, ipAddress, userAgent)` - Successful 2FA login
    - [ ] `log2FALoginFailure(userId, ipAddress, userAgent, attempts)` - Failed 2FA attempt
    - [ ] `logBackupCodeGenerated(userId, ipAddress, userAgent, codeCount)` - Backup codes created
    - [ ] `logBackupCodeUsed(userId, ipAddress, userAgent)` - Backup code used for login
    - [ ] `logBackupDownloaded(userId, projectId, ipAddress, userAgent)` - Project backup downloaded
  - [ ] Extract IP address from request headers (x-forwarded-for, x-real-ip)
  - [ ] Extract user agent from request headers
  - [ ] Store additional metadata in JSON format where applicable

- [ ] Integrate security event logging into existing features (AC: 1)
  - [ ] Story 6.1 (2FA) integration:
    - [ ] Log event when user enables 2FA
    - [ ] Log event when user disables 2FA
    - [ ] Log event on 2FA login success
    - [ ] Log event on 2FA login failure (after each failed attempt)
    - [ ] Log event when backup codes are generated/regenerated
    - [ ] Log event when backup code is used for authentication
  - [ ] Story 6.2 (Backups) integration:
    - [ ] Log event when project backup is downloaded
    - [ ] Include projectId in metadata
  - [ ] Pass request context (IP, user agent) to logging calls

- [ ] Extend email service for security notifications (AC: 3)
  - [ ] Add new email templates to EmailService class:
    - [ ] `send2FAEnabledEmail(user, timestamp, device)` - "2FA Enabled" notification
    - [ ] `send2FADisabledEmail(user, timestamp, device)` - "2FA Disabled" notification
    - [ ] `sendBackupCodeUsedEmail(user, timestamp, device)` - "Backup Code Used" alert
    - [ ] `sendBackupDownloadedEmail(user, projectName, timestamp, device)` - "Project Backup Downloaded" notification
  - [ ] Email content includes:
    - [ ] Event type and timestamp
    - [ ] Device/browser information
    - [ ] IP address (partial, e.g., "203.0.113.xxx")
    - [ ] Action guidance ("If this wasn't you, contact support")
  - [ ] Follow existing email template patterns (HTML + text versions)
  - [ ] Use existing Resend integration

- [ ] Trigger email notifications for security events (AC: 3)
  - [ ] Send email when 2FA is enabled
  - [ ] Send email when 2FA is disabled
  - [ ] Send email when backup code is used (security alert)
  - [ ] Send email when project backup is downloaded
  - [ ] Make email sending async (don't block API responses)
  - [ ] Log email failures but don't throw errors to user

- [ ] Create tRPC endpoints for security features (AC: 2, 4)
  - [ ] `security.getActivityLog` - Protected procedure
    - [ ] Fetch last 50 security events for current user
    - [ ] Order by timestamp DESC
    - [ ] Return: eventType, timestamp, ipAddress, userAgent, metadata
  - [ ] `security.get2FAAdoptionStats` - Admin-only procedure
    - [ ] Calculate total users count
    - [ ] Calculate users with 2FA enabled count
    - [ ] Return adoption percentage
    - [ ] Cache result for 5 minutes (optional optimization)

- [ ] Create security settings page and activity log UI (AC: 2, 6, 7, 8)
  - [ ] Create `/settings/security` page component
  - [ ] Consolidate 2FA management section (from Story 6.1):
    - [ ] Move 2FA setup/disable controls to this page
    - [ ] Display current 2FA status
    - [ ] Show backup codes management
    - [ ] Display trusted devices list
  - [ ] Create `SecurityActivityLog` component:
    - [ ] Fetch last 50 security events for current user
    - [ ] Display in table/list format with columns:
      - [ ] Event type (human-readable label)
      - [ ] Timestamp (formatted, e.g., "2 hours ago")
      - [ ] IP address
      - [ ] Device (parsed from user agent)
      - [ ] Details (event-specific metadata)
    - [ ] Implement pagination or "Load more" if >50 events
    - [ ] Add filtering by event type (optional enhancement)
  - [ ] Make activity log read-only:
    - [ ] No delete buttons
    - [ ] No edit functionality
    - [ ] Clear UI indication: "This log is read-only for security"
  - [ ] Mobile responsive design
  - [ ] Follow Shadcn/ui patterns

- [ ] Create admin dashboard for 2FA adoption metrics (AC: 4)
  - [ ] Create `/admin/security` page component (admin-only)
  - [ ] Use `requireAdmin` guard from authorization helpers
  - [ ] Display 2FA adoption metrics:
    - [ ] Total users count
    - [ ] Users with 2FA enabled
    - [ ] Adoption percentage (with progress bar)
    - [ ] Trend indicator (optional: compare to previous week/month)
  - [ ] Add chart/visualization (optional enhancement)
  - [ ] Auto-refresh every 30 seconds (optional)
  - [ ] Follow existing admin page patterns if they exist

- [ ] Create backup restoration documentation (AC: 5)
  - [ ] Create `docs/guides/backup-restoration.md` document
  - [ ] Include sections:
    - [ ] Overview of backup format (JSON structure from Story 6.2)
    - [ ] Step-by-step restoration process
    - [ ] Manual data import instructions
    - [ ] Contact support for assistance
    - [ ] Important notes (documents remain in Netlify Blobs)
  - [ ] Link to documentation from backup download page
  - [ ] Add troubleshooting section

- [ ] Write tests for security features
  - [ ] Unit test: SecurityEventLogger methods
  - [ ] Unit test: Email template generation
  - [ ] Integration test: Security event logging flow
  - [ ] Integration test: Activity log retrieval (last 50 events)
  - [ ] Integration test: 2FA adoption stats calculation
  - [ ] Integration test: Admin-only access to adoption stats
  - [ ] Integration test: Email sending for security events (mock Resend)
  - [ ] Component test: SecurityActivityLog display
  - [ ] Component test: Admin dashboard metrics
  - [ ] E2E test: Full security settings page workflow

## Dev Notes

### Existing System Context

**Email Service:**
[Source: [apps/web/src/lib/email.ts](apps/web/src/lib/email.ts)]

- `EmailService` class with Resend integration
- Existing methods: `sendEmail`, `sendPasswordResetEmail`, `sendInvitationEmail`
- Development mode: Logs to console
- Production mode: Sends via Resend API
- Pattern: Create HTML + text versions of each email
- Uses environment variables: `RESEND_API_KEY`, `RESEND_FROM_EMAIL`

**Authorization & Admin Role:**
[Source: [apps/web/src/server/api/helpers/authorization.ts](apps/web/src/server/api/helpers/authorization.ts)]

- `requireAdmin(ctx)` - Guard for admin-only operations
- `requireRole(ctx, ['admin', 'partner'])` - Flexible role checking
- Users have role: "admin" | "partner"
- Admin role already implemented and enforced

**Audit Log:**
[Source: [apps/web/src/server/db/schema/auditLog.ts](apps/web/src/server/db/schema/auditLog.ts)]

- Existing `audit_log` table for project-related events
- Has: userId, action, entityType, entityId, metadata, ipAddress, userAgent
- Note: `security_events` is separate table for user-level security events

**Tech Stack:**
[Source: [docs/architecture/tech-stack.md](docs/architecture/tech-stack.md)]

- Next.js 14 with App Router
- TypeScript 5.3
- tRPC ^10.45.0 for API layer
- Drizzle ORM ^0.44.6 for database
- Neon PostgreSQL (serverless)
- Resend ^3.2.0 for email service
- Shadcn/ui + Tailwind CSS for UI
- Sonner for toast notifications

### File Locations

**Database Schema:**

- New table: `apps/web/src/server/db/schema/security-events.ts`
- Export from: `apps/web/src/server/db/schema/index.ts`

**Services:**

- SecurityEventLogger: `apps/web/src/server/services/security-event-logger.ts`
- Extend EmailService: `apps/web/src/lib/email.ts` (add new methods)

**tRPC Routers:**

- New security router: `apps/web/src/server/api/routers/security.ts`
- Export from: `apps/web/src/server/api/root.ts`

**Components:** (create in `apps/web/src/components/security/`)

- `SecurityActivityLog.tsx` - Activity log table/list
- `SecuritySettings.tsx` - Main security settings page layout
- `AdminSecurityDashboard.tsx` - Admin 2FA adoption metrics

**Pages:**

- User security settings: `apps/web/src/app/settings/security/page.tsx`
- Admin security dashboard: `apps/web/src/app/admin/security/page.tsx`

**Documentation:**

- Backup restoration guide: `docs/guides/backup-restoration.md`

**Tests:**

- SecurityEventLogger tests: `apps/web/src/server/services/__tests__/security-event-logger.test.ts`
- Email service tests: `apps/web/src/lib/__tests__/email.test.ts` (extend existing)
- tRPC security router tests: `apps/web/src/server/api/routers/__tests__/security.test.ts`
- Component tests: Co-located in `apps/web/src/components/security/__tests__/`

### Integration with Stories 6.1 and 6.2

**Story 6.1 (2FA) Integration Points:**

From Story 6.1, these locations need security event logging added:

- **2FA Setup** (`apps/web/src/server/api/routers/auth.ts`):
  - `auth.verify2FASetup` endpoint â†’ Log `2fa_enabled` event
  - Generate backup codes â†’ Log `backup_code_generated` event

- **2FA Login** (`apps/web/src/app/login/verify-2fa/page.tsx` logic):
  - Successful 2FA verification â†’ Log `2fa_login_success` event
  - Failed 2FA verification â†’ Log `2fa_login_failure` event
  - Backup code used â†’ Log `backup_code_used` event

- **2FA Management** (`apps/web/src/server/api/routers/auth.ts`):
  - `auth.disable2FA` endpoint â†’ Log `2fa_disabled` event
  - `auth.regenerateBackupCodes` endpoint â†’ Log `backup_code_generated` event

**Story 6.2 (Backups) Integration Points:**

From Story 6.2, this location needs security event logging:

- **Backup Download** (`apps/web/src/server/api/routers/projects.ts`):
  - `projects.generateBackup` endpoint â†’ Log `backup_downloaded` event
  - Include projectId and project name in metadata

**Request Context Extraction:**

All tRPC procedures have access to request via `ctx`. Extract IP and user agent:

```typescript
// In tRPC context or helper function
function getRequestMetadata(ctx: Context) {
  const headers = ctx.headers

  const ipAddress =
    headers.get("x-forwarded-for")?.split(",")[0]?.trim() || headers.get("x-real-ip") || "unknown"

  const userAgent = headers.get("user-agent") || "unknown"

  return { ipAddress, userAgent }
}
```

### Technical Implementation Notes

**Security Event Types (TypeScript Enum):**

```typescript
export const SecurityEventType = {
  TWO_FA_ENABLED: "2fa_enabled",
  TWO_FA_DISABLED: "2fa_disabled",
  TWO_FA_LOGIN_SUCCESS: "2fa_login_success",
  TWO_FA_LOGIN_FAILURE: "2fa_login_failure",
  BACKUP_CODE_GENERATED: "backup_code_generated",
  BACKUP_CODE_USED: "backup_code_used",
  BACKUP_DOWNLOADED: "backup_downloaded",
} as const

export type SecurityEventType = (typeof SecurityEventType)[keyof typeof SecurityEventType]
```

**SecurityEventLogger Implementation:**

```typescript
import { db } from "../db"
import { securityEvents } from "../db/schema"

export class SecurityEventLogger {
  async logEvent(
    userId: string,
    eventType: SecurityEventType,
    ipAddress: string,
    userAgent: string,
    metadata?: Record<string, any>
  ): Promise<void> {
    await db.insert(securityEvents).values({
      id: crypto.randomUUID(),
      userId,
      eventType,
      ipAddress,
      userAgent,
      metadata: metadata ? JSON.stringify(metadata) : null,
      timestamp: new Date(),
      createdAt: new Date(),
    })
  }

  async log2FAEnabled(userId: string, ipAddress: string, userAgent: string) {
    await this.logEvent(userId, SecurityEventType.TWO_FA_ENABLED, ipAddress, userAgent)
  }

  async log2FADisabled(userId: string, ipAddress: string, userAgent: string) {
    await this.logEvent(userId, SecurityEventType.TWO_FA_DISABLED, ipAddress, userAgent)
  }

  async log2FALoginSuccess(userId: string, ipAddress: string, userAgent: string) {
    await this.logEvent(userId, SecurityEventType.TWO_FA_LOGIN_SUCCESS, ipAddress, userAgent)
  }

  async log2FALoginFailure(userId: string, ipAddress: string, userAgent: string, attempts: number) {
    await this.logEvent(userId, SecurityEventType.TWO_FA_LOGIN_FAILURE, ipAddress, userAgent, {
      attempts,
    })
  }

  async logBackupCodeGenerated(
    userId: string,
    ipAddress: string,
    userAgent: string,
    codeCount: number
  ) {
    await this.logEvent(userId, SecurityEventType.BACKUP_CODE_GENERATED, ipAddress, userAgent, {
      codeCount,
    })
  }

  async logBackupCodeUsed(userId: string, ipAddress: string, userAgent: string) {
    await this.logEvent(userId, SecurityEventType.BACKUP_CODE_USED, ipAddress, userAgent)
  }

  async logBackupDownloaded(
    userId: string,
    projectId: string,
    projectName: string,
    ipAddress: string,
    userAgent: string
  ) {
    await this.logEvent(userId, SecurityEventType.BACKUP_DOWNLOADED, ipAddress, userAgent, {
      projectId,
      projectName,
    })
  }

  async getUserEvents(userId: string, limit: number = 50) {
    return await db.query.securityEvents.findMany({
      where: eq(securityEvents.userId, userId),
      orderBy: desc(securityEvents.timestamp),
      limit,
    })
  }
}

export const securityEventLogger = new SecurityEventLogger()
```

**Email Template Example (2FA Enabled):**

```typescript
async send2FAEnabledEmail(
  user: { email: string; name: string },
  timestamp: Date,
  device: string,
  ipAddress: string
): Promise<void> {
  const subject = "Two-Factor Authentication Enabled - Real Estate Portfolio";

  // Partially mask IP address for privacy
  const maskedIP = ipAddress.split('.').slice(0, 3).join('.') + '.xxx';

  const html = `
    <div class="container">
      <div class="header">
        <h1>ðŸ”’ Two-Factor Authentication Enabled</h1>
      </div>
      <div class="content">
        <p>Hi ${user.name},</p>
        <p>Two-factor authentication has been enabled on your account.</p>
        <div class="info-box">
          <p><strong>When:</strong> ${timestamp.toLocaleString()}</p>
          <p><strong>Device:</strong> ${device}</p>
          <p><strong>IP Address:</strong> ${maskedIP}</p>
        </div>
        <p>Your account is now more secure. You'll need your authenticator app or backup codes to sign in.</p>
        <div class="warning">
          <p class="warning-text">
            <strong>Didn't enable 2FA?</strong> Contact support immediately and secure your account.
          </p>
        </div>
      </div>
    </div>
  `;

  await this.sendEmail({ to: user.email, subject, html });
}
```

**2FA Adoption Stats Calculation:**

```typescript
// In security.ts tRPC router
get2FAAdoptionStats: protectedProcedure.query(async ({ ctx }) => {
  requireAdmin(ctx)

  const totalUsers = await ctx.db
    .select({ count: sql<number>`count(*)::int` })
    .from(users)
    .where(isNull(users.deletedAt))

  const usersWithTwoFactor = await ctx.db
    .select({ count: sql<number>`count(*)::int` })
    .from(users)
    .where(and(isNull(users.deletedAt), eq(users.twoFactorEnabled, true)))

  const total = totalUsers[0]?.count || 0
  const with2FA = usersWithTwoFactor[0]?.count || 0
  const percentage = total > 0 ? Math.round((with2FA / total) * 100) : 0

  return {
    totalUsers: total,
    usersWithTwoFactor: with2FA,
    adoptionPercentage: percentage,
  }
})
```

**Activity Log Event Type Labels:**

```typescript
export function getEventTypeLabel(eventType: SecurityEventType): string {
  const labels: Record<SecurityEventType, string> = {
    [SecurityEventType.TWO_FA_ENABLED]: "Two-Factor Authentication Enabled",
    [SecurityEventType.TWO_FA_DISABLED]: "Two-Factor Authentication Disabled",
    [SecurityEventType.TWO_FA_LOGIN_SUCCESS]: "Successful 2FA Login",
    [SecurityEventType.TWO_FA_LOGIN_FAILURE]: "Failed 2FA Login Attempt",
    [SecurityEventType.BACKUP_CODE_GENERATED]: "Backup Codes Generated",
    [SecurityEventType.BACKUP_CODE_USED]: "Backup Code Used for Login",
    [SecurityEventType.BACKUP_DOWNLOADED]: "Project Backup Downloaded",
  }
  return labels[eventType] || eventType
}
```

### Security Considerations

**Event Log Integrity:**

- Security events are append-only (no delete/edit operations)
- Users can only view their own security events
- Admin can view aggregated stats but not individual user events (privacy)
- Logs include tamper-evident timestamps

**IP Address Privacy:**

- Store full IP address in database for security analysis
- Display partially masked IP in UI and emails (e.g., "203.0.113.xxx")
- Comply with privacy regulations (GDPR, etc.)

**Email Notifications:**

- Send emails async (don't block user operations)
- Log email failures for admin review
- Don't send duplicate emails for same event within 5 minutes (optional rate limiting)

**Admin Access:**

- Admin dashboard shows only aggregated metrics
- Individual security events are private to each user
- Admin cannot view specific user security logs (privacy protection)

### Performance Considerations

**Security Event Logging:**

- Async logging (don't block API responses)
- Index on (userId, timestamp) for fast queries
- Consider data retention policy (e.g., keep 90 days of events)
- Optional: Archive old events to separate table

**Activity Log Queries:**

- Limit to last 50 events
- Use index on (userId, timestamp DESC)
- Consider pagination for users with many events
- Cache 2FA adoption stats for 5 minutes

### Existing Patterns to Follow

**Email Service:**
[Source: [apps/web/src/lib/email.ts](apps/web/src/lib/email.ts)]

- Add new methods to EmailService class
- Create both HTML and text versions
- Use existing email template styling
- Follow naming pattern: `send{Purpose}Email`

**tRPC Procedures:**

- Use `protectedProcedure` for user operations
- Use `requireAdmin` guard for admin-only operations
- Use `TRPCError` with appropriate codes
- Server-side Zod validation required

**UI Components:**

- Follow Shadcn/ui patterns (Table, Alert, Card, Badge)
- Mobile-responsive design
- Use Sonner for toast notifications
- Follow existing security settings layout if it exists

### Risk Mitigation

**Primary Risk:** Security event logging failures could hide suspicious activity

**Mitigation Strategies:**

1. Log failures to separate error log for admin review
2. Don't throw errors if logging fails (degrade gracefully)
3. Monitor logging service health
4. Regular security log review process
5. Email notifications as backup alerting mechanism

**Rollback Plan:**

- Security events table is additive (no breaking changes)
- Email notifications can be disabled via environment variable
- Admin dashboard can be hidden via feature flag
- Activity log can be disabled without breaking existing features

### Testing

**Test Environment:**

- Backend tests: `apps/web/src/server/services/__tests__/security-event-logger.test.ts`
- Email tests: `apps/web/src/lib/__tests__/email.test.ts` (extend existing)
- tRPC tests: `apps/web/src/server/api/routers/__tests__/security.test.ts`
- Component tests: Co-located with components
- Use Vitest for all tests
- Mock Resend for email tests

**Test Coverage Required:**

1. SecurityEventLogger logs each event type correctly
2. IP address and user agent are captured
3. getUserEvents returns last 50 events in correct order
4. Email templates generate valid HTML and text
5. Emails send successfully (mock Resend)
6. Activity log displays all event types correctly
7. 2FA adoption stats calculate correctly (0%, 50%, 100% scenarios)
8. Admin guard blocks non-admin users from stats
9. Security events are logged during 2FA operations (integration test)
10. Security events are logged during backup downloads (integration test)
11. Email notifications triggered for security events
12. Activity log is read-only (no delete buttons)

**Testing Frameworks:**
[Source: [docs/architecture/tech-stack.md](docs/architecture/tech-stack.md)]

- Vitest for backend unit/integration tests
- Testing Library for component tests
- Mock Drizzle queries for unit tests
- Mock Resend API for email tests

## Change Log

| Date       | Version | Description                                                                     | Author |
| ---------- | ------- | ------------------------------------------------------------------------------- | ------ |
| 2025-10-31 | 1.1     | Fixed task dependency order: Swapped Tasks 6 & 7 (tRPC endpoints now before UI) | Sarah  |
| 2025-10-31 | 1.0     | Initial story creation from Epic 6 with proactive validation                    | Sarah  |

## Dev Agent Record

### Agent Model Used

(To be populated by dev agent)

### Debug Log References

(To be populated by dev agent)

### Completion Notes List

(To be populated by dev agent)

### File List

(To be populated by dev agent)

## QA Results

(To be populated by QA agent)
