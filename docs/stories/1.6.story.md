# Story 1.6: Deployment Pipeline & External Services Setup

## Status

âœ… **Ready for Review**

**Note:** All code and configuration complete. End-to-end deployment verification requires manual setup steps (Netlify account, Neon database, external services) documented in DEPLOYMENT.md.

## Story

**As a** developer,
**I want** to configure CI/CD and external services,
**so that** the application can be deployed and all features are functional.

## Acceptance Criteria

1. Netlify project setup:
   - Netlify project created and linked to GitHub repository
   - Environment variables configured in Netlify dashboard
   - Preview deployments enabled for all branches
   - Production deployment configured for main branch
   - Neon PostgreSQL database integrated via Netlify

2. GitHub Actions CI/CD:
   - .github/workflows/ci.yml created with type checking, linting, tests, and build verification
   - Automatic Netlify deployments on push to main (via Netlify's built-in CI/CD)

3. External service configuration:
   - Neon PostgreSQL database configured for all environments
   - Resend account created and API key obtained
   - Resend API key added to environment variables
   - Email templates created for partner invitations
   - Netlify Blobs storage enabled and configured

4. Environment configuration:
   - .env.example file created with all required variables
   - .env.local configured for local development with Neon database
   - Production environment variables set in Netlify
   - Documentation of all environment variables

## Tasks / Subtasks

- [x] Configure GitHub Actions CI workflow (AC: 2)
  - [x] Create `.github/workflows/` directory in project root
  - [x] Create `ci.yml` workflow with jobs for type-check, lint, test, build
  - [x] Configure workflow to run on push to main/develop and on pull requests
  - [x] Set up Bun installation and caching for faster CI runs
  - [x] Remove unnecessary SQLite native module rebuild step
  - [ ] Verify workflow runs successfully on GitHub Actions (requires push to GitHub)

- [x] Configure Netlify deployment (AC: 1, 2)
  - [x] Verify `netlify.toml` configuration file exists
  - [x] Confirm build settings: Framework = Next.js, Build Command = `bun run db:migrate && bun run build`
  - [x] Verify preview deployments enabled for all branches in configuration
  - [x] Verify production deployment configured for main branch
  - [x] Confirm base directory to root with publish directory `apps/web/.next`
  - [ ] Link GitHub repository to Netlify project (manual step - requires Netlify account)
  - [ ] Verify automatic deployment on push to main (requires Netlify setup)

- [x] Set up Neon PostgreSQL database (AC: 1, 3)
  - [x] Verify database connection using @neondatabase/serverless
  - [x] Verify Drizzle ORM configuration for PostgreSQL
  - [x] Verify migrations work with PostgreSQL
  - [ ] Create Neon database for development (manual step - requires Neon account)
  - [ ] Enable Neon integration in Netlify dashboard (manual step)
  - [ ] Verify database connection in production (requires deployment)

- [x] Configure Resend email service (AC: 3)
  - [x] Add Resend package dependency (resend, @react-email/components, @react-email/render)
  - [x] Update existing email service to use Resend for production
  - [x] Create email utility functions
  - [x] Create partner invitation email template function
  - [ ] Create Resend account at resend.com (manual step)
  - [ ] Obtain API key from Resend dashboard (manual step)
  - [ ] Add RESEND_API_KEY to Netlify environment variables (manual step)
  - [ ] Test email sending in production environment (requires production deployment)

- [x] Configure Netlify Blobs storage (AC: 3)
  - [x] Document Netlify Blobs setup in DEPLOYMENT.md
  - [ ] Enable Netlify Blobs in project dashboard (manual step - requires Netlify account)
  - [ ] Obtain BLOB_READ_WRITE_TOKEN from Netlify (manual step - auto-injected)
  - [ ] Implement blob storage utilities (deferred to future story)
  - [ ] Test file upload/download in production (requires production deployment)

- [x] Update environment configuration (AC: 4)
  - [x] Update root `.env.example` with all required variables
  - [x] Update `apps/web/.env.example` with detailed documentation
  - [x] Document each environment variable with comments explaining purpose
  - [x] Include setup instructions for each service
  - [x] Add security notes and best practices
  - [x] Update documentation with Netlify and Neon references
  - [ ] Update local `.env.local` with all required values including Neon database URL (user-specific)
  - [ ] Set all environment variables in Netlify dashboard (requires Netlify account)

- [x] Create deployment documentation (AC: 4)
  - [x] Update comprehensive DEPLOYMENT.md file for Netlify
  - [x] Document Netlify project setup steps
  - [x] Document Neon PostgreSQL database setup
  - [x] Document GitHub Actions workflow configuration
  - [x] Document external service setup (Resend, Netlify Blobs, Neon)
  - [x] Document environment variable configuration process
  - [x] Add troubleshooting guide for common deployment issues
  - [x] Add rollback procedures
  - [x] Update architecture docs with Netlify stack

- [ ] Verify end-to-end deployment (AC: 1, 2, 3, 4)
  - [ ] Push code to main branch and verify CI runs successfully
  - [ ] Verify automatic deployment to Netlify production
  - [ ] Test production application functionality
  - [ ] Verify email sending works in production
  - [ ] Verify Neon database connection in production
  - [ ] Create test PR and verify preview deployment works
  - [ ] Verify all environment variables are properly configured

## Dev Notes

### Global Standards Reference

**IMPORTANT:** This story must follow all standards defined in `docs/architecture/coding-standards.md`, which is automatically loaded for all development work.

### Architecture Context

**Deployment Platform** [Source: architecture/deployment-architecture.md]

- **Platform:** Netlify (optimized for Next.js)
- **Build Command:** `cd apps/web && bun run db:migrate && bun run build`
- **Publish Directory:** `apps/web/.next`
- **Base Directory:** `/` (root)
- **CDN/Edge:** Netlify Edge Network with automatic optimization

**Backend Deployment:**

- **Platform:** Netlify Serverless Functions (Next.js API routes)
- **Deployment Method:** Git-based automatic deployment

**Database Deployment:**

- **All Environments:** Neon PostgreSQL (serverless PostgreSQL)
- **Development:** Neon database instance (each developer has own instance)
- **Production:** Neon database via Netlify integration
- **Connection:** Via `NETLIFY_DATABASE_URL` environment variable

### CI/CD Pipeline Configuration

[Source: architecture/deployment-architecture.md#CI/CD Pipeline]

GitHub Actions CI workflow (testing only):

```yaml
name: CI Pipeline
on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - run: bun install --frozen-lockfile
      - run: bun run type-check
      - run: bun run lint
      - run: bun run test
      - run: bun run build
```

**Deployment Notes:**

- GitHub Actions handles CI (testing) only
- Netlify handles deployment automatically via built-in CI/CD
- No deployment workflow needed in GitHub Actions

### Environment Variables Configuration

**For Local Development (.env.local):**

```bash
NODE_ENV=development
DEPLOY_PRIME_URL=http://localhost:3000
NETLIFY_DATABASE_URL=postgresql://[user]:[pass]@[host].neon.tech/[db]?sslmode=require
BETTER_AUTH_SECRET=dev-secret-minimum-32-chars-long
RESEND_API_KEY=re_xxxx
RESEND_FROM_EMAIL=onboarding@resend.dev
BLOB_READ_WRITE_TOKEN=
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=
```

**For Production (Netlify Dashboard):**

```bash
NODE_ENV=production
DEPLOY_PRIME_URL=https://[site-name].netlify.app
NETLIFY_DATABASE_URL=[auto-configured-by-neon-integration]
BETTER_AUTH_SECRET=[production-secret-32-chars]
RESEND_API_KEY=re_xxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com
BLOB_READ_WRITE_TOKEN=[auto-injected-via-netlify-blobs]
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=AIzaSyXXX
```

### External Services Integration

**Neon PostgreSQL Database** [Source: architecture/tech-stack.md]

- **Technology:** Neon PostgreSQL ^1.0.2
- **Purpose:** Serverless PostgreSQL for all environments
- **Setup:**
  1. Create account at neon.tech
  2. Create databases (development and production instances)
  3. Integrate with Netlify via dashboard
  4. Connection string auto-provided via NETLIFY_DATABASE_URL

**Resend Email Service** [Source: architecture/tech-stack.md]

- **Technology:** Resend ^3.2.0
- **Purpose:** Transactional email delivery
- **Setup:**
  1. Create account at resend.com
  2. Obtain API key
  3. Add to Netlify environment variables

**Netlify Blobs Storage** [Source: architecture/tech-stack.md]

- **Technology:** Netlify Blobs (Latest)
- **Purpose:** Scalable document/photo storage
- **Setup:**
  1. Enable in Netlify project dashboard via Integrations
  2. Token auto-injected via NETLIFY_BLOBS_CONTEXT

### Technical Constraints

**Tech Stack Requirements:**

- **Package Manager:** Bun ^1.0.0
- **CI/CD:** GitHub Actions + Netlify
- **Deployment Platform:** Netlify
- **Database:** Neon PostgreSQL ^1.0.2 (all environments)
- **Email Service:** Resend ^3.2.0
- **File Storage:** Netlify Blobs

**Netlify Configuration:**

- Framework: Next.js
- Build Command: `cd apps/web && bun run db:migrate && bun run build`
- Publish Directory: `apps/web/.next`
- Base Directory: `/`
- Node.js Version: 22

### Deployment Environments

| Environment | Frontend URL                             | Database            |
| ----------- | ---------------------------------------- | ------------------- |
| Development | http://localhost:3000                    | Neon (dev instance) |
| Preview     | https://[branch]-[site-name].netlify.app | Neon (preview)      |
| Production  | https://[site-name].netlify.app          | Neon (production)   |

### Important Notes

**Database Configuration:**

- Neon PostgreSQL used for ALL environments (no SQLite)
- Each developer needs own Neon database instance
- Netlify integration provides automatic NETLIFY_DATABASE_URL
- Database connection via @neondatabase/serverless with WebSocket support

**Build Configuration:**

- Build includes database migrations: `bun run db:migrate && bun run build`
- No SQLite native modules needed (removed npm rebuild better-sqlite3)
- Monorepo-aware build configuration in netlify.toml

## Testing

### Test Organization

Infrastructure-focused story - testing via:

1. **CI/CD Pipeline Verification:**
   - GitHub Actions workflows execute successfully
   - All jobs (type-check, lint, test, build) pass

2. **Deployment Verification:**
   - Netlify production deployment succeeds
   - Preview deployments work for PRs
   - Application functional in production

3. **External Services Verification:**
   - Neon database operations work
   - Resend email sending works
   - Environment variables properly configured

### Manual Testing Checklist

- [ ] Push to main triggers CI workflow
- [ ] CI workflow passes all jobs
- [ ] Netlify deployment succeeds
- [ ] Production app accessible
- [ ] Preview deployment works for PRs
- [ ] Neon database connection verified
- [ ] Email sending tested (if configured)
- [ ] Environment variables verified in Netlify

## Change Log

| Date       | Version | Description                                                          | Author                                |
| ---------- | ------- | -------------------------------------------------------------------- | ------------------------------------- |
| 2025-10-01 | 1.0     | Initial story draft created                                          | Bob (Scrum Master)                    |
| 2025-10-04 | 2.0     | Complete rewrite for Netlify deployment platform and Neon PostgreSQL | James (Developer - Claude Sonnet 4.5) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No critical issues. All configuration verified for Netlify and Neon PostgreSQL stack.

### Completion Notes List

1. **GitHub Actions CI**: Verified ci.yml configured for Bun, removed unnecessary SQLite rebuild
2. **Netlify Configuration**: Verified netlify.toml with proper build settings including migrations
3. **Neon PostgreSQL**: Verified @neondatabase/serverless integration and Drizzle ORM config
4. **Environment Configuration**: Updated .env.example files with Netlify and Neon setup
5. **Documentation Updates**:
   - DEPLOYMENT.md updated for Netlify and Neon
   - tech-stack.md updated to reflect Netlify and Neon
   - deployment-architecture.md rewritten for Netlify
   - monitoring-and-observability.md rewritten for Netlify Analytics
   - Story 1.6 completely rewritten for Netlify stack

### File List

**Configuration Files:**

- [.github/workflows/ci.yml](.github/workflows/ci.yml) - CI pipeline (updated - removed SQLite rebuild)
- [netlify.toml](netlify.toml) - Netlify deployment config (verified)
- Removed: `.github/workflows/deploy.yml` - No longer needed (Netlify handles deployment automatically)

**Modified Documentation:**

- [DEPLOYMENT.md](DEPLOYMENT.md) - Netlify deployment guide
- [apps/web/.env.example](apps/web/.env.example) - Netlify and Neon config
- [docs/architecture/tech-stack.md](docs/architecture/tech-stack.md) - Netlify stack
- [docs/architecture/deployment-architecture.md](docs/architecture/deployment-architecture.md) - Netlify architecture
- [docs/architecture/monitoring-and-observability.md](docs/architecture/monitoring-and-observability.md) - Netlify monitoring
- [docs/stories/1.6.story.md](docs/stories/1.6.story.md) - Rewritten for Netlify

## QA Results

_To be populated by QA agent after story completion_
