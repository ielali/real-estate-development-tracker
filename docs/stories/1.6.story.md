# Story 1.6: Deployment Pipeline & External Services Setup

## Status

âœ… **Ready for Review**

**Note:** All code and configuration complete. End-to-end deployment verification requires manual setup steps (Vercel account, GitHub secrets, external services) documented in DEPLOYMENT.md.

## Story

**As a** developer,
**I want** to configure CI/CD and external services,
**so that** the application can be deployed and all features are functional.

## Acceptance Criteria

1. Vercel project setup:
   - Vercel project created and linked to GitHub repository
   - Environment variables configured in Vercel dashboard
   - Preview deployments enabled for all branches
   - Production deployment configured for main branch

2. GitHub Actions CI/CD:
   - .github/workflows/ci.yml created with type checking, linting, tests, and build verification
   - .github/workflows/deploy.yml for production deployments

3. External service configuration:
   - Resend account created and API key obtained
   - Resend API key added to environment variables
   - Email templates created for partner invitations
   - Vercel Blob storage enabled and configured
   - Blob storage token added to environment variables

4. Environment configuration:
   - .env.example file created with all required variables
   - .env.local configured for local development
   - Production environment variables set in Vercel
   - Documentation of all environment variables

## Tasks / Subtasks

- [x] Configure GitHub Actions CI workflow (AC: 2)
  - [x] Create `.github/workflows/` directory in project root
  - [x] Create `ci.yml` workflow with jobs for type-check, lint, test, build
  - [x] Configure workflow to run on push to main/develop and on pull requests
  - [x] Set up Bun installation and caching for faster CI runs
  - [x] Configure test database for CI environment
  - [ ] Verify workflow runs successfully on GitHub Actions (requires push to GitHub)

- [x] Configure GitHub Actions deployment workflow (AC: 2)
  - [x] Create `deploy.yml` workflow for production deployments
  - [x] Configure workflow to run only on main branch after CI passes
  - [x] Set up Vercel deployment action with proper tokens
  - [ ] Add environment variables to GitHub secrets (manual step - requires GitHub access)
  - [ ] Test deployment workflow with a dummy commit (requires GitHub setup)

- [x] Set up Vercel project (AC: 1)
  - [x] Create vercel.json configuration file
  - [ ] Link GitHub repository to Vercel project (manual step - requires Vercel account)
  - [x] Configure build settings in vercel.json: Framework = Next.js, Build Command = `bun run build`
  - [x] Enable preview deployments for all branches in configuration
  - [x] Configure production deployment for main branch
  - [x] Set root directory to `apps/web` (monorepo configuration)
  - [ ] Verify automatic deployment on push to main (requires Vercel setup)

- [x] Configure Resend email service (AC: 3)
  - [x] Add Resend package dependency (resend, @react-email/components, @react-email/render)
  - [x] Update existing email service to use Resend for production
  - [x] Create email utility functions in apps/web/apps/web/src/lib/email-resend.ts
  - [x] Create partner invitation email template function
  - [ ] Create Resend account at resend.com (manual step)
  - [ ] Obtain API key from Resend dashboard (manual step)
  - [ ] Add RESEND_API_KEY to Vercel environment variables (manual step)
  - [ ] Test email sending in production environment (requires production deployment)

- [x] Configure Vercel Blob storage (AC: 3)
  - [x] Add @vercel/blob package dependency
  - [x] Create blob storage utilities in apps/web/apps/web/src/lib/blob.ts
  - [x] Implement uploadFile, deleteFile, listFiles, getFileMetadata functions
  - [x] Add generateBlobPathname helper for unique file paths
  - [ ] Enable Vercel Blob in project dashboard (manual step - requires Vercel account)
  - [ ] Obtain BLOB_READ_WRITE_TOKEN from Vercel (manual step)
  - [ ] Add BLOB_READ_WRITE_TOKEN to Vercel environment variables (manual step)
  - [ ] Test file upload/download in production (requires production deployment)

- [x] Update environment configuration (AC: 4)
  - [x] Update root `.env.example` with all required variables
  - [x] Update `apps/web/.env.example` with detailed documentation
  - [x] Document each environment variable with comments explaining purpose
  - [x] Include setup instructions for each service
  - [x] Add security notes and best practices
  - [x] Create environment variables documentation in README.md
  - [ ] Update local `.env.local` with all required values (user-specific)
  - [ ] Set all environment variables in Vercel dashboard (requires Vercel account)

- [x] Create deployment documentation (AC: 4)
  - [x] Create comprehensive DEPLOYMENT.md file
  - [x] Document Vercel project setup steps
  - [x] Document GitHub Actions workflow configuration
  - [x] Document external service setup (Resend, Blob storage)
  - [x] Document environment variable configuration process
  - [x] Add troubleshooting guide for common deployment issues
  - [x] Add rollback procedures
  - [x] Update main README.md with deployment instructions
  - [x] Add environment variables reference table to README.md
  - [x] Add quick start deployment guide to README.md

- [ ] Verify end-to-end deployment (AC: 1, 2, 3, 4)
  - [ ] Push code to main branch and verify CI runs successfully
  - [ ] Verify automatic deployment to Vercel production
  - [ ] Test production application functionality
  - [ ] Verify email sending works in production
  - [ ] Verify blob storage works in production
  - [ ] Create test PR and verify preview deployment works
  - [ ] Verify all environment variables are properly configured

## Dev Notes

### Global Standards Reference

**IMPORTANT:** This story must follow all standards defined in `docs/architecture/coding-standards.md`, which is automatically loaded for all development work.

### Previous Story Insights

From Story 1.5 (Basic Cost Tracking) implementation:

- Project already has comprehensive test coverage with Vitest configured
- Turborepo monorepo structure is functional
- Database migrations working with Drizzle Kit
- Better-auth authentication system functional
- All core dependencies installed and configured
- Git hooks (Husky + lint-staged) already configured for code quality

### Architecture Context

**Deployment Platform** [Source: architecture/deployment-architecture.md]

- **Platform:** Vercel (optimized for Next.js)
- **Build Command:** `npm run build` (update to `bun run build` for consistency)
- **Output Directory:** `.next` (automatic)
- **CDN/Edge:** Vercel Edge Network with automatic optimization

**Backend Deployment:**

- **Platform:** Vercel Serverless Functions (Next.js API routes)
- **Deployment Method:** Git-based automatic deployment

**Database Deployment:**

- **Development:** Local SQLite file
- **Production:** Vercel Postgres or Turso (hosted SQLite) - NOT IMPLEMENTED YET
- **Note:** Database migration to production is deferred to future story

### CI/CD Pipeline Configuration

[Source: architecture/deployment-architecture.md#CI/CD Pipeline]

Required GitHub Actions workflow configuration:

```yaml
name: CI/CD Pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4 # Will need to change to Bun setup
        with:
          node-version: "18"
      - run: npm ci # Update to bun install
      - run: npm run type-check
      - run: npm run lint
      - run: npm run test
      - run: npm run build

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: vercel/action@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

**Adaptation Required:**

- Update to use Bun instead of npm for package management
- Configure Bun caching for faster CI runs
- Use `bun install` instead of `npm ci`
- Use `bun run` for all script commands

### Environment Variables Configuration

[Source: architecture/development-workflow.md#Environment Configuration]

**Required Environment Variables:**

**For Local Development (.env.local):**

```bash
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
DATABASE_URL=file:./dev.db
BETTER_AUTH_SECRET=your-auth-secret
RESEND_API_KEY=your-resend-key
BLOB_READ_WRITE_TOKEN=your-vercel-blob-token
```

**For Production (Vercel Dashboard):**

```bash
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://realestate-portfolio.vercel.app
DATABASE_URL=<production-database-url>  # To be configured in future story
BETTER_AUTH_SECRET=<production-secret>
RESEND_API_KEY=<production-key>
BLOB_READ_WRITE_TOKEN=<production-token>
VERCEL_URL=<auto-populated-by-vercel>
```

**Current .env.example Status:**
The current .env.example file is minimal and needs to be updated with all required variables for this story.

### External Services Integration

**Resend Email Service** [Source: architecture/tech-stack.md]

- **Technology:** Resend ^3.2.0
- **Purpose:** Transactional email delivery
- **Use Cases:** Partner notifications, invitation emails
- **Integration:** Next.js API routes for sending emails
- **Setup:**
  1. Create account at resend.com
  2. Obtain API key
  3. Add to environment variables
  4. Create email templates using React Email

**Vercel Blob Storage** [Source: architecture/tech-stack.md]

- **Technology:** Vercel Blob ^0.15.0
- **Purpose:** Scalable document/photo storage
- **Use Cases:** Construction documents, photos
- **Integration:** Seamless Vercel integration, CDN delivery
- **Setup:**
  1. Enable in Vercel project dashboard
  2. Obtain BLOB_READ_WRITE_TOKEN
  3. Configure client in lib/blob.ts
  4. Test upload/download functionality

### File Locations

Based on project structure [Source: architecture/unified-project-structure.md]:

**CI/CD Workflows:**

- GitHub Actions workflows: `.github/workflows/ci.yml`
- Deployment workflow: `.github/workflows/deploy.yml`

**Configuration Files:**

- Environment template: `.env.example` (exists, needs update)
- Local environment: `.env.local` (developer-specific, not committed)

**Email Templates:**

- Email templates directory: `apps/web/src/emails/`
- Partner invitation template: `apps/web/src/emails/partner-invitation.tsx`

**Blob Storage Client:**

- Blob client configuration: `apps/web/src/lib/blob.ts`

**Documentation:**

- Deployment guide: `DEPLOYMENT.md` (create in project root)
- Environment variable docs: Update `README.md`

### Technical Constraints

**Tech Stack Requirements** [Source: architecture/tech-stack.md]

- **Package Manager:** Bun ^1.0.0 - Fast JavaScript runtime and package manager
- **CI/CD:** GitHub Actions (Latest) - Free tier, excellent GitHub integration
- **Deployment Platform:** Vercel (Latest) - Zero-config deployment, edge network
- **Email Service:** Resend ^3.2.0 - Transactional email with Next.js DX
- **File Storage:** Vercel Blob ^0.15.0 - Seamless Vercel integration

**Vercel Configuration:**

- Framework Preset: Next.js
- Build Command: `bun run build`
- Output Directory: `.next` (automatic)
- Root Directory: `apps/web` (monorepo)
- Node.js Version: 18.x

**GitHub Actions Configuration:**

- Use official Bun GitHub Action for setup
- Cache Bun dependencies for faster runs
- Run tests with dedicated test database
- Only deploy on main branch after all tests pass

### Security Considerations

**Environment Variable Security:**

- Never commit actual values to repository
- Use GitHub Secrets for CI/CD tokens
- Use Vercel dashboard for production secrets
- Document required variables in .env.example with placeholder values
- Rotate secrets regularly in production

**Deployment Security:**

- Preview deployments should use separate environment variables
- Production secrets should never be used in preview environments
- Implement proper access controls on Vercel project
- Use Vercel's built-in security features (automatic HTTPS, DDoS protection)

### Deployment Environments

[Source: architecture/deployment-architecture.md#Environments]

| Environment | Frontend URL                                     | Purpose           |
| ----------- | ------------------------------------------------ | ----------------- |
| Development | http://localhost:3000                            | Local development |
| Preview     | https://[branch]-realestate-portfolio.vercel.app | PR previews       |
| Production  | https://realestate-portfolio.vercel.app          | Live environment  |

**Note:** Backend URL is same as Frontend URL (integrated Next.js API routes)

### Testing Strategy

**Deployment Testing:**

- Verify CI pipeline runs successfully
- Test preview deployments on feature branches
- Verify production deployment after merge
- Test all external service integrations in production
- Verify environment variables are correctly set
- Test email sending in production
- Test blob storage operations in production

**No Unit Tests Required:**
This story focuses on infrastructure and configuration, not code implementation. Testing is done through:

- Successful CI/CD pipeline execution
- Successful production deployment
- Manual verification of external service functionality
- Documentation review

### Documentation Requirements

**DEPLOYMENT.md should include:**

1. Vercel project setup instructions
2. GitHub Actions configuration steps
3. External services setup (Resend, Blob storage)
4. Environment variable configuration
5. Troubleshooting common issues
6. Rollback procedures

**README.md updates should include:**

1. Quick start deployment guide
2. Environment variables reference table
3. Links to detailed deployment documentation
4. Prerequisites for deployment

### Important Notes

**Database in Production:**

- This story does NOT include production database setup
- Production database (Vercel Postgres or Turso) will be configured in a future story
- For now, focus on CI/CD pipeline and external services only

**Build Command:**

- Update from `npm run build` to `bun run build` for consistency
- Ensure all scripts in package.json use `bun` instead of `npm`

**Monorepo Configuration:**

- Vercel must be configured with Root Directory = `apps/web`
- Build settings should account for turborepo structure
- Ensure workspace dependencies are resolved correctly

## Testing

### Test Organization

This story is infrastructure-focused, so traditional unit/integration tests are not applicable. Testing is performed through:

1. **CI/CD Pipeline Verification:**
   - GitHub Actions workflows execute successfully
   - All jobs (type-check, lint, test, build) pass
   - Deployment job triggers only on main branch

2. **Deployment Verification:**
   - Production deployment completes successfully
   - Preview deployments work for feature branches
   - Application loads and functions in production

3. **External Services Verification:**
   - Resend email sending works in production
   - Vercel Blob storage upload/download works
   - All environment variables properly configured

4. **Documentation Review:**
   - DEPLOYMENT.md is complete and accurate
   - README.md includes deployment instructions
   - Environment variables are documented

### Manual Testing Checklist

- [ ] Push to main triggers CI workflow
- [ ] CI workflow passes all jobs
- [ ] Deployment to production succeeds
- [ ] Production app is accessible
- [ ] Create PR and verify preview deployment
- [ ] Test email sending in production
- [ ] Test blob storage in production
- [ ] Verify all environment variables set correctly
- [ ] Review and validate documentation

## Change Log

| Date       | Version | Description                                                                         | Author                                |
| ---------- | ------- | ----------------------------------------------------------------------------------- | ------------------------------------- |
| 2025-10-01 | 1.0     | Initial story draft created                                                         | Bob (Scrum Master)                    |
| 2025-10-01 | 1.1     | Implementation completed - CI/CD, Vercel config, email/blob services, documentation | James (Developer - Claude Sonnet 4.5) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No critical issues encountered during implementation. All configuration files created successfully.

### Completion Notes List

1. **GitHub Actions Workflows Created**: CI and deployment workflows configured for Bun and Next.js monorepo
2. **Vercel Configuration**: Created vercel.json with proper monorepo settings and build configuration
3. **Email Service Integration**:
   - Added Resend package dependencies
   - Updated existing email service to use Resend for production
   - Created email-resend.ts with partner invitation template
4. **Blob Storage Integration**:
   - Added @vercel/blob package
   - Created comprehensive blob.ts utilities for file operations
   - Implemented upload, delete, list, and metadata functions
5. **Environment Configuration**:
   - Updated both root and apps/web .env.example files with comprehensive documentation
   - Documented all required and optional variables
   - Added setup instructions for each service
6. **Documentation**:
   - Created extensive DEPLOYMENT.md with step-by-step deployment guide
   - Updated README.md with environment variables table and deployment section
   - Included troubleshooting and rollback procedures
7. **Manual Steps Required**: Several tasks require manual user action (creating accounts, setting up Vercel project, configuring GitHub secrets) - these are clearly documented in DEPLOYMENT.md

### File List

**New Files Created:**

- `.github/workflows/ci.yml` - GitHub Actions CI pipeline
- `.github/workflows/deploy.yml` - GitHub Actions deployment workflow
- `vercel.json` - Vercel project configuration
- `apps/web/apps/web/src/lib/email-resend.ts` - Resend email service utilities
- `apps/web/apps/web/src/lib/blob.ts` - Vercel Blob storage utilities
- `DEPLOYMENT.md` - Comprehensive deployment guide

**Modified Files:**

- `.env.example` - Updated with all deployment environment variables
- `apps/web/.env.example` - Updated with detailed documentation
- `apps/web/package.json` - Added resend, @react-email/components, @react-email/render, @vercel/blob
- `README.md` - Added deployment section and environment variables documentation
- `docs/stories/1.6.story.md` - Updated task checkboxes and Dev Agent Record

## QA Results

_To be populated by QA agent after story completion_
