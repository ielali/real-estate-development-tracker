# Story 1.3: Authentication System

## Status

Approved

## Story

**As a** user,
**I want** to securely log in with email and password,
**so that** my project data is protected.

## Acceptance Criteria

1. Better-auth integrated with Next.js
2. Login page with email/password form using Shadcn/ui components
3. Registration flow for initial admin user
4. Session management working with secure cookies
5. Protected routes redirect unauthenticated users to login
6. Logout functionality clears session properly

## Tasks / Subtasks

- [ ] Set up Better-auth configuration and integration (AC: 1, 4)
  - [ ] Install Better-auth package (^1.3.13) and its dependencies
  - [ ] Configure Better-auth with Next.js in apps/web/src/server/auth.ts
  - [ ] Set up environment variables (BETTER_AUTH_SECRET, NEXTAUTH_URL)
  - [ ] Configure session management with JWT in httpOnly cookies (30-day expiration)
  - [ ] Implement CSRF protection through Next.js built-in features
  - [ ] Add rate limiting middleware for authentication endpoints

- [ ] Create authentication database schema updates (AC: 1, 3)
  - [ ] Update users table schema in apps/web/src/server/db/schema/users.ts
  - [ ] Add password hash field to users table
  - [ ] Generate and run database migration for users table changes
  - [ ] Update seed script to include test user with hashed password

- [ ] Implement login page and form component (AC: 2)
  - [ ] Create login page at apps/web/src/app/login/page.tsx
  - [ ] Build LoginForm component using Shadcn/ui form components
  - [ ] Add Zod schema validation for email/password
  - [ ] Implement form submission handler with error states
  - [ ] Add loading states and success feedback
  - [ ] Include "Remember Me" checkbox for session persistence

- [ ] Implement registration flow for admin user (AC: 3)
  - [ ] Create registration page at apps/web/src/app/register/page.tsx
  - [ ] Build RegistrationForm component with firstName, lastName, email, password fields
  - [ ] Add password strength validation and confirmation field
  - [ ] Implement registration mutation in tRPC router
  - [ ] Set user role to 'admin' for initial registration
  - [ ] Add success redirect to dashboard after registration

- [ ] Create authentication context and hooks (AC: 4, 5)
  - [ ] Create AuthProvider component wrapping the application
  - [ ] Implement useAuth hook for accessing user session
  - [ ] Create middleware for protected routes in apps/web/src/middleware.ts
  - [ ] Configure protected route patterns (dashboard, projects, etc.)
  - [ ] Implement automatic redirect to login for unauthenticated users
  - [ ] Add session refresh logic for expired tokens

- [ ] Implement logout functionality (AC: 6)
  - [ ] Create logout endpoint in authentication router
  - [ ] Add logout button component to layout header
  - [ ] Clear session cookies on logout
  - [ ] Redirect to login page after successful logout
  - [ ] Clear any client-side state/cache on logout

- [ ] Add authentication to tRPC context and procedures (AC: 1, 5)
  - [ ] Update tRPC context to include user session
  - [ ] Create protectedProcedure middleware for authenticated routes
  - [ ] Apply protectedProcedure to existing project/cost routers
  - [ ] Add user context to database operations for audit logging

- [ ] Write comprehensive tests for authentication flow (AC: All)
  - [ ] Unit tests for authentication utilities and validation
  - [ ] Integration tests for login/registration endpoints
  - [ ] Component tests for login/registration forms
  - [ ] E2E test for complete authentication flow

## Dev Notes

### Previous Story Insights

From Story 1.2 implementation:

- Database layer successfully implemented with Drizzle ORM and SQLite
- Users table already exists with base structure (id, email, firstName, lastName, role, createdAt, updatedAt, deletedAt)
- Strong TypeScript patterns established with Zod validation
- Test suite pattern established using Vitest
- Database is using UUID primary keys for security
- Soft delete pattern already implemented via BaseEntity

### Authentication Configuration

**Better-auth Setup** [Source: architecture/tech-stack.md#Authentication]

- Technology: Better-auth ^1.3.13
- Purpose: Secure session management with RBAC
- Features: Simple integration, flexible providers, session security, built-in role-based access control

**Session Configuration** [Source: architecture/high-level-architecture.md#Authentication Implementation Details]

- Session Storage: JWT tokens in httpOnly cookies with 30-day expiration
- Security: CSRF protection via Next.js, rate limiting on authentication endpoints
- Role-Based Access: tRPC middleware validates permissions at procedure level, not just UI component hiding

**Environment Variables Required** [Source: architecture/development-workflow.md#Environment Configuration]

```bash
# Backend (.env)
BETTER_AUTH_SECRET=your-auth-secret

# Frontend (.env.local)
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key
```

### Data Models

**User Model** [Source: architecture/data-models.md#User]

```typescript
interface User extends BaseEntity {
  email: string
  firstName: string
  lastName: string
  role: "admin" | "partner"
}
```

Note: Password hash field needs to be added to the existing users table.

### API Specifications

**Authentication Service Interface** [Source: architecture/components.md#AuthenticationService]

```typescript
interface AuthenticationService {
  validateSession: (sessionId: string) => Promise<User | null>
  checkProjectAccess: (userId: string, projectId: string) => Promise<boolean>
  createInvitation: (projectId: string, email: string) => Promise<string>
  revokeAccess: (userId: string, projectId: string) => Promise<void>
}
```

### File Locations

Based on current project structure:

- Authentication configuration: `apps/web/src/server/auth.ts`
- Login page: `apps/web/src/app/login/page.tsx`
- Registration page: `apps/web/src/app/register/page.tsx`
- Middleware: `apps/web/src/middleware.ts`
- User schema updates: `apps/web/src/server/db/schema/users.ts`
- Authentication components: `apps/web/src/components/auth/`
- tRPC context: `apps/web/src/server/api/trpc.ts`

### Project Structure Notes

Current structure follows the architecture specification:

- Web app located in `apps/web/`
- Server-side code in `apps/web/src/server/`
- Database schemas in `apps/web/src/server/db/schema/`
- Components in `apps/web/src/components/`
- App Router pages in `apps/web/src/app/`

### Technical Constraints

- Must use Better-auth version ^1.3.13 as specified in tech stack
- Sessions must use httpOnly cookies for security
- All routes must use tRPC for type safety
- Must implement rate limiting on auth endpoints
- Password storage must use secure hashing (bcrypt or argon2)

### Testing

**Testing Requirements** [Source: architecture/testing-strategy.md]

Test file locations:

- Unit tests: `apps/web/src/server/__tests__/auth.test.ts`
- Component tests: `apps/web/src/components/auth/__tests__/`
- Integration tests: `apps/web/integration/api/__tests__/auth.test.ts`
- E2E tests: `apps/web/e2e/tests/auth-flow.spec.ts`

Testing patterns to follow:

- Use Vitest for unit and integration tests
- Use Testing Library for component tests
- Use Playwright for E2E tests
- Follow existing test patterns from Story 1.2

Example test structure for auth component:

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { LoginForm } from '../LoginForm';

test('submits login with valid credentials', async () => {
  const onSuccess = vi.fn();
  render(<LoginForm onSuccess={onSuccess} />);

  fireEvent.change(screen.getByLabelText(/email/i), { target: { value: 'test@example.com' } });
  fireEvent.change(screen.getByLabelText(/password/i), { target: { value: 'password123' } });
  fireEvent.click(screen.getByRole('button', { name: /sign in/i }));

  await waitFor(() => expect(onSuccess).toHaveBeenCalled());
});
```

## Change Log

| Date       | Version | Description                              | Author             |
| ---------- | ------- | ---------------------------------------- | ------------------ |
| 2025-09-22 | 1.0     | Initial story draft created              | Bob (Scrum Master) |
| 2025-09-22 | 1.1     | Updated Better Auth version to 1.3.13    | Bob (Scrum Master) |
| 2025-09-22 | 1.2     | Story approved and ready for development | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be populated by dev agent)

### Debug Log References

(To be populated by dev agent)

### Completion Notes List

(To be populated by dev agent)

### File List

(To be populated by dev agent)

## QA Results

(To be populated by QA agent)
