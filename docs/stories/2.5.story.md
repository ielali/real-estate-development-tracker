# Story 2.5: Performance Benchmarks & Testing

## Status

**Approved**

## Story

**As a** developer,
**I want** to establish performance benchmarks and testing,
**so that** the application meets speed requirements.

## Acceptance Criteria

1. Performance benchmarks:
   - Page load time targets documented
   - Lighthouse CI configured with thresholds
   - Bundle size budgets established
   - Core Web Vitals targets defined
2. Performance testing:
   - Bundle size analysis on each build
   - Performance regression alerts
   - Mobile performance specifically tested
3. Accessibility testing:
   - Automated a11y testing with axe-core
   - WCAG AA compliance checks in CI
   - Keyboard navigation testing checklist
   - Screen reader testing documented

## Tasks / Subtasks

- [ ] Setup Prerequisites
  - [ ] Create `.github/workflows/` directory if it doesn't exist
  - [ ] Create `apps/web/e2e/tests/` directory structure for E2E tests
  - [ ] Verify Playwright is installed (check `apps/web/package.json`)

- [ ] Document Performance Targets (AC: 1)
  - [ ] Create `docs/performance-targets.md` documenting page load time targets per route
  - [ ] Define Core Web Vitals thresholds: LCP (<2.5s), FID (<100ms), CLS (<0.1)
  - [ ] Establish bundle size budgets: initial bundle <250KB, per-route <100KB
  - [ ] Document API response time targets: <500ms standard, <200ms cached
  - [ ] Document current baseline metrics if app is running (optional but recommended)

- [ ] Configure Lighthouse CI in GitHub Actions (AC: 1)
  - [ ] Create `.github/workflows/ci.yaml` if it doesn't exist (base on deployment-architecture.md example)
  - [ ] Add Lighthouse CI job to workflow (runs after build step)
  - [ ] Create `.lighthouserc.json` configuration with thresholds
  - [ ] Set performance score threshold to 90+
  - [ ] Set accessibility score threshold to 100 (WCAG AA)
  - [ ] Set best practices score threshold to 95+
  - [ ] Configure Lighthouse to test key pages: home, project list, project detail, cost entry
  - [ ] Add Lighthouse CI status check to PRs

- [ ] Implement Bundle Size Analysis (AC: 2)
  - [ ] Add `next/bundle-analyzer` to `apps/web/package.json`
  - [ ] Create npm script for bundle analysis: `"analyze": "ANALYZE=true next build"`
  - [ ] Configure webpack-bundle-analyzer output in `next.config.js`
  - [ ] Add bundle size check to CI pipeline using GitHub Actions
  - [ ] Generate bundle report on each build for review
  - [ ] Document bundle optimization opportunities in performance targets doc

- [ ] Setup Performance Regression Monitoring (AC: 2)
  - [ ] Configure GitHub Actions to fail on Lighthouse performance regression >5%
  - [ ] Add bundle size comparison between PR and base branch
  - [ ] Create PR comment automation showing performance changes
  - [ ] Set up alerts for bundle size increases >10KB

- [ ] Configure Mobile Performance Testing (AC: 2)
  - [ ] Add Lighthouse mobile configuration to `.lighthouserc.json`
  - [ ] Set mobile throttling: 4G network, 4x CPU slowdown
  - [ ] Test mobile viewport sizes: 375px (mobile), 768px (tablet)
  - [ ] Verify touch target sizes meet 44x44px minimum requirement
  - [ ] Document mobile performance considerations in targets doc

- [ ] Implement Automated Accessibility Testing (AC: 3)
  - [ ] Install `@axe-core/playwright` for E2E accessibility tests
  - [ ] Create `apps/web/e2e/tests/accessibility.spec.ts` with axe-core checks
  - [ ] Test all major pages for WCAG AA violations
  - [ ] Add accessibility tests to CI pipeline
  - [ ] Configure axe-core rules for WCAG AA compliance
  - [ ] Generate accessibility reports on test failures

- [ ] Create Keyboard Navigation Testing Checklist (AC: 3)
  - [ ] Create `docs/testing/keyboard-navigation-checklist.md`
  - [ ] Document Tab, Shift+Tab, Enter, Escape key behaviors
  - [ ] List focus trap requirements for modals
  - [ ] Define focus restoration requirements
  - [ ] Include skip links testing procedures
  - [ ] Document testing procedures for forms and interactive components

- [ ] Document Screen Reader Testing (AC: 3)
  - [ ] Create `docs/testing/screen-reader-testing.md`
  - [ ] Document testing procedures for NVDA (Windows) and VoiceOver (Mac)
  - [ ] List semantic HTML requirements (nav, main, article, section, button)
  - [ ] Define ARIA label requirements for icon-only buttons
  - [ ] Document aria-live region requirements for dynamic content
  - [ ] Include form field label and error message testing procedures

## Dev Notes

### Previous Story Insights

Story 2.4 completed cost filtering and search functionality with comprehensive backend query support. The implementation established patterns for:

- Complex Drizzle ORM queries with joins and filters
- Search input debouncing (300ms standard)
- Filter UI with removable badges and clear indicators
- Performance optimization with appropriate indexes

### Performance & Monitoring Standards

[Source: docs/architecture/security-and-performance.md#performance-optimization]

**Frontend Performance Targets:**

- Bundle Size: <250KB initial bundle, <100KB per route
- Loading Strategy: Progressive loading with React.lazy() and Suspense boundaries
- Caching Strategy: React Query with 5-minute stale time, background refetching

**Backend Performance Targets:**

- Response Time: <500ms for API calls, <200ms for cached data
- Database Optimization: Drizzle query optimization with proper indexes
- Caching Strategy: In-memory caching for categories

[Source: docs/architecture/monitoring-and-observability.md#key-metrics]

**Core Web Vitals Monitoring:**

- LCP (Largest Contentful Paint): Target <2.5s
- FID (First Input Delay): Target <100ms
- CLS (Cumulative Layout Shift): Target <0.1
- TTI (Time to Interactive): Monitor and optimize

**Performance Monitoring Tools:**

- Netlify Speed Insights: Core Web Vitals tracking
- Next.js built-in Web Vitals reporting
- React Profiler for component rendering analysis
- Bundle size tracking with next/bundle-analyzer

### CI/CD Configuration

[Source: docs/architecture/deployment-architecture.md#cicd-pipeline]

**GitHub Actions Location:** `.github/workflows/ci.yaml`

**IMPORTANT:** This file does not currently exist. It must be created as part of this story.

**Base CI Workflow Structure (from deployment-architecture.md):**

```yaml
name: CI Pipeline
on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - run: bun install --frozen-lockfile
      - run: npm rebuild better-sqlite3
      - run: bun run type-check
      - run: bun run lint
      - run: bun run test
        env:
          NODE_ENV: test
          DATABASE_URL: file:./test.db
          BETTER_AUTH_SECRET: test-secret-key
          DEPLOY_PRIME_URL: http://localhost:3000
      - run: bun run build
        env:
          NODE_ENV: production
          DATABASE_URL: file:./build.db
          BETTER_AUTH_SECRET: build-secret-key
          DEPLOY_PRIME_URL: https://example.com
```

**NEW CI Steps Required for Story 2.5:**

- Lighthouse CI performance checks (add as separate job after build)
- Bundle size analysis and comparison (integrate with build step)
- Accessibility testing with axe-core (add as separate job)
- Performance regression detection (part of Lighthouse CI job)

**Lighthouse CI Integration:**
Add after the test job:

```yaml
lighthouse:
  runs-on: ubuntu-latest
  needs: test
  steps:
    - uses: actions/checkout@v4
    - uses: oven-sh/setup-bun@v1
    - run: bun install --frozen-lockfile
    - run: bun add -g @lhci/cli
    - run: bun run build
    - run: lhci autorun
```

### Technology Stack

[Source: docs/architecture/tech-stack.md]

**Performance Testing Tools:**

- **Frontend Testing:** Vitest + Testing Library (^1.6.0 + ^14.0.0)
- **E2E Testing:** Playwright (^1.40.0) - includes accessibility testing support
- **Performance Monitoring:** Netlify Speed Insights
- **Analytics:** Netlify Analytics
- **Error Tracking:** Sentry (^7.100.0) - planned

**Build Tools:**

- **Build Tool:** Turborepo (^1.11.0) - monorepo optimization
- **Package Manager:** Bun (^1.0.0) - fast install times
- **Bundler:** Next.js built-in (^14.2.0) - webpack-based

### Accessibility Requirements

[Source: docs/architecture/coding-standards.md#accessibility-standards-wcag-aa]

**Form Accessibility:**

- All inputs must have associated labels (Shadcn/ui Form components)
- Clear error messages with aria-describedby
- Required fields marked with aria-required

**Keyboard Navigation:**

- Full keyboard navigation support (Tab, Shift+Tab, Enter, Escape)
- Logical tab order following visual flow
- Focus trapping in modals
- Focus restoration on modal close
- Skip links for main content navigation

**Screen Reader Support:**

- Semantic HTML elements (nav, main, article, section, button)
- ARIA labels for icon-only buttons
- Announce dynamic content (aria-live regions)
- Text alternatives for images/icons
- Error messages announced to screen readers

**Visual Accessibility:**

- WCAG AA color contrast ratios (4.5:1 for text)
- Don't rely on color alone
- Visible focus indicators
- Support browser text resizing up to 200%
- Respect prefers-reduced-motion for animations

### File Locations

[Source: docs/architecture/unified-project-structure.md]

**Documentation Files (NEW):**

- `docs/performance-targets.md` - performance benchmarks and targets
- `docs/testing/keyboard-navigation-checklist.md` - keyboard testing procedures
- `docs/testing/screen-reader-testing.md` - screen reader testing procedures

**CI/CD Configuration Files:**

- `.github/workflows/ci.yaml` - GitHub Actions CI pipeline (MODIFY)
- `.lighthouserc.json` - Lighthouse CI configuration (NEW)

**Application Configuration Files:**

- `apps/web/next.config.js` - Next.js config for bundle analyzer (MODIFY)
- `apps/web/package.json` - add dependencies (MODIFY)

**Test Files:**

- `apps/web/e2e/tests/accessibility.spec.ts` - automated accessibility tests (NEW)

### Testing

[Source: docs/architecture/testing-strategy.md]

**Test Organization:**

- E2E tests location: `apps/web/e2e/tests/`
- E2E test naming: `{feature-name}.spec.ts`

**E2E Testing with Playwright:**

```typescript
import { test, expect } from "@playwright/test"

test("accessibility checks with axe-core", async ({ page }) => {
  await page.goto("/projects")
  // Run axe-core accessibility scan
  const accessibilityScanResults = await new AxeBuilder({ page }).analyze()
  expect(accessibilityScanResults.violations).toEqual([])
})
```

**Test Coverage Requirements:**

- E2E tests for critical user journeys
- Accessibility tests for all major pages
- Performance regression tests in CI
- Bundle size validation on each build

**What to Test:**

- Page load performance metrics
- Core Web Vitals thresholds
- Bundle size constraints
- WCAG AA compliance
- Keyboard navigation flows
- Screen reader compatibility

### Project Structure Notes

All configuration files align with the monorepo structure:

- Root-level CI/CD configuration in `.github/workflows/`
- Application-specific configuration in `apps/web/`
- Documentation in `docs/` following existing patterns
- E2E tests in `apps/web/e2e/tests/` as per testing strategy

### Technical Constraints

[Source: docs/architecture/tech-stack.md]

**Package Manager:** Bun (^1.0.0) - use `bun add` for new dependencies
**Node Version:** 22 (defined in netlify.toml build environment)
**TypeScript:** ^5.3.0 with strict mode enabled

**Required Dependencies to Add:**

- `@axe-core/playwright` - accessibility testing
- `next/bundle-analyzer` - bundle size analysis
- `@lhci/cli` - Lighthouse CI

### Bundle Analyzer Configuration

[Source: Tech stack uses Next.js ^14.2.0 with webpack-based bundling]

**next.config.js Configuration:**
Add the following to enable conditional bundle analysis:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // ... existing config
}

// Enable bundle analyzer when ANALYZE=true
const withBundleAnalyzer = require("@next/bundle-analyzer")({
  enabled: process.env.ANALYZE === "true",
  openAnalyzer: true,
})

module.exports = withBundleAnalyzer(nextConfig)
```

**Package.json Script:**
Add to `apps/web/package.json`:

```json
{
  "scripts": {
    "analyze": "ANALYZE=true next build"
  }
}
```

**Usage:**

```bash
cd apps/web
bun run analyze
```

This will build the app and automatically open the bundle analyzer report in your browser, showing a treemap visualization of bundle contents.

### Performance Optimization Considerations

[Source: docs/architecture/coding-standards.md#performance-standards]

**Frontend Performance:**

- Code splitting with dynamic imports for large components
- React Query for server state management
- Debounce search/autocomplete inputs (300ms)
- Optimize images with Next.js Image component
- Lazy load non-critical assets

**Backend Performance:**

- Database indexes on frequently queried columns
- Pagination for query results
- Selective includes (only fetch needed relations)
- Batch queries where possible

## Change Log

| Date       | Version | Description                                                        | Author           |
| ---------- | ------- | ------------------------------------------------------------------ | ---------------- |
| 2025-10-09 | 1.0     | Initial story draft created                                        | Scrum Master     |
| 2025-10-09 | 1.1     | Added prerequisite tasks, CI workflow details, and config snippets | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
