# Story 4.3: Partner Dashboard

## Status

**Approved**

## Story

**As a** partner,
**I want** a professional dashboard view of my investments,
**so that** I can monitor progress without requesting updates.

## Acceptance Criteria

1. Clean, professional read-only interface
2. Project summary cards with key metrics
3. Cost breakdown by category with visualizations
4. Timeline view of recent activity
5. Document gallery with viewing capability
6. Mobile-responsive design for on-the-go access

## Tasks / Subtasks

### Backend: Dashboard Data API (AC: 2, 3, 4, 5)

- [x] Create partner dashboard tRPC router (AC: 2, 3, 4, 5)
  - [x] Create `apps/web/src/server/api/routers/partnerDashboard.ts`
  - [x] Add `getProjectSummary` query returning project with key metrics
    - [x] Total spent by category (cost breakdown)
    - [x] Recent activity from audit logs (last 30 days)
    - [x] Document count by category
    - [x] Project status and timeline info
  - [x] Add `getCostBreakdown` query for category visualization data
    - [x] Group costs by categoryId with totals
    - [x] Calculate percentage of total spend per category
    - [x] Include category display names from Category system
  - [x] Add `getRecentActivity` query for timeline view
    - [x] Fetch audit logs filtered by project access
    - [x] Include user names, formatted timestamps, and action descriptions
    - [x] Paginated results (default 20, max 50)
  - [x] Add `getDocumentGallery` query for document viewing
    - [x] Fetch documents with thumbnails grouped by category
    - [x] Include file metadata (name, size, upload date, category)
    - [x] Generate signed URLs for secure document access
  - [x] All queries use `verifyProjectAccess()` from authorization.ts for security
  - [x] All queries respect soft-delete filtering (deletedAt IS NULL)

### Frontend: Partner Dashboard Page (AC: 1, 2, 3, 4, 5, 6)

- [ ] Enhance partner dashboard page (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Modify `apps/web/src/app/partner-dashboard/page.tsx` (currently stub)
  - [ ] Use `useAccessibleProjects()` hook from Story 4.2 to get assigned projects
  - [ ] Display project list with permission badges (reuse from Story 4.2)
  - [ ] Add project selection mechanism (dropdown or card grid)
  - [ ] Implement responsive layout (mobile-first, adapts for tablet/desktop)
  - [ ] Show "Partner View" indicator in header
  - [ ] Empty state: "You haven't been invited to any projects yet"

- [ ] Create project summary cards component (AC: 2)
  - [ ] Create `apps/web/src/components/partner/ProjectSummaryCard.tsx`
  - [ ] Display key metrics: total spent, document count, recent activity count
  - [ ] Show project status badge (active/on-hold/completed)
  - [ ] Include project address and start/end dates
  - [ ] Use Shadcn/ui Card component for consistent styling
  - [ ] Responsive layout: full-width on mobile, grid on desktop

- [ ] Create cost breakdown visualization (AC: 3)
  - [ ] Create `apps/web/src/components/partner/CostBreakdown.tsx`
  - [ ] Display category breakdown in both chart and table formats
  - [ ] Use Chart.js or Recharts for pie/donut chart visualization
  - [ ] Show category name, total amount, and percentage of total
  - [ ] Animated transitions using Framer Motion
  - [ ] Format currency values consistently (AUD with cents)
  - [ ] Responsive: chart above table on mobile, side-by-side on desktop

- [ ] Create timeline/activity feed component (AC: 4)
  - [ ] Create `apps/web/src/components/partner/ActivityTimeline.tsx`
  - [ ] Display audit log entries with formatted messages
  - [ ] Group by date (Today, Yesterday, This Week, Older)
  - [ ] Show user avatar/initials, action description, and timestamp
  - [ ] Include action icons (cost added, document uploaded, etc.)
  - [ ] Implement infinite scroll or pagination for older entries
  - [ ] Empty state: "No recent activity"

- [ ] Create document gallery component (AC: 5)
  - [ ] Create `apps/web/src/components/partner/DocumentGallery.tsx`
  - [ ] Display documents grouped by category (Photos, Receipts, Contracts, etc.)
  - [ ] Show thumbnail for images, icon for other file types
  - [ ] Display file name, size, and upload date
  - [ ] Click to open full-size view (lightbox for images, download for others)
  - [ ] Filter by category using Shadcn/ui tabs or dropdown
  - [ ] Grid layout: 2 columns on mobile, 3-4 on tablet, 4-6 on desktop
  - [ ] Empty state: "No documents uploaded yet"

- [ ] Ensure mobile-responsive design (AC: 6)
  - [ ] Test all components at 375px (mobile), 768px (tablet), 1024px (desktop)
  - [ ] Use Tailwind responsive breakpoints (sm:, md:, lg:)
  - [ ] Touch targets minimum 44x44px
  - [ ] Optimize chart interactions for touch (larger hit areas)
  - [ ] Test scrolling performance with large datasets

### Testing (All ACs)

- [ ] Write backend tRPC router tests
  - [ ] Test `getProjectSummary` returns correct metrics for accessible project
  - [ ] Test `getCostBreakdown` groups costs correctly by category
  - [ ] Test `getRecentActivity` returns paginated audit logs
  - [ ] Test `getDocumentGallery` returns documents with signed URLs
  - [ ] Test partner can only access assigned projects (FORBIDDEN for others)
  - [ ] Test admin can access all owned project data
  - [ ] Test soft-deleted entities are excluded from results

- [ ] Write frontend component tests
  - [ ] Test `ProjectSummaryCard` displays metrics correctly
  - [ ] Test `CostBreakdown` renders chart and table
  - [ ] Test `ActivityTimeline` displays formatted audit log entries
  - [ ] Test `DocumentGallery` displays documents grouped by category
  - [ ] Test partner dashboard page shows accessible projects only
  - [ ] Test empty states render correctly when no data
  - [ ] Test responsive layouts at different breakpoints

- [ ] Write integration/E2E tests
  - [ ] Test full partner login → dashboard → project selection → view data flow
  - [ ] Test cost breakdown chart interaction
  - [ ] Test document gallery click to view
  - [ ] Test activity timeline pagination
  - [ ] Test mobile responsive behavior (touch interactions)

## Dev Notes

### Previous Story Insights

Story 4.2 successfully implemented RBAC infrastructure with comprehensive hooks and components:

- **Role Hooks Available**: `useUserRole()`, `useProjectPermission()`, `useAccessibleProjects()` [Source: 4.2.story.md, File List]
- **Permission Components**: `RoleGate`, `PermissionGate`, `PermissionBadge` [Source: 4.2.story.md, File List]
- **Authorization Helpers**: `verifyProjectAccess()`, `getAccessibleProjects()` in `authorization.ts` [Source: 4.2.story.md, Dev Notes]
- **Audit Logging**: `logAccessAttempt()` and `auditLog.listAccessAttempts` query available [Source: 4.2.story.md, Dev Notes]
- **Partner Dashboard Stub**: Basic `/partner-dashboard/page.tsx` exists showing project list [Source: 4.2.story.md, Dev Notes]

**Key Patterns to Reuse:**

- Use `useAccessibleProjects()` hook to fetch projects with permission metadata
- Use `PermissionBadge` component to show read/write indicators
- Use `verifyProjectAccess()` helper in all tRPC queries
- Use audit log queries for activity timeline data
- Test with `createTestContext({ role: "partner" })` for backend tests

**Deferred UI Integration from Story 4.2:**

Tasks 92-99 from Story 4.2 were deferred to this story. However, Story 4.3 focuses on the Partner Dashboard specifically. General UI integration (hiding edit buttons, disabling forms) should be handled separately or in Story 4.5+ if needed.

### Architecture Context

#### Partner Dashboard Component Specification [Source: components.md#PartnerDashboard]

```typescript
interface PartnerDashboardProps {
  projectId: string
  lastViewedAt?: Date
}

interface PartnerMetrics {
  totalSpent: number
  budgetRemaining: number
  categoryBreakdown: CategoryTotal[]
  recentUpdates: AuditLog[]
}
```

**Responsibility:** Professional read-only interface for partners with real-time updates and activity highlights

**Technology Stack:** Role-based component rendering, animated charts with Framer Motion, automatic refresh via React Query

**Implementation Notes:**

- This story implements the full-featured Partner Dashboard (Story 4.2 only created a stub)
- Use React Query for data fetching with automatic background refetching (staleTime: 2min)
- Use Framer Motion for smooth chart animations and transitions
- Implement loading skeletons for all dashboard sections
- Use Chart.js or Recharts for cost breakdown visualizations

#### Data Models [Source: data-models.md]

**Project Interface:**

```typescript
interface Project extends BaseEntity {
  name: string
  description: string | null
  address: Address
  projectType: ProjectType
  status: "active" | "on-hold" | "completed"
  startDate: Date
  endDate: Date | null
  ownerId: string
  totalBudget: number | null
}
```

**Cost Interface:**

```typescript
interface Cost extends BaseEntity {
  projectId: string
  amount: number // in cents
  description: string
  categoryId: string // References Category.id
  date: Date
  contactId: string | null
  createdById: string
}
```

**Document Interface:**

```typescript
interface Document extends BaseEntity {
  projectId: string
  fileName: string
  fileSize: number
  mimeType: string
  blobUrl: string
  thumbnailUrl: string | null
  categoryId: string // References Category.id
  uploadedById: string
}
```

**AuditLog Interface:**

```typescript
interface AuditLog {
  id: string
  projectId: string
  userId: string
  action: AuditAction
  entityType: EntityType
  entityId: string
  changes: Record<string, any> | null
  metadata: AuditMetadata | null
  createdAt: Date
}

interface AuditMetadata {
  displayName?: string // Human-readable description
  amount?: number // For cost-related actions
  fileName?: string // For document uploads
  relatedEntities?: Array<{ type: string; id: string; name: string }>
}
```

**Category System:**

- Use predefined category definitions from `CategoryType`
- Cost categories: materials, labor, permits, professional
- Document categories: photo, receipt, contract, permit
- Event categories: milestone, meeting, inspection
- Helper: `getCategoriesByType(type: CategoryType)` to filter categories

#### File Locations [Source: unified-project-structure.md]

**Backend Files:**

```
apps/web/src/server/
├── api/
│   ├── routers/
│   │   └── partnerDashboard.ts        # CREATE: Partner dashboard queries
│   └── __tests__/
│       └── partner-dashboard.test.ts  # CREATE: Router tests
```

**Frontend Files:**

```
apps/web/src/
├── app/
│   └── partner-dashboard/
│       └── page.tsx                   # MODIFY: Enhance stub with full dashboard
├── components/
│   └── partner/                       # CREATE: Partner-specific components
│       ├── ProjectSummaryCard.tsx
│       ├── CostBreakdown.tsx
│       ├── ActivityTimeline.tsx
│       ├── DocumentGallery.tsx
│       └── __tests__/                 # CREATE: Component tests
│           ├── ProjectSummaryCard.test.tsx
│           ├── CostBreakdown.test.tsx
│           ├── ActivityTimeline.test.tsx
│           └── DocumentGallery.test.tsx
```

#### Technology Stack [Source: tech-stack.md]

**Frontend:**

- Next.js 14.2.0 with App Router
- TypeScript 5.3.0 for type safety
- Shadcn/ui 0.8.0 for UI components (Card, Tabs, Badge, etc.)
- React Query (TanStack Query) 5.0.0 for data fetching
- Chart.js or Recharts for visualizations
- Framer Motion for animations
- Tailwind CSS 3.4.0 for styling

**Backend:**

- tRPC 10.45.0 for type-safe API
- Drizzle ORM 0.44.6 for database queries
- Zod 3.22.0 for input validation
- Neon PostgreSQL 1.0.2 database
- Netlify Blobs for document storage

**Testing:**

- Vitest 1.6.0 + Testing Library 14.0.0 for frontend tests
- Vitest 1.6.0 for backend tests
- Playwright 1.40.0 for E2E tests

#### UI/UX Standards [Source: coding-standards.md#UI/UX Standards]

**Responsive Design:**

- Design mobile-first, starting at 375px width minimum
- Test at: 375px (mobile), 768px (tablet), 1024px (desktop)
- Use Tailwind's mobile-first breakpoints (sm:, md:, lg:, xl:)
- All touch targets minimum 44x44px for mobile usability

**Loading States:**

```typescript
// Show skeleton components during initial load
if (isLoading) {
  return <DashboardSkeleton />
}

// Empty state with clear CTA
if (data?.projects.length === 0) {
  return (
    <EmptyState
      title="No projects yet"
      description="You haven't been invited to any projects"
    />
  )
}

// Error state with retry option
if (isError) {
  return <ErrorState message="Failed to load dashboard" action={<Button onClick={refetch}>Try Again</Button>} />
}
```

**Component Patterns:**

- Always use Shadcn/ui components for consistency
- Use React Hook Form + Zod for any forms (though dashboard is read-only)
- Implement proper loading, empty, and error states
- Use optimistic updates where applicable (not needed for read-only dashboard)

**Accessibility (WCAG AA):**

- Semantic HTML elements (nav, main, article, section)
- Proper ARIA labels for icons and charts
- Keyboard navigation support (Tab, Enter, Escape)
- Screen reader support for chart data (provide table alternative)
- Color contrast ratios 4.5:1 for text
- Support prefers-reduced-motion for animations

#### Security Considerations [Source: coding-standards.md#Security Standards]

**Access Control:**

- All dashboard queries must use `verifyProjectAccess()` helper
- Never trust client-provided user IDs - use `ctx.user.id` from session
- Partners can only access projects they're assigned to via ProjectAccess table
- Verify `acceptedAt IS NOT NULL` to prevent pending invitations from granting access

**Input Validation:**

- Zod schemas for all tRPC procedure inputs
- Validate projectId is UUID format
- Validate pagination parameters (limit: 1-50, offset: >= 0)

**Document Access:**

- Generate signed URLs for document access (security via Netlify Blobs)
- Set appropriate expiry times for signed URLs (e.g., 1 hour)
- Never expose raw blob URLs without access verification

#### Performance Considerations [Source: coding-standards.md#Performance Standards]

**Data Fetching:**

- Use React Query for server state management
- Configure appropriate cache times:
  - Project summary: staleTime 2min, cacheTime 5min
  - Cost breakdown: staleTime 1min, cacheTime 3min
  - Activity feed: staleTime 30sec, cacheTime 2min
  - Document gallery: staleTime 5min, cacheTime 10min
- Prefetch data for predictable navigation
- Debounce search/filter inputs (300ms)

**Database Optimization:**

- Use selective includes (only fetch needed relations)
- Limit query results with pagination
- Use indexes on frequently queried columns (projectId, categoryId, date)
- Batch queries where possible (combine cost totals with category names in single query)

**Frontend Performance:**

- Lazy load chart library (dynamic import)
- Virtualize large lists if needed (e.g., document gallery with 100+ items)
- Optimize images (use Next.js Image component for thumbnails)
- Code splitting for partner-specific components

### Testing

**Backend Tests [Source: testing-strategy.md, coding-standards.md#Testing Standards]:**

- Test location: `apps/web/src/server/__tests__/partner-dashboard.test.ts`
- Use `createTestContext({ role: "partner" })` to test partner access
- Test all tRPC queries return correct data format
- Test access control: partners cannot access unassigned projects
- Test soft-delete filtering: deleted entities excluded from results
- Test pagination: limit and offset parameters work correctly
- Test empty states: queries return appropriate responses for projects with no data

**Frontend Tests [Source: testing-strategy.md, coding-standards.md#Testing Standards]:**

- Test location: Co-located with components in `__tests__/` subfolders
- Test all components render correctly with valid data
- Test loading states display skeletons
- Test empty states display appropriate messages
- Test error states display error messages with retry button
- Test responsive layouts at different breakpoints
- Test chart renders correctly with cost breakdown data
- Test activity timeline groups entries by date
- Test document gallery filters by category

**Integration/E2E Tests:**

- Test location: `apps/web/e2e/tests/partner-dashboard.spec.ts`
- Test full partner login → dashboard → project selection → view data flow
- Test chart interactions (hover, click)
- Test document gallery click to view full-size
- Test activity timeline pagination/infinite scroll
- Test mobile responsive behavior (touch interactions)

**Test Pattern Examples:**

```typescript
// Backend test
test("partner can view assigned project summary", async () => {
  const ctx = await createTestContext({ role: "partner" })
  const caller = appRouter.createCaller(ctx)

  // Create project and grant access
  const project = await createProject({ ownerId: "other-user-id" })
  await createProjectAccess({
    projectId: project.id,
    userId: ctx.user.id,
    permission: "read",
    acceptedAt: new Date(),
  })

  const result = await caller.partnerDashboard.getProjectSummary({ projectId: project.id })

  expect(result).toMatchObject({
    project: expect.objectContaining({ id: project.id }),
    totalSpent: expect.any(Number),
    costBreakdown: expect.any(Array),
  })
})

// Frontend test
test("renders project summary card with metrics", () => {
  const mockData = {
    totalSpent: 150000,
    documentCount: 12,
    recentActivityCount: 5,
  }

  render(<ProjectSummaryCard data={mockData} />)

  expect(screen.getByText("$1,500.00")).toBeInTheDocument()
  expect(screen.getByText("12 documents")).toBeInTheDocument()
  expect(screen.getByText("5 recent updates")).toBeInTheDocument()
})
```

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None

### Completion Notes List

**Phase 1: Backend API Implementation (Completed)**

- Created complete partner dashboard tRPC router with 4 queries
- Enhanced audit log schema with projectId and createdAt for activity tracking
- All queries implement proper access control via verifyProjectAccess()
- All queries respect soft-delete filtering
- TypeScript compilation and ESLint validation passing

**Audit Log Schema Enhancement:**

- Added `projectId` column with foreign key to projects table
- Added `createdAt` column for timeline queries
- Created indexes for performance (project_id_idx, created_at_idx)
- Migration 0006 created and ready for deployment

**Known Limitations:**

- Frontend components not yet implemented (deferred to next session)
- Backend tests created but have some edge case failures (categories seed data related)
- Activity timeline depends on migration 0006 being applied to production database

**Phase 2: Frontend Implementation (Deferred)**

- Partner dashboard page enhancement
- ProjectSummaryCard component
- CostBreakdown visualization component
- ActivityTimeline component
- DocumentGallery component
- Mobile-responsive design validation
- Frontend component tests
- Integration/E2E tests

### File List

**Backend Files Created:**

- `apps/web/src/server/api/routers/partnerDashboard.ts` - Partner dashboard tRPC router with 4 queries
- `apps/web/drizzle/0006_add_project_tracking_to_audit_log.sql` - Database migration for audit log enhancement
- `apps/web/src/server/__tests__/partner-dashboard.test.ts` - Backend tests for dashboard queries

**Backend Files Modified:**

- `apps/web/src/server/api/root.ts` - Added partnerDashboardRouter to app router
- `apps/web/src/server/db/schema/auditLog.ts` - Enhanced with projectId and createdAt fields
- `apps/web/drizzle/meta/_journal.json` - Added migration 0006 entry

**Frontend Files (Deferred):**

- Partner dashboard page: `apps/web/src/app/partner-dashboard/page.tsx` (to be enhanced)
- Components folder: `apps/web/src/components/partner/` (to be created)

## QA Results

(To be populated by QA Agent)

## Change Log

| Date       | Version | Description                                                                      | Author   |
| ---------- | ------- | -------------------------------------------------------------------------------- | -------- |
| 2025-10-27 | 1.0     | Initial story draft with comprehensive dashboard requirements                    | Bob (SM) |
| 2025-10-27 | 1.1     | Status updated to Approved - story ready for implementation (Checklist: PASS ✅) | Bob (SM) |
