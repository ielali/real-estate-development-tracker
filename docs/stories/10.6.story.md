# Story 10.6: Swipeable Navigation Drawer - Brownfield Addition

## Status

**Current Status:** Approved

## User Story

As a **mobile user**,
I want **to swipe to access additional navigation**,
So that **I can reach all features without cluttering the screen**.

## Story Context

**Existing System Integration:**

- Integrates with: Current mobile menu and navigation structure from Epic 5
- Technology: Next.js 14, React, Framer Motion or react-spring, @use-gesture/react
- Follows pattern: Existing mobile navigation hierarchy and user authentication display
- Touch points: Mobile layout, gesture detection, navigation menu items, user profile section

## Acceptance Criteria

**Functional Requirements:**

1. Swipe from left edge (20px hot zone) to open drawer
2. Swipe left on drawer to close
3. Maximum width 320px or 85% of screen width (whichever is smaller)

**Integration Requirements:** 4. User profile section displayed at top (if authenticated) 5. All desktop navigation items available in drawer 6. Maintains existing navigation hierarchy and permissions

**Quality Requirements:** 7. Smooth spring animations for open/close 8. Backdrop overlay (40% opacity) when open 9. Focus trap activated when drawer is open

## Tasks / Subtasks

### Phase 1: Preparation & Analysis

- [ ] Task 1: Analyze current mobile navigation (AC: 4,5,6)
  - [ ] Review existing mobile menu structure from Epic 5
  - [ ] Document current navigation hierarchy and items
  - [ ] Identify authentication/user profile display pattern
  - [ ] Map all navigation items to be included in drawer
  - [ ] Create list of components to be modified

### Phase 2: Gesture Library Setup

- [ ] Task 2: Install and configure gesture handling (AC: 1,2)
  - [ ] Install @use-gesture/react package (npm install)
  - [ ] Install react-spring for animations (if not already present)
  - [ ] Configure TypeScript types for gesture handlers
  - [ ] Test basic gesture detection in isolated component
  - [ ] Verify no conflicts with existing touch handlers

### Phase 3: Drawer Component Implementation

- [ ] Task 3: Create swipeable drawer component (AC: 1,2,3,7)
  - [ ] Create `SwipeableDrawer.tsx` component
  - [ ] Implement useDrag hook for swipe detection
  - [ ] Set up 20px left edge hot zone for swipe trigger
  - [ ] Configure maximum width (320px or 85vw, whichever is smaller)
  - [ ] Implement spring animation for open/close transitions
  - [ ] Add velocity-based swipe detection (threshold: 0.2)
  - [ ] Add distance-based trigger (50% of drawer width)
  - [ ] Test drawer opens on left edge swipe
  - [ ] Test drawer closes on swipe left

### Phase 4: User Profile Section

- [ ] Task 4: Implement profile header in drawer (AC: 4)
  - [ ] Create drawer header component with user info
  - [ ] Display user avatar, name, and email if authenticated
  - [ ] Handle unauthenticated state (show login prompt)
  - [ ] Style header to match existing user profile displays
  - [ ] Test with authenticated and non-authenticated users
  - [ ] Ensure proper spacing and visual hierarchy

### Phase 5: Navigation Items Integration

- [ ] Task 5: Populate drawer with navigation items (AC: 5,6)
  - [ ] Import all navigation items from existing menu structure
  - [ ] Maintain navigation hierarchy (sections, subsections)
  - [ ] Implement permission-based visibility for menu items
  - [ ] Add icons matching desktop navigation
  - [ ] Add active state highlighting for current page
  - [ ] Test all navigation links work correctly
  - [ ] Verify role-based menu item visibility

### Phase 6: Backdrop and Focus Management

- [ ] Task 6: Implement backdrop overlay (AC: 8)
  - [ ] Create backdrop component with 40% opacity
  - [ ] Add click handler to close drawer
  - [ ] Animate backdrop fade in/out with drawer
  - [ ] Ensure proper z-index layering
  - [ ] Test backdrop click closes drawer

- [ ] Task 7: Implement focus trap (AC: 9)
  - [ ] Install focus-trap-react or implement custom solution
  - [ ] Activate focus trap when drawer opens
  - [ ] Deactivate focus trap when drawer closes
  - [ ] Test keyboard navigation stays within drawer
  - [ ] Ensure Escape key closes drawer
  - [ ] Test Tab key cycles through drawer elements only

### Phase 7: Conflict Prevention & Edge Cases

- [ ] Task 8: Handle gesture conflicts (Risk mitigation)
  - [ ] Detect horizontal scroll containers on page
  - [ ] Disable drawer swipe when horizontal scrolling detected
  - [ ] Test with carousel/slider components
  - [ ] Add option to temporarily disable drawer gesture
  - [ ] Handle drawer state during page navigation
  - [ ] Test pull-to-refresh compatibility (if implemented)

### Phase 8: Mobile Layout Integration

- [ ] Task 9: Integrate with mobile layout (AC: 1-9)
  - [ ] Add drawer to mobile layout wrapper component
  - [ ] Ensure drawer only renders on mobile viewport
  - [ ] Test integration with bottom tab navigation (Story 10.5)
  - [ ] Verify no z-index conflicts with modals
  - [ ] Test drawer behavior during modal display
  - [ ] Handle iOS safe area insets (notch/dynamic island)

### Phase 9: Performance Optimization

- [ ] Task 10: Optimize gesture performance (AC: 7)
  - [ ] Use passive event listeners for scroll events
  - [ ] Implement requestAnimationFrame for smooth animations
  - [ ] Test on low-end Android devices
  - [ ] Ensure 60fps during swipe gestures
  - [ ] Profile performance with Chrome DevTools
  - [ ] Optimize re-renders during drawer animation

### Phase 10: Testing & Refinement

- [ ] Task 11: Comprehensive testing (AC: 1-9)
  - [ ] Test on iOS Safari (various iPhone models)
  - [ ] Test on Android Chrome (various devices)
  - [ ] Test with screen readers (VoiceOver, TalkBack)
  - [ ] Test keyboard navigation and focus management
  - [ ] Test swipe sensitivity on different screen sizes
  - [ ] Verify smooth animations at 60fps
  - [ ] Test with bottom tab navigation from Story 10.5
  - [ ] Document any device-specific quirks

- [ ] Task 12: Documentation and completion
  - [ ] Document gesture configuration in code comments
  - [ ] Update component documentation
  - [ ] Create usage examples for other developers
  - [ ] Update story status to "Done"
  - [ ] Update Dev Agent Record with completion notes
  - [ ] Create demo video or GIF for PR

## Dev Notes

### Integration Approach

Add gesture-enabled drawer that complements bottom tab navigation. Implement using @use-gesture/react and Framer Motion/react-spring for smooth animations.

### Existing Pattern Reference

Use existing navigation menu structure from Epic 5, add swipe gesture layer without modifying menu hierarchy.

### Key Constraints

- Must not interfere with page content gestures (horizontal scrolling, carousels)
- Preserve all menu hierarchy and permission-based visibility
- Drawer must be mobile-only (hidden on desktop)
- Must work alongside bottom tab navigation from Story 10.5

### Implementation Details

```typescript
// Swipe gesture configuration
import { useDrag } from "@use-gesture/react"
import { useSpring, animated } from "react-spring"

const bind = useDrag(({ down, movement: [mx], velocity: [vx] }) => {
  const trigger = vx > 0.2 || Math.abs(mx) > width / 2
  if (!down && trigger) {
    setOpen(mx > 0)
  }
})

// Alternative: Framer Motion variant
const drawerVariants = {
  open: { x: 0, transition: { type: "spring", stiffness: 300, damping: 30 } },
  closed: { x: "-100%", transition: { type: "spring", stiffness: 300, damping: 30 } },
}

// Drawer component structure
const drawerClassName = cn(
  "fixed top-0 left-0 h-full z-50",
  "w-80 max-w-[85vw]",
  "bg-background shadow-lg",
  "md:hidden" // mobile only
)

// Hot zone detection
const hotZoneWidth = 20 // pixels from left edge

// Backdrop overlay
const backdropClassName = cn("fixed inset-0 bg-black/40 z-40", "md:hidden")
```

### Testing Standards

- Test on iOS Safari and Android Chrome
- Verify 60fps performance during animations
- Test with VoiceOver and TalkBack screen readers
- Use React DevTools Profiler for performance testing
- Manual testing required for gesture sensitivity
- Test files location: `__tests__/components/navigation/SwipeableDrawer.test.tsx`

## Definition of Done

- [ ] Swipe gesture opens drawer from left edge (20px hot zone)
- [ ] Swipe to close functionality works
- [ ] User profile section displays at top
- [ ] All navigation items accessible in drawer
- [ ] Spring animations smooth (60fps)
- [ ] Backdrop overlay functions correctly (40% opacity)
- [ ] Focus trap prevents background interaction
- [ ] No interference with horizontal scroll elements
- [ ] Works alongside bottom tab navigation
- [ ] Keyboard navigation works (Tab, Escape)
- [ ] Screen reader accessible
- [ ] Code follows existing patterns
- [ ] Tests pass
- [ ] PR created with demo
- [ ] Code reviewed and approved
- [ ] Story status updated to "Done"

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Gesture conflicts with horizontal scrolling or carousel components
- **Mitigation:** Limit hot zone to edge, disable when horizontal scroll detected
- **Rollback:** Disable gesture handler, keep drawer accessible via menu button

**Compatibility Verification:**

- [ ] No interference with existing touch interactions
- [ ] Works alongside bottom tab navigation
- [ ] All navigation paths remain functional
- [ ] Performance smooth on low-end devices
- [ ] No conflicts with modals or overlays
- [ ] Pull-to-refresh compatibility maintained

## Validation Checklist

**Scope Validation:**

- [x] Story can be completed in one development session (4 hours)
- [x] Integration approach is straightforward (add gesture layer)
- [x] Follows existing mobile patterns
- [x] No backend changes required

**Clarity Check:**

- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified (mobile layout, navigation)
- [x] Success criteria are testable (gesture testing)
- [x] Rollback approach is simple (disable gestures)

---

## Change Log

| Date         | Version | Description                                   | Author       |
| ------------ | ------- | --------------------------------------------- | ------------ |
| Nov 2024     | 1.0     | Initial story creation from Epic 10           | Product Team |
| Nov 10, 2024 | 1.1     | Added Tasks/Subtasks and all missing sections | Product Team |
| Nov 10, 2024 | 1.2     | Story approved for development                | Product Team |

---

## Dev Agent Record

### Agent Model Used

_To be populated during implementation_

### Debug Log References

_To be populated during implementation_

### Completion Notes List

_To be populated during implementation_

### File List

**Expected files to be modified/created:**

- `components/navigation/SwipeableDrawer.tsx` (new)
- `components/navigation/DrawerHeader.tsx` (new)
- `components/layout/MobileLayout.tsx` (modified)
- `hooks/useSwipeGesture.ts` (new, optional)
- `package.json` (dependencies)

_Additional files to be documented during implementation_

---

## QA Results

_To be populated after QA review_

---

**Story Status:** Approved
**Estimated Effort:** 4 hours
**Dependencies:** Story 10.5 (works alongside bottom tabs)
**Feature Flag:** mobile_drawer_gestures_enabled
**Epic:** EPIC-10 - Modern Navigation & Design System Overhaul
**Created:** November 2024
**Last Updated:** November 10, 2024
