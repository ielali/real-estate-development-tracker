# Story 10.12: Layout Integration - Two-Tier Header System

## Status

**Current Status:** todo

## User Story

As a **user**,
I want **seamless integration between global and contextual navigation**,
So that **the interface feels cohesive and space is used efficiently**.

## Story Context

**Existing System Integration:**

- Integrates with: Stories 10.10 (TopHeaderBar), 10.11 (Enhanced Sidebar), 10.9 (ContentWrapper)
- Technology: React, Next.js 15 layouts, Framer Motion
- Follows pattern: Adjust existing layout components for two-tier header
- Touch points: Root layout, ContentWrapper, HorizontalNav, project layout
- Reference: `docs/design/NAVIGATION_GAP_ANALYSIS.md` - Layout & Spacing section

**Design Requirements:**

Two-tier header system:

1. **Global header** (TopHeaderBar) - Always visible, fixed at top
2. **Contextual navigation** (HorizontalNav) - Below global header on specific pages

Content must:

- Start below global header (64px offset)
- Expand/contract with sidebar collapse
- Handle nested navigation correctly
- Work on mobile and desktop

## Acceptance Criteria

**Functional Requirements:**

1. Global TopHeaderBar fixed at top of all pages
2. ContentWrapper adjusts margin-left for sidebar AND margin-top for header
3. HorizontalNav appears below TopHeaderBar on project pages
4. No layout overlap between headers and content
5. Sidebar collapse/expand affects ContentWrapper margin-left

**Integration Requirements:**

6. Root layout includes TopHeaderBar in correct z-index order
7. ContentWrapper animation accounts for both sidebar and header
8. Project layout positions HorizontalNav correctly
9. Mobile behavior: TopHeaderBar adapts, bottom tabs unaffected

**Quality Requirements:**

10. Smooth transitions when sidebar collapses (200ms)
11. No content shift or flicker during animations
12. No horizontal scroll on any screen size
13. Consistent spacing follows 4px/8px grid

## Tasks / Subtasks

### Phase 1: Update ContentWrapper

- [ ] Task 1: Enhance ContentWrapper for two-tier layout (AC: 2,5,10)
  - [ ] Read existing `components/layout/ContentWrapper.tsx`
  - [ ] Add padding-top for header height (pt-16 = 64px)
  - [ ] Keep existing margin-left animation (256px ↔ 64px)
  - [ ] Update animation variants to include padding
  - [ ] Test sidebar collapse with new padding
  - [ ] Verify no layout shift

### Phase 2: Update Root Layout

- [ ] Task 2: Integrate TopHeaderBar into root layout (AC: 1,6)
  - [ ] Read existing `app/layout.tsx`
  - [ ] Add TopHeaderBar import
  - [ ] Position TopHeaderBar after Sidebar, before ContentWrapper
  - [ ] Verify z-index layering:
    - Sidebar: z-40
    - TopHeaderBar: z-30
    - HorizontalNav: z-20
    - Modal overlays: z-50
  - [ ] Test on dashboard page
  - [ ] Test on auth pages (login, register)

### Phase 3: Adjust TopHeaderBar Positioning

- [ ] Task 3: Update TopHeaderBar for sidebar integration (AC: 1,7)
  - [ ] Read TopHeaderBar component
  - [ ] Update fixed positioning: `left-0 md:left-64`
  - [ ] Adjust on sidebar collapse: transition left property
  - [ ] Connect to sidebar collapsed state (useCollapsedSidebar hook)
  - [ ] Animate left position when sidebar collapses (left-64 → left-16)
  - [ ] Test header width changes smoothly

### Phase 4: Update Project Layout

- [ ] Task 4: Position HorizontalNav below TopHeaderBar (AC: 3,8)
  - [ ] Read `app/projects/[id]/layout.tsx`
  - [ ] Update container height calculation: `h-[calc(100vh-8rem)]`
    - 100vh - 64px (TopHeaderBar) - 64px (HorizontalNav) - mobile safe area
  - [ ] Verify HorizontalNav sticky positioning
  - [ ] Test scroll behavior (HorizontalNav stays, content scrolls)
  - [ ] Test on mobile (adjust for bottom tabs)

### Phase 5: Mobile Responsiveness

- [ ] Task 5: Ensure mobile layout works correctly (AC: 9)
  - [ ] Test TopHeaderBar on mobile (< 768px)
  - [ ] Verify sidebar hidden on mobile
  - [ ] Verify TopHeaderBar at left: 0 (no sidebar offset)
  - [ ] Test with BottomTabBar (no overlap)
  - [ ] Test with MobileNavigation drawer
  - [ ] Adjust ContentWrapper padding for mobile

### Phase 6: Animation Coordination

- [ ] Task 6: Coordinate all layout animations (AC: 10,11)
  - [ ] Ensure sidebar, header, and content animate together
  - [ ] Use consistent duration (200ms) and easing
  - [ ] Test rapid collapse/expand (no jank)
  - [ ] Verify no content shift during animation
  - [ ] Check for any flicker or reflow

### Phase 7: Spacing & Overflow

- [ ] Task 7: Verify spacing and prevent overflow (AC: 12,13)
  - [ ] Audit all page containers for proper spacing
  - [ ] Check padding follows 4px/8px grid
  - [ ] Test on various screen sizes (320px to 2560px)
  - [ ] Verify no horizontal scroll
  - [ ] Check for any overflow issues
  - [ ] Test on different zoom levels (100%, 150%, 200%)

### Phase 8: Cross-Page Testing

- [ ] Task 8: Test on all page types (AC: 1,2,3,4)
  - [ ] Test dashboard page (no nested nav)
  - [ ] Test project list page (no nested nav)
  - [ ] Test project detail pages (with HorizontalNav)
  - [ ] Test settings pages (with nested sidebar)
  - [ ] Test auth pages (login, register)
  - [ ] Test admin pages
  - [ ] Document any edge cases

### Phase 9: Documentation

- [ ] Task 9: Update documentation
  - [ ] Document two-tier header architecture
  - [ ] Update layout diagram in docs
  - [ ] Add usage guidelines for new pages
  - [ ] Document z-index layering system
  - [ ] Add troubleshooting guide

## Dev Notes

### Implementation Approach

Update existing layout components to work together:

1. **TopHeaderBar:** Fixed at top, adjusts left offset for sidebar
2. **ContentWrapper:** Adds top padding for header, keeps sidebar margin
3. **HorizontalNav:** Positions below TopHeaderBar on project pages
4. **Sidebar:** No changes needed (already fixed)

### Key Layout Structure

```
Desktop:
┌─────────┬───────────────────────────────────────────┐
│         │ TopHeaderBar (z-30, fixed)               │
│ Sidebar ├───────────────────────────────────────────┤
│ (z-40,  │ HorizontalNav (z-20, sticky) - Optional  │
│ fixed)  ├───────────────────────────────────────────┤
│         │                                           │
│         │ Content (scrollable)                      │
│         │                                           │
└─────────┴───────────────────────────────────────────┘

Mobile:
┌───────────────────────────────────────────────┐
│ TopHeaderBar (z-30, fixed, full width)        │
├───────────────────────────────────────────────┤
│ HorizontalNav (z-20, sticky) - Optional       │
├───────────────────────────────────────────────┤
│                                               │
│ Content (scrollable)                          │
│                                               │
├───────────────────────────────────────────────┤
│ BottomTabBar (z-30, fixed)                    │
└───────────────────────────────────────────────┘
```

### Implementation Details

```typescript
// components/layout/ContentWrapper.tsx (updated)
"use client"

import { ReactNode } from "react"
import { motion } from "framer-motion"
import { useCollapsedSidebar } from "@/hooks/useCollapsedSidebar"
import { useViewport } from "@/hooks/useViewport"

const contentVariants = {
  expanded: {
    marginLeft: 256, // Sidebar expanded
  },
  collapsed: {
    marginLeft: 64, // Sidebar collapsed
  },
}

export function ContentWrapper({ children }: { children: ReactNode }) {
  const { isCollapsed } = useCollapsedSidebar()
  const { isMobile } = useViewport()

  return (
    <motion.div
      initial={false}
      animate={isMobile ? false : isCollapsed ? "collapsed" : "expanded"}
      variants={contentVariants}
      transition={{ duration: 0.2, ease: [0.4, 0, 0.2, 1] }}
      className="min-h-screen pt-16"  // ← Add pt-16 for header
      style={isMobile ? { marginLeft: 0 } : undefined}
    >
      {children}
    </motion.div>
  )
}
```

```typescript
// components/layout/TopHeaderBar.tsx (updated)
"use client"

import { useCollapsedSidebar } from "@/hooks/useCollapsedSidebar"
import { useViewport } from "@/hooks/useViewport"
import { motion } from "framer-motion"

const headerVariants = {
  expanded: {
    left: 256, // Sidebar expanded
  },
  collapsed: {
    left: 64, // Sidebar collapsed
  },
}

export function TopHeaderBar({ ... }: TopHeaderBarProps) {
  const { isCollapsed } = useCollapsedSidebar()
  const { isMobile } = useViewport()

  return (
    <motion.header
      initial={false}
      animate={isMobile ? false : isCollapsed ? "collapsed" : "expanded"}
      variants={headerVariants}
      transition={{ duration: 0.2, ease: [0.4, 0, 0.2, 1] }}
      className="fixed top-0 right-0 h-16 bg-background border-b z-30"
      style={isMobile ? { left: 0 } : undefined}
    >
      {/* Header content */}
    </motion.header>
  )
}
```

```typescript
// app/projects/[id]/layout.tsx (updated)
"use client"

export default function ProjectDetailLayout({ children }: { children: React.ReactNode }) {
  // ...existing code...

  return (
    <div className="flex flex-col min-h-screen">
      {/* HorizontalNav - Sticky below TopHeaderBar */}
      {projectId && (
        <div className="sticky top-16 z-20 bg-background border-b">
          <HorizontalNav projectId={projectId} isPartner={isPartner} />
        </div>
      )}

      {/* Main Content Area - Scrollable */}
      <main className="flex-1 overflow-auto pb-20 md:pb-0">
        {children}
      </main>
    </div>
  )
}
```

### Z-Index Layering System

```
z-50: Modal overlays, dialogs, dropdowns
z-40: Sidebar (desktop)
z-30: TopHeaderBar, BottomTabBar (mobile)
z-20: HorizontalNav (contextual navigation)
z-10: Floating action buttons, tooltips
z-0:  Page content (default)
```

### Responsive Breakpoints

- **Mobile (< 768px):**
  - Sidebar hidden (drawer instead)
  - TopHeaderBar full width (left: 0)
  - ContentWrapper no left margin
  - BottomTabBar visible

- **Desktop (≥ 768px):**
  - Sidebar visible (fixed)
  - TopHeaderBar offset by sidebar width
  - ContentWrapper has left margin
  - BottomTabBar hidden

### Testing Standards

- Test sidebar collapse/expand animation
- Test header width animation
- Test content reflow
- Test on all page types
- Test mobile responsiveness
- Visual regression tests
- Performance tests (no jank)

## Definition of Done

- [ ] TopHeaderBar integrated into root layout
- [ ] ContentWrapper updated with top padding
- [ ] TopHeaderBar animates with sidebar collapse
- [ ] HorizontalNav positioned correctly on project pages
- [ ] No layout overlap on any page
- [ ] Mobile layout works correctly
- [ ] All animations smooth (200ms, no jank)
- [ ] No horizontal scroll on any screen size
- [ ] Spacing follows 4px/8px grid
- [ ] Z-index layering correct
- [ ] Dashboard page tested
- [ ] Project pages tested
- [ ] Settings pages tested
- [ ] Auth pages tested
- [ ] Documentation updated
- [ ] Tests pass (integration, visual)
- [ ] Build succeeds with no errors
- [ ] TypeScript compilation passes
- [ ] Code reviewed and approved
- [ ] Story status updated to "Done"

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Layout changes may cause content shift or overlap
- **Mitigation:** Incremental testing on each page type, careful z-index management
- **Rollback:** Revert ContentWrapper and layout changes, remove TopHeaderBar

**Compatibility Verification:**

- [ ] No overlap between headers and content
- [ ] Sidebar collapse animation works
- [ ] Mobile navigation unaffected
- [ ] Project subsection navigation works
- [ ] Settings nested navigation works
- [ ] Modal dialogs display correctly
- [ ] Dropdowns don't get cut off

## Validation Checklist

**Scope Validation:**

- [x] Story requires careful integration work (1-2 days)
- [x] Integration approach is straightforward (update existing components)
- [x] Follows existing patterns (animation, responsive design)
- [x] No backend changes required

**Clarity Check:**

- [x] Story requirements are clear (two-tier header system)
- [x] Integration points are well-defined (layout components)
- [x] Success criteria are testable (visual and functional tests)
- [x] Rollback approach exists (revert component changes)

---

## Change Log

| Date         | Version | Description            | Author    |
| ------------ | ------- | ---------------------- | --------- |
| Nov 12, 2025 | 1.0     | Initial story creation | Dev Agent |

---

## Dev Agent Record

_To be populated during implementation_

---

## QA Results

_To be populated after QA review_

---

**Story Status:** Approved
**Estimated Effort:** 1-2 days
**Dependencies:** Stories 10.10 (TopHeaderBar), 10.11 (Enhanced Sidebar), 10.9 (ContentWrapper)
**Epic:** EPIC-10.2 - Design Alignment with Target Specification
**Created:** November 12, 2025
**Last Updated:** November 12, 2025
