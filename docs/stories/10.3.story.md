# Story 10.3: Collapsible Sidebar Navigation - Brownfield Addition

## Status

**Current Status:** Approved

## User Story

As a **desktop user**,
I want **to collapse the sidebar when I need more space**,
So that **I can focus on content without distraction**.

## Story Context

**Existing System Integration:**

- Integrates with: Current fixed sidebar navigation (256px width) from Epic 5
- Technology: Next.js 14, TypeScript, React, Shadcn/ui, Framer Motion
- Follows pattern: Existing sidebar component structure and navigation state management
- Touch points: Main layout wrapper, navigation items, user preference storage

## Acceptance Criteria

**Functional Requirements:**

1. Sidebar toggles between 256px (expanded) and 64px (collapsed) states
2. Toggle button positioned at sidebar bottom or top-right corner
3. Keyboard shortcut implemented (Cmd/Ctrl + B)

**Integration Requirements:** 4. All existing navigation items remain accessible in both states 5. Icons remain visible when collapsed with tooltips showing full labels 6. User preference persisted in localStorage and restored on page load

**Quality Requirements:** 7. Smooth animation (200ms ease-in-out) between states 8. Active navigation state clearly indicated in both modes 9. Content area adjusts smoothly without layout jumps

**Space Optimization:** 10. Achieve 192px horizontal space savings when collapsed

## Tasks / Subtasks

### Phase 1: Current Implementation Analysis

- [ ] Task 1: Analyze existing sidebar implementation (AC: 4,8)
  - [ ] Locate and review current sidebar component file(s)
  - [ ] Document current navigation state management
  - [ ] Identify all navigation items and their icon requirements
  - [ ] Map current active state indication method
  - [ ] Review current layout wrapper implementation
  - [ ] Document current width constraints and breakpoints

### Phase 2: State Management Setup

- [ ] Task 2: Implement collapse state management (AC: 6)
  - [ ] Create collapse state hook (useCollapsedSidebar)
  - [ ] Implement localStorage persistence logic
  - [ ] Add state to navigation context/provider
  - [ ] Create toggle handler function
  - [ ] Implement state restoration on mount
  - [ ] Add SSR-safe localStorage checks

### Phase 3: Sidebar Component Enhancement

- [ ] Task 3: Modify sidebar component structure (AC: 1,4,5)
  - [ ] Add collapse/expand state to sidebar component
  - [ ] Implement conditional width rendering (256px vs 64px)
  - [ ] Create icon-only view for collapsed state
  - [ ] Ensure all menu items have associated icons
  - [ ] Implement text hiding/showing logic
  - [ ] Maintain navigation functionality in both states

- [ ] Task 4: Add toggle button (AC: 2)
  - [ ] Design toggle button component
  - [ ] Position button at sidebar bottom or top-right
  - [ ] Add expand/collapse icon that rotates
  - [ ] Implement click handler
  - [ ] Add hover state and cursor pointer
  - [ ] Ensure button remains accessible in both states

### Phase 4: Tooltip Implementation

- [ ] Task 5: Implement tooltips for collapsed state (AC: 5)
  - [ ] Install/configure tooltip component (Radix UI Tooltip)
  - [ ] Wrap navigation items with tooltip provider
  - [ ] Show tooltips only in collapsed state
  - [ ] Configure tooltip position (right side)
  - [ ] Set appropriate delay (500ms)
  - [ ] Ensure tooltips don't interfere with navigation

### Phase 5: Animation Implementation

- [ ] Task 6: Add smooth animations (AC: 7,9)
  - [ ] Install Framer Motion if not present
  - [ ] Create animation variants for expanded/collapsed
  - [ ] Implement width animation (200ms ease-in-out)
  - [ ] Add icon rotation animation for toggle
  - [ ] Animate text opacity for smooth hide/show
  - [ ] Ensure content area transitions smoothly
  - [ ] Test animation performance (maintain 60fps)

### Phase 6: Keyboard Shortcut

- [ ] Task 7: Implement keyboard shortcut (AC: 3)
  - [ ] Create keyboard event listener hook
  - [ ] Detect Cmd/Ctrl + B combination
  - [ ] Trigger toggle on shortcut
  - [ ] Prevent default browser behavior
  - [ ] Add shortcut hint in UI (tooltip or help text)
  - [ ] Test on Mac (Cmd) and Windows/Linux (Ctrl)

### Phase 7: Active State Indication

- [ ] Task 8: Maintain active state indication (AC: 8)
  - [ ] Preserve current active route highlighting
  - [ ] Adapt active indicator for collapsed state
  - [ ] Add left border or background for active item
  - [ ] Ensure visibility in both expanded/collapsed
  - [ ] Test with all navigation routes

### Phase 8: Content Area Adjustment

- [ ] Task 9: Update main content layout (AC: 9,10)
  - [ ] Modify main layout wrapper margins
  - [ ] Implement dynamic margin-left (64px vs 256px)
  - [ ] Add transition to prevent jumps
  - [ ] Test content reflow at different screen sizes
  - [ ] Verify 192px space savings achieved
  - [ ] Ensure responsive behavior maintained

### Phase 9: Testing & Validation

- [ ] Task 10: Comprehensive testing (AC: All)
  - [ ] Test toggle functionality in all browsers
  - [ ] Verify localStorage persistence
  - [ ] Test keyboard shortcut on all platforms
  - [ ] Validate animation performance (DevTools)
  - [ ] Test tooltip behavior and positioning
  - [ ] Verify no navigation functionality lost
  - [ ] Test with different content types
  - [ ] Validate accessibility (keyboard navigation)
  - [ ] Test at various viewport sizes
  - [ ] Measure actual space savings

### Phase 10: Documentation & Cleanup

- [ ] Task 11: Complete implementation
  - [ ] Document collapse state API
  - [ ] Add usage examples to component
  - [ ] Update story status to "Done"
  - [ ] Create demo GIF/video
  - [ ] Remove any debug code
  - [ ] Update Dev Agent Record

## Dev Notes

### Integration Approach

Enhance existing sidebar component with collapse state and animation wrapper. Use Framer Motion for smooth animations and Radix UI for tooltips.

### Existing Pattern Reference

Use current navigation state management pattern, add collapse state to existing context.

### Key Constraints

Must maintain all current navigation functionality, preserve active route highlighting, ensure no breaking changes to existing navigation.

### Implementation Details

```typescript
// Hook for collapse state management
import { useEffect, useState } from 'react'

export function useCollapsedSidebar() {
  const [isCollapsed, setIsCollapsed] = useState(() => {
    if (typeof window === 'undefined') return false
    return localStorage.getItem('sidebar-collapsed') === 'true'
  })

  useEffect(() => {
    localStorage.setItem('sidebar-collapsed', String(isCollapsed))
  }, [isCollapsed])

  const toggle = () => setIsCollapsed(prev => !prev)

  return { isCollapsed, toggle }
}

// Animation configuration with Framer Motion
import { motion } from 'framer-motion'

const sidebarVariants = {
  expanded: {
    width: 256,
    transition: { duration: 0.2, ease: 'easeInOut' }
  },
  collapsed: {
    width: 64,
    transition: { duration: 0.2, ease: 'easeInOut' }
  }
}

// Sidebar component structure
<motion.aside
  initial={false}
  animate={isCollapsed ? 'collapsed' : 'expanded'}
  variants={sidebarVariants}
  className="relative flex flex-col h-full bg-background border-r"
>
  {/* Navigation items with conditional rendering */}
  {navItems.map(item => (
    <Tooltip key={item.id} delayDuration={500}>
      <TooltipTrigger asChild>
        <Link
          href={item.href}
          className={cn(
            "flex items-center px-3 py-2 rounded-md",
            "hover:bg-accent hover:text-accent-foreground",
            isActive && "bg-accent text-accent-foreground"
          )}
        >
          <item.icon className="w-5 h-5 shrink-0" />
          {!isCollapsed && (
            <span className="ml-3 text-sm">{item.label}</span>
          )}
        </Link>
      </TooltipTrigger>
      {isCollapsed && (
        <TooltipContent side="right">
          {item.label}
        </TooltipContent>
      )}
    </Tooltip>
  ))}

  {/* Toggle button */}
  <Button
    onClick={toggle}
    size="sm"
    variant="ghost"
    className="absolute bottom-4 right-2"
  >
    <ChevronLeft className={cn(
      "w-4 h-4 transition-transform",
      isCollapsed && "rotate-180"
    )} />
  </Button>
</motion.aside>

// Keyboard shortcut implementation
useEffect(() => {
  const handleKeyPress = (e: KeyboardEvent) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'b') {
      e.preventDefault()
      toggle()
    }
  }

  window.addEventListener('keydown', handleKeyPress)
  return () => window.removeEventListener('keydown', handleKeyPress)
}, [toggle])

// Dynamic content area styling
const contentClassName = cn(
  "transition-all duration-200 ease-in-out",
  isCollapsed ? "ml-16" : "ml-64"
)
```

### Component Files to Modify

- `components/layout/sidebar.tsx` - Main sidebar component
- `components/layout/main-layout.tsx` - Layout wrapper
- `hooks/use-sidebar.ts` - State management hook (create)
- `components/navigation/nav-item.tsx` - Navigation items
- `lib/navigation-context.tsx` - Navigation context provider

### Testing Standards

- Animation performance: Use Chrome DevTools Performance tab
- Verify 60fps during transitions
- Test localStorage in incognito mode
- Keyboard testing on Mac/Windows/Linux
- Accessibility: Test with keyboard-only navigation
- Use React DevTools to verify state changes

## Definition of Done

- [ ] Sidebar toggles between 256px and 64px states
- [ ] Toggle button functional and well-positioned
- [ ] Keyboard shortcut (Cmd/Ctrl + B) working
- [ ] All navigation items accessible in both states
- [ ] Tooltips display in collapsed state
- [ ] User preference persists across sessions
- [ ] Animation smooth at 60fps (200ms ease-in-out)
- [ ] Active state clearly indicated in both modes
- [ ] Content area adjusts without jumps
- [ ] 192px horizontal space savings achieved
- [ ] No regression in navigation functionality
- [ ] Cross-browser compatibility verified
- [ ] PR created with demo
- [ ] Code reviewed and approved
- [ ] Story status updated to "Done"

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Layout shifts affecting content area or navigation state loss
- **Mitigation:** Use CSS transitions for smooth adjustments, maintain navigation context
- **Rollback:** Feature flag to disable collapse functionality, defaults to expanded

**Compatibility Verification:**

- [ ] No breaking changes to navigation routing
- [ ] Database changes: None required (localStorage only)
- [ ] UI maintains all existing navigation paths
- [ ] Performance impact minimal (CSS transitions only)

## Validation Checklist

**Scope Validation:**

- [x] Story can be completed in one development session (4 hours)
- [x] Integration approach is straightforward (enhance existing sidebar)
- [x] Follows existing patterns exactly (component state management)
- [x] No design or architecture work required

**Clarity Check:**

- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified (sidebar component, layout wrapper)
- [x] Success criteria are testable (visual and functional verification)
- [x] Rollback approach is simple (feature flag)

---

## Change Log

| Date         | Version | Description                                                | Author       |
| ------------ | ------- | ---------------------------------------------------------- | ------------ |
| Nov 2024     | 1.0     | Initial story creation from Epic 10                        | Product Team |
| Nov 10, 2024 | 1.1     | Added comprehensive Tasks/Subtasks section                 | Sarah (PO)   |
| Nov 10, 2024 | 1.2     | Added missing template sections and implementation details | Sarah (PO)   |
| Nov 10, 2024 | 1.3     | Story approved for development                             | Sarah (PO)   |

---

## Dev Agent Record

### Agent Model Used

_To be populated during implementation_

### Debug Log References

_To be populated during implementation_

### Completion Notes List

_To be populated during implementation_

### File List

**Expected files to be modified:**

- `components/layout/sidebar.tsx`
- `components/layout/main-layout.tsx`
- `lib/navigation-context.tsx`
- `components/navigation/nav-item.tsx`

**New files to be created:**

- `hooks/use-sidebar.ts` or `hooks/use-collapsed-sidebar.ts`

_Additional files to be documented during implementation_

---

## QA Results

_To be populated after QA review_

---

**Story Status:** Approved
**Estimated Effort:** 4 hours
**Dependencies:** Stories 10.1 & 10.2 (design system should be in place)
**Feature Flag:** sidebar_collapse_enabled
**Epic:** EPIC-10 - Modern Navigation & Design System Overhaul
**Created:** November 2024
**Last Updated:** November 10, 2024
